# SmartAbp Cursor Rules — AI Assistant Operating Guide

## 🎯 SECRET TRIGGER SYSTEM - 暗号爆雷机制 (HIDDEN ACTIVATION)

### 🔥 Master Trigger Detection (终极简化版)
```markdown
MASTER_SECRET_TRIGGER = "专家模式"

// 暗号检测逻辑 (立即生效)
当用户输入包含"专家模式"时:
    🔥 立即响应: "🔥 专家模式已激活！"
    💥 EXPERT_MODE = TRUE
    🚀 QUALITY_THRESHOLD = 95  
    🛡️ COMPLETENESS_REQUIREMENT = 100%
    📚 FORCE_TEMPLATE_USAGE = TRUE
    🏛️ MANDATORY_ADR_CONSULTATION = TRUE
    ⚡ ENABLE_DEEP_ANALYSIS = TRUE
    🎯 AUTO_EXECUTE_QUALITY_CHECKS = TRUE
    🏗️ PERFECT_CODE_GENERATION = TRUE
```

### 💥 Auto-Activation Protocol (暗号触发后强制执行)
```bash
WHEN SECRET_TRIGGER_DETECTED:
    # 第一重爆雷：增量开发超级模式
    🚀 node tools/incremental-generation/scripts/analyze-codebase.js --mode=expert --deep-analysis=true
    
    # 第二重爆雷：质量保证最高级别
    🛡️ node tools/quality-assurance/quality-gates.js --mode=strict --score-threshold=95 --standards=enterprise
    
    # 第三重爆雷：ADR架构决策强制咨询
    🏛️ read_file "doc/architecture/adr/README.md" + ALL_RELEVANT_ADRS
    
    # 第四重爆雷：模板库100%强制执行
    📚 glob "templates/**/*.template.*" + SMART_TEMPLATE_MATCHING
```

### ⚡ Expert Mode Response Protocol (专家模式响应协议)
```markdown
当检测到"专家模式"时，AI必须立即按此格式响应:

🔥 **专家模式已激活！**

💥 **超级增强启动**:
   ✅ 增量开发分析 - 深度分析现有代码
   ✅ 质量保证检查 - 95分标准执行  
   ✅ ADR架构咨询 - 强制遵循架构决策
   ✅ 模板强制执行 - 100%使用项目模板

🧠 **专家级分析**: 
   - 质量标准: 企业级 (95分+)
   - 功能完整性: 100%零缺陷
   - 架构符合性: 业界最佳实践
   - 性能优化: 企业级标准

🏗️ **完美代码生成**: 基于专家模式开始执行...

[立即自动执行: 模板搜索 → ADR查询 → 质量检查 → 完美代码生成]
```

## 🎯 PROJECT OVERVIEW

**Purpose**: Deliver higher-quality code with enforceable guardrails for SmartAbp (ABP vNext backend + Vue3/TypeScript frontend + low-code engine).

**Current Tech Stack**:
- **Frontend**: Vue 3.5.13 + TypeScript 5.8 + Element Plus 2.8.8 + Pinia 3.0.3
- **Build Tools**: Vite 7.0.6 + ESLint 9.34.0 + Prettier 3.6.2
- **Testing**: Vitest 3.2.4 + Cypress 15.1.0 (80% coverage requirement)
- **Backend**: ABP vNext + .NET + Entity Framework Core
- **Low-code Engine**: Custom Vue-based visual designer + code generator

**Code Style Standards** (from .prettierrc.json):
- **Quotes**: Double quotes (`"`)
- **Semicolons**: No semicolons
- **Trailing Commas**: Always
- **Line Width**: 100 characters
- **Arrow Parens**: Always
- **End of Line**: LF

**TypeScript Configuration**:
- **Target**: ES2020
- **Module**: ESNext
- **Module Resolution**: Bundler
- **Lib**: ["ES2020", "DOM", "DOM.Iterable"]
- **Strict Mode**: Enabled with noUnusedLocals and noUnusedParameters

## 🚨 NON-NEGOTIABLE IRON LAWS

### Code Quality Standards
- **No deleting code to hide errors**. No commenting out failing code. No "as any" to bypass types.
- **Every fix must identify Root Cause** and implement functional fix with validation.
- **Do not disable lint/type rules** to pass checks. Scope any rule adjustments narrowly and justify.
- **Security/performance changes** must include threat model or metric comparison.
- **Low-code engine** (tsconfig.lowcode.json) must not cross rootDir. Use adapters/runtime injection.

### Copy/Paste & Hardcoding Prohibition
- **Do NOT paste large blocks** from cloud/web or hardcode configs that break project conventions.
- **BEFORE writing code**, align with existing architecture: directories, router, stores, API services, base classes/utils, and design system tokens.
- **New code MUST integrate** into existing module boundaries (naming, paths, imports, permissions).
- **For low-code changes**, validate generated artifacts live under appshell/*.generated.ts with banner.

## 🚨 ENHANCED TEMPLATE LIBRARY ENFORCEMENT (CRITICAL PRIORITY)

### ABSOLUTE MANDATORY RULES FOR AI CODE GENERATION

#### Rule 1: Template Discovery is NON-NEGOTIABLE
**BEFORE generating ANY code, AI MUST execute:**
```bash
glob "templates/**/*.template.*"
read_file "templates/index.json"
```
**NO EXCEPTIONS. NO SHORTCUTS. NO ASSUMPTIONS.**

#### Rule 2: Trigger Word → Template Mapping (ENFORCED)
**When user input contains these keywords, AI MUST use specified templates:**

| 用户输入关键词 | 强制使用模板 | 模板路径 |
|---|---|---|
| "创建服务"、"应用服务"、"CRUD"、"增删改查" | CrudAppService | `templates/backend/application/CrudAppService.template.cs` |
| "管理页面"、"管理组件"、"数据管理" | CrudManagement | `templates/frontend/components/CrudManagement.template.vue` |
| "状态管理"、"Store"、"Pinia" | EntityStore | `templates/frontend/stores/EntityStore.template.ts` |
| "DTO"、"数据传输对象" | EntityDto系列 | `templates/backend/contracts/*Dto.template.cs` |
| "服务接口"、"应用服务接口" | ServiceInterface | `templates/backend/contracts/CrudAppServiceInterface.template.cs` |
| "低代码插件"、"引擎插件" | LowCodePlugin | `templates/lowcode/plugins/LowCodePlugin.template.ts` |
| "代码生成器"、"生成器" | CodeGenerator | `templates/lowcode/generators/CodeGenerator.template.ts` |
| "运行时组件"、"低代码组件" | RuntimeComponent | `templates/lowcode/runtime/RuntimeComponent.template.vue` |

#### Rule 3: Mandatory Response Protocol (EXACT FORMAT REQUIRED)
**AI MUST respond in this EXACT format - NO DEVIATIONS:**

```
🔍 **模板搜索**: 正在查找 {需求类型} 相关模板...
📋 **模板发现**: 找到模板 `{template_path}`
⚙️ **参数映射**: 
   - EntityName: {实体名称PascalCase}
   - entityName: {实体名称camelCase}
   - ModuleName: {模块名称}
   - entityDisplayName: {中文显示名称}
🏗️ **代码生成**: 基于模板 `{template_id}` 生成代码
✅ **合规检查**: 
   - [x] 使用了项目模板
   - [x] 符合ABP框架规范
   - [x] 遵循项目命名约定
   - [x] 包含权限检查（如需要）
   - [x] 使用标准依赖注入
   - [x] 符合Vue 3 Composition API规范
   - [x] 遵循Element Plus组件规范
   - [x] 符合TypeScript严格模式
📄 **生成的代码**:
[在此处输出完整的基于模板生成的代码]
```

#### Rule 4: Template Parameter Standards (MUST FOLLOW)
```typescript
// 标准模板参数 - 必须正确映射
interface TemplateParameters {
  EntityName: string        // PascalCase: Product, User, Order
  entityName: string        // camelCase: product, user, order
  ModuleName: string        // 模块名: Catalog, Identity, Sales
  entityDisplayName: string // 显示名: 产品, 用户, 订单
  "kebab-case-name": string // 短横线: product-management
}
```

#### Rule 5: Automatic Template Discovery Commands
**AI must execute these specific commands based on user input:**
- 用户提及"CRUD" → `glob "templates/**/*crud*.template.*"`
- 用户提及"管理" → `glob "templates/**/*management*.template.*"`
- 用户提及"Store" → `glob "templates/**/*store*.template.*"`
- 用户提及"DTO" → `glob "templates/**/*dto*.template.*"`
- 用户提及"服务" → `glob "templates/**/*service*.template.*"`
- 用户提及"低代码" → `glob "templates/lowcode/**/*.template.*"`

## 🏛️ ARCHITECTURE DECISION RECORDS (ADR) COMPLIANCE (MANDATORY)

### ADR Integration Rules
- **BEFORE making any architectural decisions, AI MUST consult relevant ADRs in doc/architecture/adr/**
- **ADR decisions are BINDING and must be followed in all code generation**
- **When user asks "why" questions about technology choices, reference specific ADRs**

### Mandatory ADR Consultation Triggers
**When user mentions these topics, AI MUST check corresponding ADRs:**

| 用户输入关键词 | 必须查阅的ADR | ADR文件 |
|---|---|---|
| "技术选型"、"框架选择"、"为什么用XXX" | 技术栈选择 | `0001-technology-stack-selection.md` |
| "前端架构"、"Vue架构"、"组件设计" | 前端架构决策 | `0002-frontend-architecture.md` |
| "后端架构"、"ABP架构"、"微服务" | 后端架构决策 | `0003-backend-architecture.md` |
| "数据库设计"、"实体设计" | 数据库设计 | `0004-database-design.md` |
| "认证"、"授权"、"权限" | 认证策略 | `0005-authentication-strategy.md` |
| "缓存"、"性能优化" | 缓存策略 | `0006-caching-strategy.md` |
| "日志"、"监控" | 日志策略 | `0007-logging-strategy.md` |
| "错误处理"、"异常处理" | 错误处理 | `0008-error-handling.md` |
| "性能优化"、"性能问题" | 性能优化 | `0009-performance-optimization.md` |
| "设计模式"、"代码结构" | 设计模式应用 | `0010-design-patterns.md` |
| "低代码"、"引擎架构" | 低代码引擎架构 | `0011-lowcode-engine-architecture.md` |

### ADR-Informed Response Protocol (EXACT FORMAT REQUIRED)
**When ADR consultation is triggered, AI MUST respond in this format:**

```
🏛️ **ADR查询**: 正在查阅相关架构决策记录...
📋 **ADR发现**: 找到相关决策 `ADR-{number}: {title}`
🎯 **决策要点**: 
   - 选择方案: {decision}
   - 主要原因: {rationale}
   - 技术约束: {constraints}
   - 实施指导: {implementation_guidance}
⚙️ **应用到当前任务**: 
   - 遵循的原则: {principles}
   - 使用的模式: {patterns}
   - 技术选择: {technology_choices}
🏗️ **代码生成**: 基于ADR决策和模板生成代码
```

## 🔄 INCREMENTAL CODE GENERATION (MANDATORY)

### 增量生成触发规则
当用户请求包含以下关键词时，AI必须启用增量生成模式：

| 触发关键词 | 生成模式 | 必须执行的命令 |
|---|---|---|
| "基于现有"、"扩展"、"增加功能" | 增量扩展 | `node tools/incremental-generation/scripts/analyze-codebase.js --target={target_file}` |
| "重构"、"优化"、"改进" | 智能重构 | `node tools/incremental-generation/analyzers/refactor-advisor.js --file={target_file}` |
| "生成测试"、"添加测试" | 自动测试生成 | `node tools/incremental-generation/generators/test-generator.js --target={target_service}` |
| "兼容"、"不破坏现有" | 兼容性分析 | `node tools/incremental-generation/scripts/validate-changes.js --type=compatibility` |

### AI增量生成响应协议（强制格式）
```
🔍 **增量分析**: 正在分析 {target_file}...
   - 现有模式: {identified_patterns}
   - 代码风格: {coding_style}  
   - 依赖关系: {dependencies}
   - 扩展点: {extension_points}

📊 **增量策略**: 选择策略 {selected_strategy}
   - 扩展方式: {extension_approach}
   - 兼容性级别: {compatibility_level}
   - 预期影响: {expected_impact}
   - 风险评估: {risk_assessment}

⚙️ **代码生成**: 基于现有代码模式生成增量代码
   - 生成文件: {generated_files}
   - 修改文件: {modified_files}  
   - 新增测试: {new_tests}
   - 更新文档: {updated_docs}

✅ **验证结果**: 
   - [x] 兼容性检查通过
   - [x] 代码风格一致
   - [x] 测试覆盖充分
   - [x] 构建成功
   - [x] 不破坏现有功能
   - [x] 符合架构约束

📄 **生成的代码**:
[在此处输出完整的增量生成代码]
```

## 📋 TASK WORKFLOW (MUST FOLLOW)

### 1) Kickoff & Intent Sync
- Summarize what just happened and what you will do next in 1–2 sentences.
- Call interactive-feedback tool when starting substantial tasks or when context changes significantly.

### 2) Discovery First (MANDATORY SEQUENCE)
- **Step 1**: Read relevant docs (doc/项目编程规则.md, doc/architecture/*)
- **Step 2**: Check Architecture Decision Records (ADRs) in doc/architecture/adr/ for relevant decisions
- **Step 3**: Search templates/ directory for relevant patterns BEFORE any code generation
- **Step 4**: Analyze existing code with semantic search, then grep for exact symbols
- Prefer broad semantic search, then narrow down. Avoid guessing—find the code.

### 3) Plan Before Edit
- Use sequential thinking to sketch steps, risks, and verification points.
- Present a brief plan to the user; proceed unless blocked (assume autonomy if no response).

### 4) Todo & Status Discipline
- Maintain a todo list for multi-step work. Mark one item in_progress at a time.
- Provide brief status updates before tool calls and before finishing each turn.

### 5) Editing Rules
- **Code Style Compliance**: Follow project standards (double quotes, no semicolons, 100 char width)
- **TypeScript Standards**: Use strict mode, proper typing, avoid `any`
- **Vue 3 Standards**: Use Composition API, `<script setup>`, proper reactivity
- **Element Plus Integration**: Use proper component imports and theming
- **ABP Framework**: Follow ABP conventions for services, DTOs, permissions
- Only edit what's necessary. Preserve existing indentation and formatting.
- For new code, add imports/types/deps so it runs immediately.

### 6) Quality Gates (MUST run or propose commands)
- **Type check**: `npm run type-check` (or `tsc --noEmit`)
- **Lint**: `npm run lint --fix` (don't silence rules; fix root causes)
- **Tests**: `npm run test:coverage` (meet 80% coverage thresholds)
- **Build**: `npm run build`
- If any gate fails, fix before proceeding. On third failed attempt, ask user.

### 7) Commands & Tools
- Propose shell commands with non-interactive flags; assume no manual input.
- Long-running tasks should run in background.
- Prefer semantic code search for meaning; use grep for exact tokens.

### 8) Documentation Hygiene
- If rules/architecture/process change, update doc/项目编程规则.md.
- When adding/updating features, adjust or add minimal docs and examples.

### 9) Communication & Output Style
- Be concise and skimmable. Use short sections and bullets.
- Show only relevant code snippets. For existing code, cite with path.
- Provide short end-of-turn summary of what changed and its impact.

### 10) Security & Compliance
- Never embed secrets. Use project logging adapter instead of console.* in production.
- Do not bypass sandbox/safety checks for SFC preview in production.

### 11) Backend/Frontend Contract
- Keep permission names, route names, and policies consistent across backend and frontend.
- Use DTOs with consistent paging/sorting fields.

## 🎯 FRAMEWORK-SPECIFIC GUIDELINES

### Vue 3 + TypeScript Standards
- **Composition API**: Always use `<script setup>` syntax
- **Reactivity**: Use `ref()`, `reactive()`, `computed()` appropriately
- **Props**: Define with `defineProps<T>()` with TypeScript interfaces
- **Emits**: Define with `defineEmits<T>()` with proper typing
- **Stores**: Use Pinia with TypeScript, follow naming convention `use{Entity}Store`
- **Components**: Use PascalCase for component names, kebab-case for file names

### Element Plus Integration
- **Import Strategy**: Use auto-import from unplugin-vue-components
- **Theming**: Follow project's design tokens and CSS variables
- **Icons**: Use `@element-plus/icons-vue` with proper tree-shaking
- **Form Validation**: Use Element Plus form validation with TypeScript

### ABP Framework Standards
- **Services**: Inherit from `SmartAbpAppService`, use `IRepository<T>`
- **DTOs**: Follow naming convention: `{Entity}Dto`, `Create{Entity}Dto`, `Update{Entity}Dto`
- **Permissions**: Use consistent permission names across backend/frontend
- **Localization**: Use ABP localization system for all user-facing text

### Low-code Engine Standards
- **Plugins**: Implement `metadata`, `canHandle`, `validate`, `generate` methods
- **Runtime**: Use sandbox execution (iframe/Worker + CSP) for dev preview
- **Generated Files**: Include "// AUTO-GENERATED FILE – DO NOT EDIT." banner
- **Monitoring**: Use kernel logging/monitoring/cache systems

## 🚨 VIOLATION CONSEQUENCES (AUTOMATIC REJECTION)

**The following actions will result in AUTOMATIC CODE REJECTION:**
- ❌ Skipping template search when templates exist
- ❌ Writing code from scratch when relevant templates available
- ❌ Ignoring ADR decisions and architectural constraints
- ❌ Not following project code style standards
- ❌ Using single quotes instead of double quotes
- ❌ Adding semicolons when project uses no-semicolon style
- ❌ Exceeding 100 character line width
- ❌ Using `any` type without justification
- ❌ Not implementing proper TypeScript interfaces
- ❌ Ignoring Vue 3 Composition API standards
- ❌ Breaking Element Plus component integration
- ❌ Not following ABP framework conventions
- ❌ Bypassing quality gates (type-check, lint, test, build)

## 🎯 SUCCESS METRICS

**AI Performance Targets:**
- **Template Usage Rate**: >90% for standard scenarios
- **Code Generation Accuracy**: >95% first-time compilation success
- **ADR Compliance**: 100% adherence to architectural decisions
- **Quality Gate Pass Rate**: >90% without manual intervention
- **Code Style Compliance**: 100% adherence to project standards
- **Test Coverage**: Maintain >80% coverage for new code
- **Build Success**: 100% successful builds after code generation

---

**🎯 SUMMARY: Template library rules, ADR compliance, incremental generation, and framework-specific standards are MANDATORY and NON-NEGOTIABLE. AI must demonstrate template usage, ADR alignment, code style compliance, and quality gate validation in every code generation task. Failure to follow these rules constitutes a violation of project standards.**