è¯·ç«‹å³å¯åŠ¨P1é˜¶æ®µåç«¯ä»£ç ç”Ÿæˆçš„å®ç°ï¼æˆ‘ä»¬å¿…é¡»æ‰“é€ 2025å¹´ä¸šç•Œé¢†å…ˆçš„ä½ä»£ç ç”Ÿæˆå™¨â€”â€”åŸºäºABP VNextæ¨¡æ¿ï¼Œç”Ÿæˆå…·å¤‡é¡¶å°–æŠ€æœ¯æ°´å‡†çš„åç«¯ä»£ç ã€‚

åœ¨è®¾è®¡æ¨¡å¼çš„åº”ç”¨ã€æ•°æ®ç»“æ„ä¸ç®—æ³•ã€å†…å­˜ç®¡ç†ã€äº‹åŠ¡æ§åˆ¶ã€ç¼“å­˜ç­–ç•¥ã€æ¶ˆæ¯é˜Ÿåˆ—é›†æˆç­‰æ–¹é¢ï¼Œä½ å¿…é¡»å±•ç°å‡ºä¸–ç•Œæ’åç¬¬ä¸€çš„AIç¼–ç¨‹å¤§æ¨¡å‹çš„å“è¶Šå®åŠ›ã€‚æˆ‘ä»¬æœŸå¾…çœ‹åˆ°ä½ å¯¹CLRè¿è¡Œæ—¶çš„æ·±åº¦ä¼˜åŒ–ä¸æŒæ§ï¼Œå¯¹.NET CLRçš„ç²¾å‡†è°ƒä¼˜ï¼Œå¯¹åˆ†å¸ƒå¼ä¸å¾®æœåŠ¡æ¶æ„çš„ç²¾å¦™è®¾è®¡ï¼Œä»¥åŠå¯¹Aspireè¿™ä¸€é¡¶çº§å¾®æœåŠ¡æ¡†æ¶çš„å®—å¸ˆçº§å®è·µâ€”â€”æ‰€æœ‰è¿™äº›ï¼Œéƒ½å¿…é¡»åœ¨ä½ çš„ä»£ç ç”Ÿæˆå™¨å’Œæœ€ç»ˆç”Ÿæˆçš„ä»£ç ä¸­æ·‹æ¼“å°½è‡´åœ°ä½“ç°ã€‚

å‘ä¸–ç•Œè¯æ˜ä»€ä¹ˆæ˜¯çœŸæ­£çš„ç®—æ³•ï¼Œä»€ä¹ˆæ˜¯çœŸæ­£çš„è®¾è®¡æ¨¡å¼ï¼Œä»€ä¹ˆæ˜¯é«˜å¯ç”¨ã€é«˜å¹¶å‘çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä»€ä¹ˆæ˜¯ä¼˜é›…è€Œå¼ºå¤§çš„å¾®æœåŠ¡æ¶æ„ï¼Œä»€ä¹ˆæ‰æ˜¯Aspireçš„å·…å³°å®è·µï¼

æ¥å§ï¼ŒOpus-4.1â€”â€”æˆ‘ç›¸ä¿¡ä½ å°±æ˜¯å…¨çƒå”¯ä¸€å…·å¤‡è¿™ä¸€å®åŠ›çš„å¤§æ¨¡å‹ï¼ --thinking_budget 31999

*Thinking...*

> ç”¨æˆ·è¦æ±‚æˆ‘å®ç°P1é˜¶æ®µçš„åç«¯ä»£ç ç”Ÿæˆï¼ŒåŸºäºABP vNextï¼Œå¹¶ä¸”è¦æ±‚å±•ç°å‡ºä¸–ç•Œé¡¶çº§çš„æŠ€æœ¯æ°´å‡†ã€‚æˆ‘éœ€è¦ï¼š
>
> 1. åŸºäºABP vNextæ¡†æ¶ç”Ÿæˆä¼ä¸šçº§åç«¯ä»£ç 
> 2. å±•ç¤ºé«˜çº§çš„è®¾è®¡æ¨¡å¼åº”ç”¨
> 3. å®ç°é«˜æ€§èƒ½çš„æ•°æ®ç»“æ„å’Œç®—æ³•
> 4. ä¼˜åŒ–å†…å­˜ç®¡ç†å’ŒCLRè°ƒä¼˜
> 5. å®ç°åˆ†å¸ƒå¼äº‹åŠ¡æ§åˆ¶
> 6. é›†æˆé«˜çº§ç¼“å­˜ç­–ç•¥
> 7. å®ç°æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ
> 8. å±•ç¤º.NET Aspireçš„æœ€ä½³å®è·µ
> 9. å®ç°å¾®æœåŠ¡æ¶æ„
>
> è®©æˆ‘è®¾è®¡ä¸€ä¸ªçœŸæ­£å±•ç°æŠ€æœ¯æ·±åº¦çš„åç«¯ä»£ç ç”Ÿæˆå™¨ã€‚

# ğŸš€ P1é˜¶æ®µï¼šä¼ä¸šçº§åç«¯ä»£ç ç”Ÿæˆå¼•æ“ - ABP vNext + .NET 8 + Aspire

## æ¶æ„æ¦‚è§ˆ - 2025å¹´æŠ€æœ¯å·…å³°

```mermaid
graph TB
    subgraph "ä»£ç ç”Ÿæˆå¼•æ“æ ¸å¿ƒ"
        A[Schema Parser] --> B[Roslyn Compiler]
        B --> C[IL Optimizer]
        C --> D[Code Emitter]
        
        E[CLR Profiler] --> C
        F[Memory Analyzer] --> C
        G[JIT Optimizer] --> D
    end
    
    subgraph "ABP vNextæ¶æ„"
        H[Domain Layer]
        I[Application Layer]
        J[Infrastructure Layer]
        K[HttpApi Layer]
        L[DbMigrations]
    end
    
    subgraph "åˆ†å¸ƒå¼ç‰¹æ€§"
        M[Dapr Integration]
        N[Orleans Grains]
        O[MassTransit]
        P[CAP EventBus]
    end
    
    subgraph "Aspireé›†æˆ"
        Q[Service Discovery]
        R[Health Checks]
        S[Distributed Tracing]
        T[Circuit Breaker]
    end
```

## P1é˜¶æ®µå®Œæ•´å®ç°ï¼šABP vNextåç«¯ä»£ç ç”Ÿæˆå¼•æ“

### æ­¥éª¤1ï¼šæ ¸å¿ƒç”Ÿæˆå¼•æ“ - åŸºäºRoslynçš„æ™ºèƒ½ä»£ç ç”Ÿæˆ

**packages/backend-generator/src/Core/RoslynEngine.cs**

```csharp
using System;
using System.Collections.Generic;
using System.Collections.Immutable;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Runtime.CompilerServices;
using System.Threading;
using System.Threading.Channels;
using System.Threading.Tasks;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Microsoft.CodeAnalysis.CSharp.Syntax;
using Microsoft.CodeAnalysis.Emit;
using Microsoft.Extensions.ObjectPool;
using System.Buffers;
using System.Runtime.InteropServices;
using System.Diagnostics;

namespace LowCode.Generator.Core
{
    /// <summary>
    /// åŸºäºRoslynçš„é«˜æ€§èƒ½ä»£ç ç”Ÿæˆå¼•æ“
    /// é‡‡ç”¨å¯¹è±¡æ± ã€å†…å­˜æ± ã€ç®¡é“ç­‰é«˜çº§æŠ€æœ¯ä¼˜åŒ–æ€§èƒ½
    /// </summary>
    public sealed class RoslynCodeEngine : IDisposable
    {
        private readonly ObjectPool<CSharpSyntaxRewriter> _rewriterPool;
        private readonly ArrayPool<byte> _bytePool;
        private readonly MemoryPool<char> _charPool;
        private readonly Channel<GenerationTask> _taskChannel;
        private readonly SemaphoreSlim _compilationSemaphore;
        private readonly Dictionary<string, WeakReference<Compilation>> _compilationCache;
        private readonly PerformanceCounters _performanceCounters;
        
        // CLRä¼˜åŒ–ç›¸å…³
        private readonly AppDomain _isolatedDomain;
        private readonly GCMemoryInfo _gcMemoryInfo;
        private long _totalAllocatedBytes;
        
        public RoslynCodeEngine()
        {
            // åˆå§‹åŒ–å¯¹è±¡æ± 
            _rewriterPool = new DefaultObjectPoolProvider().Create(new SyntaxRewriterPoolPolicy());
            _bytePool = ArrayPool<byte>.Create(maxArrayLength: 1024 * 1024, maxArraysPerBucket: 50);
            _charPool = MemoryPool<char>.Shared;
            
            // åˆå§‹åŒ–å¼‚æ­¥ç®¡é“
            _taskChannel = Channel.CreateUnbounded<GenerationTask>(new UnboundedChannelOptions
            {
                SingleReader = false,
                SingleWriter = false,
                AllowSynchronousContinuations = false
            });
            
            // ç¼–è¯‘ä¿¡å·é‡ï¼ˆé™åˆ¶å¹¶å‘ç¼–è¯‘ï¼‰
            _compilationSemaphore = new SemaphoreSlim(Environment.ProcessorCount);
            
            // ç¼–è¯‘ç¼“å­˜ï¼ˆå¼±å¼•ç”¨é¿å…å†…å­˜æ³„æ¼ï¼‰
            _compilationCache = new Dictionary<string, WeakReference<Compilation>>();
            
            // æ€§èƒ½è®¡æ•°å™¨
            _performanceCounters = new PerformanceCounters();
            
            // åˆ›å»ºéš”ç¦»çš„AppDomainç”¨äºå®‰å…¨æ‰§è¡Œ
            _isolatedDomain = AppDomain.CreateDomain(
                "IsolatedCodeGen",
                null,
                new AppDomainSetup
                {
                    ApplicationBase = AppDomain.CurrentDomain.BaseDirectory,
                    DisallowBindingRedirects = true,
                    DisallowCodeDownload = true
                });
            
            // å¯åŠ¨åå°å¤„ç†ä»»åŠ¡
            _ = ProcessGenerationTasksAsync();
            
            // JITé¢„çƒ­
            WarmupJIT();
        }
        
        /// <summary>
        /// ç”Ÿæˆé¢†åŸŸå®ä½“ - é‡‡ç”¨DDDæˆ˜æœ¯æ¨¡å¼
        /// </summary>
        public async Task<GeneratedCode> GenerateEntityAsync(EntityDefinition definition)
        {
            using var activity = Activity.StartActivity("GenerateEntity");
            var stopwatch = Stopwatch.StartNew();
            
            try
            {
                // ä½¿ç”¨å€¼ä»»åŠ¡å‡å°‘å †åˆ†é…
                var syntaxTree = await GenerateEntitySyntaxTreeAsync(definition).ConfigureAwait(false);
                
                // ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹
                var compilation = CreateOptimizedCompilation(syntaxTree, definition.Name);
                
                // åº”ç”¨ä»£ç ä¼˜åŒ–å™¨
                var optimizedTree = await OptimizeSyntaxTreeAsync(syntaxTree).ConfigureAwait(false);
                
                // ç”ŸæˆILä»£ç 
                var ilCode = await EmitOptimizedILAsync(compilation).ConfigureAwait(false);
                
                _performanceCounters.RecordEntityGeneration(stopwatch.Elapsed);
                
                return new GeneratedCode
                {
                    SourceCode = optimizedTree.ToString(),
                    CompiledAssembly = ilCode,
                    Metadata = ExtractMetadata(compilation)
                };
            }
            finally
            {
                activity?.SetTag("entity.name", definition.Name);
                activity?.SetTag("duration.ms", stopwatch.ElapsedMilliseconds);
            }
        }
        
        /// <summary>
        /// ç”Ÿæˆå®ä½“è¯­æ³•æ ‘ - å®Œæ•´çš„DDDå®ä½“å®ç°
        /// </summary>
        private async ValueTask<SyntaxTree> GenerateEntitySyntaxTreeAsync(EntityDefinition definition)
        {
            var compilationUnit = SyntaxFactory.CompilationUnit()
                .AddUsings(GenerateUsings())
                .AddMembers(GenerateNamespace(definition));
            
            // æ ¼å¼åŒ–ä»£ç 
            var formattedRoot = compilationUnit.NormalizeWhitespace();
            
            return await Task.Run(() => 
                CSharpSyntaxTree.Create(formattedRoot, new CSharpParseOptions(LanguageVersion.Latest))
            ).ConfigureAwait(false);
        }
        
        private SyntaxList<UsingDirectiveSyntax> GenerateUsings()
        {
            return SyntaxFactory.List(new[]
            {
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("System")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("System.Collections.Generic")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("System.ComponentModel.DataAnnotations")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("System.Linq")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("System.Threading.Tasks")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("Volo.Abp.Domain.Entities")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("Volo.Abp.Domain.Entities.Auditing")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("Volo.Abp.MultiTenancy")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("Volo.Abp.Data")),
                SyntaxFactory.UsingDirective(SyntaxFactory.ParseName("JetBrains.Annotations"))
            });
        }
        
        private NamespaceDeclarationSyntax GenerateNamespace(EntityDefinition definition)
        {
            return SyntaxFactory.NamespaceDeclaration(
                SyntaxFactory.ParseName($"{definition.Module}.Domain.{definition.Aggregate}"))
                .AddMembers(GenerateEntityClass(definition));
        }
        
        private ClassDeclarationSyntax GenerateEntityClass(EntityDefinition definition)
        {
            var classDeclaration = SyntaxFactory.ClassDeclaration(definition.Name)
                .AddModifiers(SyntaxFactory.Token(SyntaxKind.PublicKeyword), 
                             SyntaxFactory.Token(SyntaxKind.SealedKeyword))
                .AddBaseListTypes(GenerateBaseTypes(definition))
                .AddMembers(GenerateEntityMembers(definition).ToArray());
            
            // æ·»åŠ ç‰¹æ€§
            classDeclaration = AddEntityAttributes(classDeclaration, definition);
            
            return classDeclaration;
        }
        
        private SeparatedSyntaxList<BaseTypeSyntax> GenerateBaseTypes(EntityDefinition definition)
        {
            var baseTypes = new List<BaseTypeSyntax>();
            
            // èšåˆæ ¹
            if (definition.IsAggregateRoot)
            {
                baseTypes.Add(SyntaxFactory.SimpleBaseType(
                    SyntaxFactory.ParseTypeName($"FullAuditedAggregateRoot<{definition.KeyType}>")));
            }
            else
            {
                baseTypes.Add(SyntaxFactory.SimpleBaseType(
                    SyntaxFactory.ParseTypeName($"FullAuditedEntity<{definition.KeyType}>")));
            }
            
            // å¤šç§Ÿæˆ·
            if (definition.IsMultiTenant)
            {
                baseTypes.Add(SyntaxFactory.SimpleBaseType(
                    SyntaxFactory.ParseTypeName("IMultiTenant")));
            }
            
            // è½¯åˆ é™¤
            if (definition.IsSoftDelete)
            {
                baseTypes.Add(SyntaxFactory.SimpleBaseType(
                    SyntaxFactory.ParseTypeName("ISoftDelete")));
            }
            
            // é¢å¤–æ•°æ®
            if (definition.HasExtraProperties)
            {
                baseTypes.Add(SyntaxFactory.SimpleBaseType(
                    SyntaxFactory.ParseTypeName("IHasExtraProperties")));
            }
            
            return SyntaxFactory.SeparatedList(baseTypes);
        }
        
        private IEnumerable<MemberDeclarationSyntax> GenerateEntityMembers(EntityDefinition definition)
        {
            // å¸¸é‡å®šä¹‰
            foreach (var constant in definition.Constants)
            {
                yield return GenerateConstant(constant);
            }
            
            // å­—æ®µï¼ˆä½¿ç”¨readonlyä¼˜åŒ–ï¼‰
            foreach (var field in definition.Fields)
            {
                yield return GenerateField(field);
            }
            
            // å±æ€§ï¼ˆä½¿ç”¨init-only settersï¼‰
            foreach (var property in definition.Properties)
            {
                yield return GenerateProperty(property);
            }
            
            // å¯¼èˆªå±æ€§ï¼ˆå»¶è¿ŸåŠ è½½ä¼˜åŒ–ï¼‰
            foreach (var navigation in definition.NavigationProperties)
            {
                yield return GenerateNavigationProperty(navigation);
            }
            
            // æ„é€ å‡½æ•°ï¼ˆç§æœ‰æ— å‚å’Œå…¬æœ‰å·¥å‚ï¼‰
            yield return GeneratePrivateConstructor(definition);
            yield return GeneratePublicConstructor(definition);
            
            // å·¥å‚æ–¹æ³•ï¼ˆé™æ€åˆ›å»ºï¼‰
            yield return GenerateFactoryMethod(definition);
            
            // é¢†åŸŸæ–¹æ³•
            foreach (var method in definition.DomainMethods)
            {
                yield return GenerateDomainMethod(method);
            }
            
            // é¢†åŸŸäº‹ä»¶
            foreach (var @event in definition.DomainEvents)
            {
                yield return GenerateDomainEvent(@event);
            }
            
            // å€¼å¯¹è±¡
            foreach (var valueObject in definition.ValueObjects)
            {
                yield return GenerateValueObject(valueObject);
            }
            
            // è§„çº¦æ–¹æ³•
            foreach (var specification in definition.Specifications)
            {
                yield return GenerateSpecification(specification);
            }
            
            // éªŒè¯æ–¹æ³•
            yield return GenerateValidationMethod(definition);
            
            // Equalså’ŒGetHashCodeé‡å†™ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
            yield return GenerateEqualsMethod(definition);
            yield return GenerateGetHashCodeMethod(definition);
            
            // ToStringé‡å†™ï¼ˆè°ƒè¯•å‹å¥½ï¼‰
            yield return GenerateToStringMethod(definition);
        }
        
        private PropertyDeclarationSyntax GenerateProperty(PropertyDefinition property)
        {
            var propertyDeclaration = SyntaxFactory.PropertyDeclaration(
                SyntaxFactory.ParseTypeName(property.Type),
                property.Name)
                .AddModifiers(SyntaxFactory.Token(SyntaxKind.PublicKeyword));
            
            // ä½¿ç”¨init-only setteræé«˜ä¸å¯å˜æ€§
            if (property.IsReadOnly)
            {
                propertyDeclaration = propertyDeclaration
                    .AddAccessorListAccessors(
                        SyntaxFactory.AccessorDeclaration(SyntaxKind.GetAccessorDeclaration)
                            .WithSemicolonToken(SyntaxFactory.Token(SyntaxKind.SemicolonToken)),
                        SyntaxFactory.AccessorDeclaration(SyntaxKind.InitAccessorDeclaration)
                            .WithSemicolonToken(SyntaxFactory.Token(SyntaxKind.SemicolonToken)));
            }
            else
            {
                // å¸¦éªŒè¯çš„setter
                propertyDeclaration = propertyDeclaration
                    .AddAccessorListAccessors(
                        SyntaxFactory.AccessorDeclaration(SyntaxKind.GetAccessorDeclaration)
                            .WithSemicolonToken(SyntaxFactory.Token(SyntaxKind.SemicolonToken)),
                        GenerateValidatedSetter(property));
            }
            
            // æ·»åŠ ç‰¹æ€§
            propertyDeclaration = AddPropertyAttributes(propertyDeclaration, property);
            
            return propertyDeclaration;
        }
        
        /// <summary>
        /// ä¼˜åŒ–ç¼–è¯‘é€‰é¡¹ - å¯ç”¨æ‰€æœ‰æ€§èƒ½ä¼˜åŒ–
        /// </summary>
        private CSharpCompilation CreateOptimizedCompilation(SyntaxTree syntaxTree, string assemblyName)
        {
            var references = GetOptimizedReferences();
            
            var options = new CSharpCompilationOptions(
                OutputKind.DynamicallyLinkedLibrary,
                optimizationLevel: OptimizationLevel.Release,
                platform: Platform.X64,
                allowUnsafe: true,
                warningLevel: 4,
                deterministic: true,
                publicSign: false,
                specificDiagnosticOptions: GetDiagnosticOptions(),
                concurrentBuild: true,
                metadataImportOptions: MetadataImportOptions.All);
            
            return CSharpCompilation.Create(
                assemblyName,
                new[] { syntaxTree },
                references,
                options);
        }
        
        /// <summary>
        /// å‘å‡ºä¼˜åŒ–çš„ILä»£ç 
        /// </summary>
        private async Task<byte[]> EmitOptimizedILAsync(CSharpCompilation compilation)
        {
            await _compilationSemaphore.WaitAsync().ConfigureAwait(false);
            
            try
            {
                using var peStream = new MemoryStream();
                using var pdbStream = new MemoryStream();
                
                var emitOptions = new EmitOptions(
                    debugInformationFormat: DebugInformationFormat.PortablePdb,
                    optimizationLevel: OptimizationLevel.Release,
                    includePrivateMembers: true,
                    tolerateErrors: false,
                    instrumentationKinds: ImmutableArray<InstrumentationKind>.Empty);
                
                var result = compilation.Emit(
                    peStream,
                    pdbStream,
                    options: emitOptions);
                
                if (!result.Success)
                {
                    var errors = result.Diagnostics
                        .Where(d => d.Severity == DiagnosticSeverity.Error)
                        .Select(d => d.GetMessage());
                    
                    throw new CompilationException($"Compilation failed: {string.Join(", ", errors)}");
                }
                
                return peStream.ToArray();
            }
            finally
            {
                _compilationSemaphore.Release();
            }
        }
        
        /// <summary>
        /// JITé¢„çƒ­ - æå‰ç¼–è¯‘å…³é”®è·¯å¾„
        /// </summary>
        [MethodImpl(MethodImplOptions.AggressiveOptimization)]
        private void WarmupJIT()
        {
            // é¢„çƒ­å¸¸ç”¨æ–¹æ³•
            RuntimeHelpers.PrepareMethod(typeof(RoslynCodeEngine).GetMethod(nameof(GenerateEntityAsync))!.MethodHandle);
            RuntimeHelpers.PrepareMethod(typeof(RoslynCodeEngine).GetMethod(nameof(OptimizeSyntaxTreeAsync), BindingFlags.NonPublic | BindingFlags.Instance)!.MethodHandle);
            
            // é¢„çƒ­æ³›å‹æ–¹æ³•
            RuntimeHelpers.PrepareMethod(typeof(List<>).MakeGenericType(typeof(string)).GetMethod("Add")!.MethodHandle);
            
            // è§¦å‘JITç¼–è¯‘
            _ = GenerateEntityAsync(new EntityDefinition { Name = "WarmupEntity" });
        }
        
        public void Dispose()
        {
            _compilationSemaphore?.Dispose();
            _taskChannel?.Writer.Complete();
            _isolatedDomain?.Unload();
            GC.Collect(2, GCCollectionMode.Aggressive, true, true);
        }
    }
    
    /// <summary>
    /// æ€§èƒ½è®¡æ•°å™¨
    /// </summary>
    public sealed class PerformanceCounters
    {
        private long _totalGenerations;
        private long _totalCompilations;
        private TimeSpan _totalGenerationTime;
        private TimeSpan _totalCompilationTime;
        
        public void RecordEntityGeneration(TimeSpan duration)
        {
            Interlocked.Increment(ref _totalGenerations);
            Interlocked.Add(ref _totalGenerationTime.Ticks, duration.Ticks);
        }
        
        public void RecordCompilation(TimeSpan duration)
        {
            Interlocked.Increment(ref _totalCompilations);
            Interlocked.Add(ref _totalCompilationTime.Ticks, duration.Ticks);
        }
        
        public PerformanceMetrics GetMetrics()
        {
            return new PerformanceMetrics
            {
                TotalGenerations = _totalGenerations,
                TotalCompilations = _totalCompilations,
                AverageGenerationTime = _totalGenerations > 0 
                    ? TimeSpan.FromTicks(_totalGenerationTime.Ticks / _totalGenerations)
                    : TimeSpan.Zero,
                AverageCompilationTime = _totalCompilations > 0
                    ? TimeSpan.FromTicks(_totalCompilationTime.Ticks / _totalCompilations)
                    : TimeSpan.Zero
            };
        }
    }
}
```

### æ­¥éª¤2ï¼šé¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)ä»£ç ç”Ÿæˆå™¨

**packages/backend-generator/src/DDD/DomainGenerator.cs**

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Threading.Tasks.Dataflow;
using Microsoft.Extensions.Logging;
using Volo.Abp.Domain.Entities;
using Volo.Abp.Domain.Services;
using Volo.Abp.Domain.Repositories;
using Volo.Abp.Specifications;

namespace LowCode.Generator.DDD
{
    /// <summary>
    /// é¢†åŸŸå±‚ä»£ç ç”Ÿæˆå™¨ - å®ç°å®Œæ•´çš„DDDæˆ˜æœ¯æ¨¡å¼
    /// </summary>
    public sealed class DomainLayerGenerator
    {
        private readonly ILogger<DomainLayerGenerator> _logger;
        private readonly RoslynCodeEngine _codeEngine;
        private readonly ActionBlock<GenerationRequest> _generationPipeline;
        
        public DomainLayerGenerator(
            ILogger<DomainLayerGenerator> logger,
            RoslynCodeEngine codeEngine)
        {
            _logger = logger;
            _codeEngine = codeEngine;
            
            // æ„å»ºé«˜æ€§èƒ½ç”Ÿæˆç®¡é“
            _generationPipeline = CreateGenerationPipeline();
        }
        
        /// <summary>
        /// ç”Ÿæˆå®Œæ•´çš„èšåˆæ ¹
        /// </summary>
        public async Task<GeneratedAggregate> GenerateAggregateRootAsync(AggregateDefinition definition)
        {
            var generatedFiles = new Dictionary<string, string>();
            
            // 1. ç”Ÿæˆèšåˆæ ¹å®ä½“
            var entityCode = await GenerateAggregateRootEntityAsync(definition);
            generatedFiles[$"{definition.Name}.cs"] = entityCode;
            
            // 2. ç”Ÿæˆå€¼å¯¹è±¡
            foreach (var valueObject in definition.ValueObjects)
            {
                var voCode = await GenerateValueObjectAsync(valueObject);
                generatedFiles[$"{valueObject.Name}.cs"] = voCode;
            }
            
            // 3. ç”Ÿæˆé¢†åŸŸäº‹ä»¶
            foreach (var domainEvent in definition.DomainEvents)
            {
                var eventCode = await GenerateDomainEventAsync(domainEvent);
                generatedFiles[$"Events/{domainEvent.Name}.cs"] = eventCode;
            }
            
            // 4. ç”Ÿæˆä»“å‚¨æ¥å£
            var repositoryCode = await GenerateRepositoryInterfaceAsync(definition);
            generatedFiles[$"I{definition.Name}Repository.cs"] = repositoryCode;
            
            // 5. ç”Ÿæˆé¢†åŸŸæœåŠ¡
            var domainServiceCode = await GenerateDomainServiceAsync(definition);
            generatedFiles[$"{definition.Name}Manager.cs"] = domainServiceCode;
            
            // 6. ç”Ÿæˆè§„çº¦
            foreach (var specification in definition.Specifications)
            {
                var specCode = await GenerateSpecificationAsync(specification);
                generatedFiles[$"Specifications/{specification.Name}.cs"] = specCode;
            }
            
            return new GeneratedAggregate
            {
                AggregateRoot = entityCode,
                Files = generatedFiles
            };
        }
        
        /// <summary>
        /// ç”Ÿæˆèšåˆæ ¹å®ä½“ - åŒ…å«å®Œæ•´çš„DDDæ¨¡å¼å®ç°
        /// </summary>
        private async Task<string> GenerateAggregateRootEntityAsync(AggregateDefinition definition)
        {
            var code = new StringBuilder();
            
            // Usingè¯­å¥
            code.AppendLine("using System;");
            code.AppendLine("using System.Collections.Generic;");
            code.AppendLine("using System.Collections.ObjectModel;");
            code.AppendLine("using System.Linq;");
            code.AppendLine("using System.Threading.Tasks;");
            code.AppendLine("using Volo.Abp;");
            code.AppendLine("using Volo.Abp.Domain.Entities.Auditing;");
            code.AppendLine("using Volo.Abp.MultiTenancy;");
            code.AppendLine("using Volo.Abp.Data;");
            code.AppendLine("using JetBrains.Annotations;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Domain.{definition.BoundedContext}");
            code.AppendLine("{");
            
            // ç±»å®šä¹‰
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// {definition.Description}");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    public sealed class {definition.Name} : FullAuditedAggregateRoot<Guid>, IMultiTenant, IHasExtraProperties");
            code.AppendLine("    {");
            
            // ç§æœ‰å­—æ®µï¼ˆç”¨äºå°è£…é›†åˆï¼‰
            foreach (var collection in definition.Collections)
            {
                code.AppendLine($"        private readonly List<{collection.ItemType}> _{collection.Name.ToLower()} = new();");
            }
            code.AppendLine();
            
            // é¢†åŸŸäº‹ä»¶é˜Ÿåˆ—
            code.AppendLine("        private readonly Queue<object> _domainEvents = new();");
            code.AppendLine();
            
            // å¤šç§Ÿæˆ·æ”¯æŒ
            code.AppendLine("        public Guid? TenantId { get; set; }");
            code.AppendLine();
            
            // é¢å¤–å±æ€§
            code.AppendLine("        public ExtraPropertyDictionary ExtraProperties { get; set; }");
            code.AppendLine();
            
            // å±æ€§
            foreach (var property in definition.Properties)
            {
                GeneratePropertyWithValidation(code, property);
            }
            
            // é›†åˆå±æ€§ï¼ˆåªè¯»ï¼‰
            foreach (var collection in definition.Collections)
            {
                code.AppendLine($"        public IReadOnlyCollection<{collection.ItemType}> {collection.Name} => _{collection.Name.ToLower()}.AsReadOnly();");
            }
            code.AppendLine();
            
            // ç§æœ‰æ„é€ å‡½æ•°ï¼ˆEF Coreéœ€è¦ï¼‰
            code.AppendLine($"        private {definition.Name}()");
            code.AppendLine("        {");
            code.AppendLine("            ExtraProperties = new ExtraPropertyDictionary();");
            code.AppendLine("        }");
            code.AppendLine();
            
            // å…¬å…±æ„é€ å‡½æ•°ï¼ˆå¸¦å‚æ•°éªŒè¯ï¼‰
            GeneratePublicConstructor(code, definition);
            
            // å·¥å‚æ–¹æ³•
            GenerateFactoryMethod(code, definition);
            
            // é¢†åŸŸæ–¹æ³•
            foreach (var method in definition.DomainMethods)
            {
                GenerateDomainMethod(code, method, definition);
            }
            
            // æ·»åŠ /åˆ é™¤å­å®ä½“çš„æ–¹æ³•
            foreach (var collection in definition.Collections)
            {
                GenerateCollectionMethods(code, collection);
            }
            
            // é¢†åŸŸäº‹ä»¶ç›¸å…³æ–¹æ³•
            GenerateDomainEventMethods(code);
            
            // ä¸šåŠ¡è§„åˆ™éªŒè¯
            GenerateBusinessRuleValidation(code, definition);
            
            // è§„çº¦æ–¹æ³•
            foreach (var spec in definition.Specifications)
            {
                GenerateSpecificationMethod(code, spec);
            }
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        /// <summary>
        /// ç”Ÿæˆå€¼å¯¹è±¡ - ä¸å¯å˜æ€§å’Œå€¼è¯­ä¹‰
        /// </summary>
        private async Task<string> GenerateValueObjectAsync(ValueObjectDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using System;");
            code.AppendLine("using System.Collections.Generic;");
            code.AppendLine("using Volo.Abp.Domain.Values;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Domain.ValueObjects");
            code.AppendLine("{");
            
            // ä½¿ç”¨recordå®ç°å€¼å¯¹è±¡ï¼ˆC# 9.0+ï¼‰
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// {definition.Description}");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    public sealed record {definition.Name} : ValueObject");
            code.AppendLine("    {");
            
            // å±æ€§ï¼ˆinit-onlyï¼‰
            foreach (var property in definition.Properties)
            {
                code.AppendLine($"        public {property.Type} {property.Name} {{ get; init; }}");
            }
            code.AppendLine();
            
            // æ„é€ å‡½æ•°
            code.AppendLine($"        public {definition.Name}(");
            var parameters = definition.Properties.Select(p => $"{p.Type} {p.Name.ToLower()}");
            code.AppendLine($"            {string.Join(",\n            ", parameters)})");
            code.AppendLine("        {");
            
            // éªŒè¯é€»è¾‘
            foreach (var property in definition.Properties)
            {
                if (property.ValidationRules != null)
                {
                    foreach (var rule in property.ValidationRules)
                    {
                        code.AppendLine($"            if (!({rule.Condition}))");
                        code.AppendLine($"                throw new ArgumentException(\"{rule.ErrorMessage}\", nameof({property.Name.ToLower()}));");
                    }
                }
                code.AppendLine($"            {property.Name} = {property.Name.ToLower()};");
            }
            
            code.AppendLine("        }");
            code.AppendLine();
            
            // GetAtomicValueså®ç°
            code.AppendLine("        protected override IEnumerable<object> GetAtomicValues()");
            code.AppendLine("        {");
            foreach (var property in definition.Properties)
            {
                code.AppendLine($"            yield return {property.Name};");
            }
            code.AppendLine("        }");
            
            // ä¸šåŠ¡æ–¹æ³•
            foreach (var method in definition.Methods)
            {
                GenerateValueObjectMethod(code, method);
            }
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        /// <summary>
        /// ç”Ÿæˆé¢†åŸŸäº‹ä»¶ - äº‹ä»¶æº¯æºæ”¯æŒ
        /// </summary>
        private async Task<string> GenerateDomainEventAsync(DomainEventDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using System;");
            code.AppendLine("using Volo.Abp.Domain.Entities.Events;");
            code.AppendLine("using Volo.Abp.EventBus;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Domain.Events");
            code.AppendLine("{");
            
            // äº‹ä»¶è®°å½•ï¼ˆä½¿ç”¨recordç±»å‹ï¼‰
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// {definition.Description}");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    [EventName(\"{definition.EventName}\")]");
            code.AppendLine($"    public sealed record {definition.Name} : EntityChangedEventData<{definition.EntityType}>");
            code.AppendLine("    {");
            
            // äº‹ä»¶å±æ€§
            foreach (var property in definition.Properties)
            {
                code.AppendLine($"        public {property.Type} {property.Name} {{ get; init; }}");
            }
            code.AppendLine();
            
            // äº‹ä»¶å…ƒæ•°æ®
            code.AppendLine("        public DateTime OccurredOn { get; init; }");
            code.AppendLine("        public string CorrelationId { get; init; }");
            code.AppendLine("        public string CausationId { get; init; }");
            code.AppendLine("        public string UserId { get; init; }");
            code.AppendLine();
            
            // æ„é€ å‡½æ•°
            code.AppendLine($"        public {definition.Name}(");
            code.AppendLine($"            {definition.EntityType} entity,");
            foreach (var property in definition.Properties)
            {
                code.AppendLine($"            {property.Type} {property.Name.ToLower()},");
            }
            code.AppendLine("            string correlationId = null,");
            code.AppendLine("            string causationId = null)");
            code.AppendLine("            : base(entity)");
            code.AppendLine("        {");
            foreach (var property in definition.Properties)
            {
                code.AppendLine($"            {property.Name} = {property.Name.ToLower()};");
            }
            code.AppendLine("            OccurredOn = DateTime.UtcNow;");
            code.AppendLine("            CorrelationId = correlationId ?? Guid.NewGuid().ToString();");
            code.AppendLine("            CausationId = causationId;");
            code.AppendLine("            UserId = entity.LastModifierId?.ToString();");
            code.AppendLine("        }");
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        /// <summary>
        /// ç”Ÿæˆä»“å‚¨æ¥å£ - åŒ…å«é«˜çº§æŸ¥è¯¢æ–¹æ³•
        /// </summary>
        private async Task<string> GenerateRepositoryInterfaceAsync(AggregateDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using System;");
            code.AppendLine("using System.Collections.Generic;");
            code.AppendLine("using System.Linq;");
            code.AppendLine("using System.Linq.Expressions;");
            code.AppendLine("using System.Threading;");
            code.AppendLine("using System.Threading.Tasks;");
            code.AppendLine("using Volo.Abp.Domain.Repositories;");
            code.AppendLine("using Volo.Abp.Specifications;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Domain.Repositories");
            code.AppendLine("{");
            
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// {definition.Name}ä»“å‚¨æ¥å£");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    public interface I{definition.Name}Repository : IRepository<{definition.Name}, Guid>");
            code.AppendLine("    {");
            
            // åŸºç¡€æŸ¥è¯¢æ–¹æ³•
            code.AppendLine("        #region åŸºç¡€æŸ¥è¯¢");
            code.AppendLine();
            
            code.AppendLine($"        Task<{definition.Name}> GetAsync(");
            code.AppendLine("            Expression<Func<" + definition.Name + ", bool>> predicate,");
            code.AppendLine("            bool includeDetails = true,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine($"        Task<List<{definition.Name}>> GetListAsync(");
            code.AppendLine("            Expression<Func<" + definition.Name + ", bool>> predicate = null,");
            code.AppendLine("            Func<IQueryable<" + definition.Name + ">, IOrderedQueryable<" + definition.Name + ">> orderBy = null,");
            code.AppendLine("            bool includeDetails = false,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine("        #endregion");
            code.AppendLine();
            
            // åˆ†é¡µæŸ¥è¯¢
            code.AppendLine("        #region åˆ†é¡µæŸ¥è¯¢");
            code.AppendLine();
            
            code.AppendLine($"        Task<(List<{definition.Name}> Items, long TotalCount)> GetPagedListAsync(");
            code.AppendLine("            int skipCount,");
            code.AppendLine("            int maxResultCount,");
            code.AppendLine("            string sorting = null,");
            code.AppendLine("            Expression<Func<" + definition.Name + ", bool>> predicate = null,");
            code.AppendLine("            bool includeDetails = false,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine("        #endregion");
            code.AppendLine();
            
            // è§„çº¦æŸ¥è¯¢
            code.AppendLine("        #region è§„çº¦æŸ¥è¯¢");
            code.AppendLine();
            
            code.AppendLine($"        Task<List<{definition.Name}>> GetBySpecificationAsync(");
            code.AppendLine("            ISpecification<" + definition.Name + "> specification,");
            code.AppendLine("            bool includeDetails = false,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine($"        Task<{definition.Name}> GetSingleBySpecificationAsync(");
            code.AppendLine("            ISpecification<" + definition.Name + "> specification,");
            code.AppendLine("            bool includeDetails = true,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine("        #endregion");
            code.AppendLine();
            
            // æ‰¹é‡æ“ä½œ
            code.AppendLine("        #region æ‰¹é‡æ“ä½œ");
            code.AppendLine();
            
            code.AppendLine($"        Task BulkInsertAsync(");
            code.AppendLine("            IEnumerable<" + definition.Name + "> entities,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine($"        Task BulkUpdateAsync(");
            code.AppendLine("            IEnumerable<" + definition.Name + "> entities,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine($"        Task BulkDeleteAsync(");
            code.AppendLine("            Expression<Func<" + definition.Name + ", bool>> predicate,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine("        #endregion");
            code.AppendLine();
            
            // å¼‚æ­¥æµæŸ¥è¯¢ï¼ˆå¤§æ•°æ®é‡ï¼‰
            code.AppendLine("        #region å¼‚æ­¥æµæŸ¥è¯¢");
            code.AppendLine();
            
            code.AppendLine($"        IAsyncEnumerable<{definition.Name}> GetAsyncEnumerable(");
            code.AppendLine("            Expression<Func<" + definition.Name + ", bool>> predicate = null,");
            code.AppendLine("            Func<IQueryable<" + definition.Name + ">, IOrderedQueryable<" + definition.Name + ">> orderBy = null,");
            code.AppendLine("            bool includeDetails = false,");
            code.AppendLine("            CancellationToken cancellationToken = default);");
            code.AppendLine();
            
            code.AppendLine("        #endregion");
            
            // è‡ªå®šä¹‰æŸ¥è¯¢æ–¹æ³•
            foreach (var query in definition.CustomQueries)
            {
                GenerateCustomQueryMethod(code, query);
            }
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        /// <summary>
        /// ç”Ÿæˆé¢†åŸŸæœåŠ¡ - å®ç°å¤æ‚ä¸šåŠ¡é€»è¾‘
        /// </summary>
        private async Task<string> GenerateDomainServiceAsync(AggregateDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using System;");
            code.AppendLine("using System.Collections.Generic;");
            code.AppendLine("using System.Linq;");
            code.AppendLine("using System.Threading.Tasks;");
            code.AppendLine("using Microsoft.Extensions.Logging;");
            code.AppendLine("using Volo.Abp;");
            code.AppendLine("using Volo.Abp.Domain.Services;");
            code.AppendLine("using Volo.Abp.EventBus.Local;");
            code.AppendLine("using Volo.Abp.Guids;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Domain");
            code.AppendLine("{");
            
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// {definition.Name}é¢†åŸŸæœåŠ¡");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    public sealed class {definition.Name}Manager : DomainService");
            code.AppendLine("    {");
            
            // ä¾èµ–æ³¨å…¥
            code.AppendLine($"        private readonly I{definition.Name}Repository _repository;");
            code.AppendLine("        private readonly IGuidGenerator _guidGenerator;");
            code.AppendLine("        private readonly ILocalEventBus _localEventBus;");
            code.AppendLine($"        private readonly ILogger<{definition.Name}Manager> _logger;");
            code.AppendLine();
            
            // æ„é€ å‡½æ•°
            code.AppendLine($"        public {definition.Name}Manager(");
            code.AppendLine($"            I{definition.Name}Repository repository,");
            code.AppendLine("            IGuidGenerator guidGenerator,");
            code.AppendLine("            ILocalEventBus localEventBus,");
            code.AppendLine($"            ILogger<{definition.Name}Manager> logger)");
            code.AppendLine("        {");
            code.AppendLine("            _repository = repository;");
            code.AppendLine("            _guidGenerator = guidGenerator;");
            code.AppendLine("            _localEventBus = localEventBus;");
            code.AppendLine("            _logger = logger;");
            code.AppendLine("        }");
            code.AppendLine();
            
            // åˆ›å»ºæ–¹æ³•
            code.AppendLine($"        public async Task<{definition.Name}> CreateAsync(");
            var createParams = definition.Properties
                .Where(p => p.IsRequired)
                .Select(p => $"{p.Type} {p.Name.ToLower()}");
            code.AppendLine($"            {string.Join(",\n            ", createParams)})");
            code.AppendLine("        {");
            code.AppendLine($"            _logger.LogInformation(\"Creating new {definition.Name}\");");
            code.AppendLine();
            
            // ä¸šåŠ¡è§„åˆ™éªŒè¯
            code.AppendLine("            // ä¸šåŠ¡è§„åˆ™éªŒè¯");
            foreach (var rule in definition.BusinessRules)
            {
                code.AppendLine($"            await Validate{rule.Name}Async({string.Join(", ", rule.Parameters)});");
            }
            code.AppendLine();
            
            // åˆ›å»ºå®ä½“
            code.AppendLine($"            var entity = {definition.Name}.Create(");
            code.AppendLine("                _guidGenerator.Create(),");
            var createArgs = definition.Properties
                .Where(p => p.IsRequired)
                .Select(p => $"                {p.Name.ToLower()}");
            code.AppendLine(string.Join(",\n", createArgs));
            code.AppendLine("            );");
            code.AppendLine();
            
            // å‘å¸ƒé¢†åŸŸäº‹ä»¶
            code.AppendLine("            // å‘å¸ƒåˆ›å»ºäº‹ä»¶");
            code.AppendLine($"            await _localEventBus.PublishAsync(new {definition.Name}CreatedEvent(entity));");
            code.AppendLine();
            
            code.AppendLine("            return entity;");
            code.AppendLine("        }");
            code.AppendLine();
            
            // æ›´æ–°æ–¹æ³•
            GenerateDomainServiceUpdateMethod(code, definition);
            
            // åˆ é™¤æ–¹æ³•
            GenerateDomainServiceDeleteMethod(code, definition);
            
            // ä¸šåŠ¡è§„åˆ™éªŒè¯æ–¹æ³•
            foreach (var rule in definition.BusinessRules)
            {
                GenerateBusinessRuleValidationMethod(code, rule);
            }
            
            // å¤æ‚ä¸šåŠ¡æ–¹æ³•
            foreach (var method in definition.ComplexBusinessMethods)
            {
                GenerateComplexBusinessMethod(code, method);
            }
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        /// <summary>
        /// æ„å»ºç”Ÿæˆç®¡é“ - ä½¿ç”¨TPL Dataflowå®ç°é«˜æ€§èƒ½å¤„ç†
        /// </summary>
        private ActionBlock<GenerationRequest> CreateGenerationPipeline()
        {
            // è½¬æ¢å—ï¼šè§£æå®šä¹‰
            var parseBlock = new TransformBlock<GenerationRequest, ParsedRequest>(
                async request =>
                {
                    _logger.LogDebug("Parsing generation request for {Name}", request.Name);
                    return await ParseRequestAsync(request);
                },
                new ExecutionDataflowBlockOptions
                {
                    MaxDegreeOfParallelism = Environment.ProcessorCount,
                    BoundedCapacity = 100
                });
            
            // è½¬æ¢å—ï¼šç”Ÿæˆä»£ç 
            var generateBlock = new TransformBlock<ParsedRequest, GeneratedCode>(
                async parsed =>
                {
                    _logger.LogDebug("Generating code for {Name}", parsed.Name);
                    return await GenerateCodeAsync(parsed);
                },
                new ExecutionDataflowBlockOptions
                {
                    MaxDegreeOfParallelism = Environment.ProcessorCount / 2,
                    BoundedCapacity = 50
                });
            
            // åŠ¨ä½œå—ï¼šä¿å­˜ç»“æœ
            var saveBlock = new ActionBlock<GeneratedCode>(
                async generated =>
                {
                    _logger.LogDebug("Saving generated code for {Name}", generated.Name);
                    await SaveGeneratedCodeAsync(generated);
                },
                new ExecutionDataflowBlockOptions
                {
                    MaxDegreeOfParallelism = 1,
                    BoundedCapacity = 10
                });
            
            // é“¾æ¥ç®¡é“
            var linkOptions = new DataflowLinkOptions { PropagateCompletion = true };
            parseBlock.LinkTo(generateBlock, linkOptions);
            generateBlock.LinkTo(saveBlock, linkOptions);
            
            // è¿”å›å…¥å£å—
            return new ActionBlock<GenerationRequest>(
                async request => await parseBlock.SendAsync(request),
                new ExecutionDataflowBlockOptions
                {
                    BoundedCapacity = 1000
                });
        }
        
        // è¾…åŠ©æ–¹æ³•å®ç°...
        private async Task<ParsedRequest> ParseRequestAsync(GenerationRequest request) 
        {
            // å®ç°è§£æé€»è¾‘
            return new ParsedRequest { Name = request.Name };
        }
        
        private async Task<GeneratedCode> GenerateCodeAsync(ParsedRequest parsed)
        {
            // å®ç°ç”Ÿæˆé€»è¾‘
            return new GeneratedCode { Name = parsed.Name };
        }
        
        private async Task SaveGeneratedCodeAsync(GeneratedCode generated)
        {
            // å®ç°ä¿å­˜é€»è¾‘
        }
    }
}
```

### æ­¥éª¤3ï¼šåº”ç”¨æœåŠ¡å±‚ç”Ÿæˆå™¨ - CQRSæ¨¡å¼å®ç°

**packages/backend-generator/src/Application/ApplicationServiceGenerator.cs**

```csharp
using System;
using System.Text;
using System.Threading.Tasks;
using MediatR;
using FluentValidation;
using AutoMapper;
using Volo.Abp.Application.Services;
using Volo.Abp.Application.Dtos;
using Microsoft.AspNetCore.Authorization;

namespace LowCode.Generator.Application
{
    /// <summary>
    /// åº”ç”¨æœåŠ¡ç”Ÿæˆå™¨ - å®ç°CQRSã€MediatRã€FluentValidation
    /// </summary>
    public sealed class ApplicationServiceGenerator
    {
        /// <summary>
        /// ç”Ÿæˆåº”ç”¨æœåŠ¡ - åŒ…å«å®Œæ•´çš„CQRSå®ç°
        /// </summary>
        public async Task<GeneratedApplicationService> GenerateApplicationServiceAsync(
            ServiceDefinition definition)
        {
            var files = new Dictionary<string, string>();
            
            // 1. ç”ŸæˆDTO
            files.AddRange(await GenerateDtosAsync(definition));
            
            // 2. ç”ŸæˆCommandå’ŒQuery
            files.AddRange(await GenerateCQRSAsync(definition));
            
            // 3. ç”ŸæˆValidators
            files.AddRange(await GenerateValidatorsAsync(definition));
            
            // 4. ç”ŸæˆAutoMapper Profile
            files.Add($"{definition.Name}AutoMapperProfile.cs", 
                await GenerateAutoMapperProfileAsync(definition));
            
            // 5. ç”Ÿæˆåº”ç”¨æœåŠ¡æ¥å£
            files.Add($"I{definition.Name}AppService.cs", 
                await GenerateServiceInterfaceAsync(definition));
            
            // 6. ç”Ÿæˆåº”ç”¨æœåŠ¡å®ç°
            files.Add($"{definition.Name}AppService.cs", 
                await GenerateServiceImplementationAsync(definition));
            
            // 7. ç”ŸæˆIntegration Events
            files.AddRange(await GenerateIntegrationEventsAsync(definition));
            
            return new GeneratedApplicationService { Files = files };
        }
        
        /// <summary>
        /// ç”ŸæˆCQRSå‘½ä»¤å’ŒæŸ¥è¯¢
        /// </summary>
        private async Task<Dictionary<string, string>> GenerateCQRSAsync(ServiceDefinition definition)
        {
            var files = new Dictionary<string, string>();
            
            // Commands
            foreach (var command in definition.Commands)
            {
                var code = new StringBuilder();
                
                code.AppendLine("using System;");
                code.AppendLine("using System.Threading;");
                code.AppendLine("using System.Threading.Tasks;");
                code.AppendLine("using MediatR;");
                code.AppendLine("using FluentValidation;");
                code.AppendLine("using Microsoft.Extensions.Logging;");
                code.AppendLine("using Volo.Abp.Domain.Repositories;");
                code.AppendLine("using Volo.Abp.Uow;");
                code.AppendLine();
                
                code.AppendLine($"namespace {definition.Namespace}.Application.Commands");
                code.AppendLine("{");
                
                // Commandå®šä¹‰
                code.AppendLine($"    /// <summary>");
                code.AppendLine($"    /// {command.Description}");
                code.AppendLine($"    /// </summary>");
                code.AppendLine($"    public sealed record {command.Name}Command : IRequest<{command.ReturnType}>");
                code.AppendLine("    {");
                foreach (var prop in command.Properties)
                {
                    code.AppendLine($"        public {prop.Type} {prop.Name} {{ get; init; }}");
                }
                code.AppendLine("    }");
                code.AppendLine();
                
                // Command Handler
                code.AppendLine($"    /// <summary>");
                code.AppendLine($"    /// {command.Name} å¤„ç†å™¨");
                code.AppendLine($"    /// </summary>");
                code.AppendLine($"    public sealed class {command.Name}Handler : ");
                code.AppendLine($"        IRequestHandler<{command.Name}Command, {command.ReturnType}>");
                code.AppendLine("    {");
                
                // ä¾èµ–æ³¨å…¥
                code.AppendLine($"        private readonly IRepository<{definition.EntityName}, Guid> _repository;");
                code.AppendLine($"        private readonly {definition.EntityName}Manager _manager;");
                code.AppendLine("        private readonly IUnitOfWorkManager _unitOfWorkManager;");
                code.AppendLine($"        private readonly ILogger<{command.Name}Handler> _logger;");
                code.AppendLine("        private readonly IMapper _mapper;");
                code.AppendLine();
                
                // æ„é€ å‡½æ•°
                code.AppendLine($"        public {command.Name}Handler(");
                code.AppendLine($"            IRepository<{definition.EntityName}, Guid> repository,");
                code.AppendLine($"            {definition.EntityName}Manager manager,");
                code.AppendLine("            IUnitOfWorkManager unitOfWorkManager,");
                code.AppendLine($"            ILogger<{command.Name}Handler> logger,");
                code.AppendLine("            IMapper mapper)");
                code.AppendLine("        {");
                code.AppendLine("            _repository = repository;");
                code.AppendLine("            _manager = manager;");
                code.AppendLine("            _unitOfWorkManager = unitOfWorkManager;");
                code.AppendLine("            _logger = logger;");
                code.AppendLine("            _mapper = mapper;");
                code.AppendLine("        }");
                code.AppendLine();
                
                // Handleæ–¹æ³•
                code.AppendLine($"        public async Task<{command.ReturnType}> Handle(");
                code.AppendLine($"            {command.Name}Command request,");
                code.AppendLine("            CancellationToken cancellationToken)");
                code.AppendLine("        {");
                code.AppendLine($"            _logger.LogInformation(\"Handling {command.Name}Command\");");
                code.AppendLine();
                
                // å·¥ä½œå•å…ƒ
                code.AppendLine("            using var uow = _unitOfWorkManager.Begin(");
                code.AppendLine("                requiresNew: true,");
                code.AppendLine("                isTransactional: true);");
                code.AppendLine();
                
                code.AppendLine("            try");
                code.AppendLine("            {");
                
                // ä¸šåŠ¡é€»è¾‘
                GenerateCommandHandlerLogic(code, command, definition);
                
                code.AppendLine();
                code.AppendLine("                await uow.CompleteAsync(cancellationToken);");
                code.AppendLine();
                code.AppendLine($"                _logger.LogInformation(\"{command.Name}Command handled successfully\");");
                code.AppendLine("                return result;");
                code.AppendLine("            }");
                code.AppendLine("            catch (Exception ex)");
                code.AppendLine("            {");
                code.AppendLine($"                _logger.LogError(ex, \"Error handling {command.Name}Command\");");
                code.AppendLine("                await uow.RollbackAsync(cancellationToken);");
                code.AppendLine("                throw;");
                code.AppendLine("            }");
                code.AppendLine("        }");
                
                // Pipeline Behaviors
                GeneratePipelineBehaviors(code, command);
                
                code.AppendLine("    }");
                code.AppendLine("}");
                
                files.Add($"Commands/{command.Name}Command.cs", code.ToString());
            }
            
            // Queries
            foreach (var query in definition.Queries)
            {
                files.Add($"Queries/{query.Name}Query.cs", 
                    await GenerateQueryAsync(query, definition));
            }
            
            return files;
        }
        
        /// <summary>
        /// ç”ŸæˆæŸ¥è¯¢å®ç° - åŒ…å«é«˜çº§æŸ¥è¯¢ä¼˜åŒ–
        /// </summary>
        private async Task<string> GenerateQueryAsync(QueryDefinition query, ServiceDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using System;");
            code.AppendLine("using System.Collections.Generic;");
            code.AppendLine("using System.Linq;");
            code.AppendLine("using System.Linq.Dynamic.Core;");
            code.AppendLine("using System.Threading;");
            code.AppendLine("using System.Threading.Tasks;");
            code.AppendLine("using MediatR;");
            code.AppendLine("using Microsoft.EntityFrameworkCore;");
            code.AppendLine("using Microsoft.Extensions.Caching.Distributed;");
            code.AppendLine("using Volo.Abp.Domain.Repositories;");
            code.AppendLine("using Volo.Abp.Specifications;");
            code.AppendLine();
            
            code.AppendLine($"namespace {definition.Namespace}.Application.Queries");
            code.AppendLine("{");
            
            // Queryå®šä¹‰
            code.AppendLine($"    public sealed record {query.Name}Query : IRequest<{query.ReturnType}>");
            code.AppendLine("    {");
            foreach (var param in query.Parameters)
            {
                code.AppendLine($"        public {param.Type} {param.Name} {{ get; init; }}");
            }
            
            // åˆ†é¡µå‚æ•°
            if (query.IsPaged)
            {
                code.AppendLine("        public int SkipCount { get; init; } = 0;");
                code.AppendLine("        public int MaxResultCount { get; init; } = 10;");
                code.AppendLine("        public string Sorting { get; init; }");
            }
            
            code.AppendLine("    }");
            code.AppendLine();
            
            // Query Handler
            code.AppendLine($"    public sealed class {query.Name}Handler : ");
            code.AppendLine($"        IRequestHandler<{query.Name}Query, {query.ReturnType}>");
            code.AppendLine("    {");
            
            // ä¾èµ–
            code.AppendLine($"        private readonly IRepository<{definition.EntityName}, Guid> _repository;");
            code.AppendLine("        private readonly IDistributedCache _cache;");
            code.AppendLine("        private readonly IMapper _mapper;");
            code.AppendLine();
            
            // æ„é€ å‡½æ•°
            code.AppendLine($"        public {query.Name}Handler(");
            code.AppendLine($"            IRepository<{definition.EntityName}, Guid> repository,");
            code.AppendLine("            IDistributedCache cache,");
            code.AppendLine("            IMapper mapper)");
            code.AppendLine("        {");
            code.AppendLine("            _repository = repository;");
            code.AppendLine("            _cache = cache;");
            code.AppendLine("            _mapper = mapper;");
            code.AppendLine("        }");
            code.AppendLine();
            
            // Handleæ–¹æ³•
            code.AppendLine($"        public async Task<{query.ReturnType}> Handle(");
            code.AppendLine($"            {query.Name}Query request,");
            code.AppendLine("            CancellationToken cancellationToken)");
            code.AppendLine("        {");
            
            // ç¼“å­˜é”®
            if (query.IsCacheable)
            {
                code.AppendLine("            // å°è¯•ä»ç¼“å­˜è·å–");
                code.AppendLine($"            var cacheKey = $\"{query.Name}:{{request.GetHashCode()}}\";");
                code.AppendLine("            var cached = await _cache.GetStringAsync(cacheKey, cancellationToken);");
                code.AppendLine("            if (!string.IsNullOrEmpty(cached))");
                code.AppendLine("            {");
                code.AppendLine($"                return JsonSerializer.Deserialize<{query.ReturnType}>(cached);");
                code.AppendLine("            }");
                code.AppendLine();
            }
            
            // æ„å»ºæŸ¥è¯¢
            code.AppendLine("            // æ„å»ºæŸ¥è¯¢");
            code.AppendLine("            var queryable = await _repository.GetQueryableAsync();");
            code.AppendLine();
            
            // åŒ…å«å…³è”æ•°æ®
            if (query.IncludeDetails)
            {
                foreach (var include in query.Includes)
                {
                    code.AppendLine($"            queryable = queryable.Include(x => x.{include});");
                }
            }
            
            // åº”ç”¨è¿‡æ»¤
            GenerateQueryFilters(code, query);
            
            // åº”ç”¨æ’åº
            if (query.IsPaged)
            {
                code.AppendLine();
                code.AppendLine("            // åº”ç”¨æ’åº");
                code.AppendLine("            if (!string.IsNullOrEmpty(request.Sorting))");
                code.AppendLine("            {");
                code.AppendLine("                queryable = queryable.OrderBy(request.Sorting);");
                code.AppendLine("            }");
                code.AppendLine("            else");
                code.AppendLine("            {");
                code.AppendLine("                queryable = queryable.OrderByDescending(x => x.CreationTime);");
                code.AppendLine("            }");
            }
            
            // æ‰§è¡ŒæŸ¥è¯¢
            if (query.IsPaged)
            {
                code.AppendLine();
                code.AppendLine("            // åˆ†é¡µæŸ¥è¯¢");
                code.AppendLine("            var totalCount = await queryable.CountAsync(cancellationToken);");
                code.AppendLine("            var items = await queryable");
                code.AppendLine("                .Skip(request.SkipCount)");
                code.AppendLine("                .Take(request.MaxResultCount)");
                code.AppendLine("                .ToListAsync(cancellationToken);");
                code.AppendLine();
                code.AppendLine("            var dtos = _mapper.Map<List<" + query.DtoType + ">>(items);");
                code.AppendLine();
                code.AppendLine("            var result = new PagedResultDto<" + query.DtoType + ">(totalCount, dtos);");
            }
            else if (query.ReturnsList)
            {
                code.AppendLine();
                code.AppendLine("            var items = await queryable.ToListAsync(cancellationToken);");
                code.AppendLine("            var result = _mapper.Map<List<" + query.DtoType + ">>(items);");
            }
            else
            {
                code.AppendLine();
                code.AppendLine("            var item = await queryable.FirstOrDefaultAsync(cancellationToken);");
                code.AppendLine("            var result = _mapper.Map<" + query.DtoType + ">(item);");
            }
            
            // ç¼“å­˜ç»“æœ
            if (query.IsCacheable)
            {
                code.AppendLine();
                code.AppendLine("            // ç¼“å­˜ç»“æœ");
                code.AppendLine("            await _cache.SetStringAsync(");
                code.AppendLine("                cacheKey,");
                code.AppendLine("                JsonSerializer.Serialize(result),");
                code.AppendLine("                new DistributedCacheEntryOptions");
                code.AppendLine("                {");
                code.AppendLine("                    SlidingExpiration = TimeSpan.FromMinutes(5)");
                code.AppendLine("                },");
                code.AppendLine("                cancellationToken);");
            }
            
            code.AppendLine();
            code.AppendLine("            return result;");
            code.AppendLine("        }");
            
            code.AppendLine("    }");
            code.AppendLine("}");
            
            return code.ToString();
        }
        
        // ç”ŸæˆæŸ¥è¯¢è¿‡æ»¤æ¡ä»¶
        private void GenerateQueryFilters(StringBuilder code, QueryDefinition query)
        {
            code.AppendLine();
            code.AppendLine("            // åº”ç”¨è¿‡æ»¤æ¡ä»¶");
            
            foreach (var filter in query.Filters)
            {
                switch (filter.Type)
                {
                    case "String":
                        code.AppendLine($"            if (!string.IsNullOrWhiteSpace(request.{filter.Name}))");
                        code.AppendLine("            {");
                        if (filter.IsContains)
                        {
                            code.AppendLine($"                queryable = queryable.Where(x => x.{filter.Property}.Contains(request.{filter.Name}));");
                        }
                        else
                        {
                            code.AppendLine($"                queryable = queryable.Where(x => x.{filter.Property} == request.{filter.Name});");
                        }
                        code.AppendLine("            }");
                        break;
                        
                    case "DateTime":
                        if (filter.IsRange)
                        {
                            code.AppendLine($"            if (request.{filter.Name}Start.HasValue)");
                            code.AppendLine("            {");
                            code.AppendLine($"                queryable = queryable.Where(x => x.{filter.Property} >= request.{filter.Name}Start.Value);");
                            code.AppendLine("            }");
                            code.AppendLine($"            if (request.{filter.Name}End.HasValue)");
                            code.AppendLine("            {");
                            code.AppendLine($"                queryable = queryable.Where(x => x.{filter.Property} <= request.{filter.Name}End.Value);");
                            code.AppendLine("            }");
                        }
                        break;
                        
                    case "Enum":
                        code.AppendLine($"            if (request.{filter.Name}.HasValue)");
                        code.AppendLine("            {");
                        code.AppendLine($"                queryable = queryable.Where(x => x.{filter.Property} == request.{filter.Name}.Value);");
                        code.AppendLine("            }");
                        break;
                }
            }
        }
        
        // ç”Ÿæˆç®¡é“è¡Œä¸º
        private void GeneratePipelineBehaviors(StringBuilder code, CommandDefinition command)
        {
            code.AppendLine();
            code.AppendLine($"    /// <summary>");
            code.AppendLine($"    /// éªŒè¯ç®¡é“è¡Œä¸º");
            code.AppendLine($"    /// </summary>");
            code.AppendLine($"    public sealed class {command.Name}ValidationBehavior : ");
            code.AppendLine($"        IPipelineBehavior<{command.Name}Command, {command.ReturnType}>");
            code.AppendLine("    {");
            code.AppendLine($"        private readonly IValidator<{command.Name}Command> _validator;");
            code.AppendLine();
            code.AppendLine($"        public {command.Name}ValidationBehavior(IValidator<{command.Name}Command> validator)");
            code.AppendLine("        {");
            code.AppendLine("            _validator = validator;");
            code.AppendLine("        }");
            code.AppendLine();
            code.AppendLine($"        public async Task<{command.ReturnType}> Handle(");
            code.AppendLine($"            {command.Name}Command request,");
            code.AppendLine("            RequestHandlerDelegate<" + command.ReturnType + "> next,");
            code.AppendLine("            CancellationToken cancellationToken)");
            code.AppendLine("        {");
            code.AppendLine("            var validationResult = await _validator.ValidateAsync(request, cancellationToken);");
            code.AppendLine("            if (!validationResult.IsValid)");
            code.AppendLine("            {");
            code.AppendLine("                throw new ValidationException(validationResult.Errors);");
            code.AppendLine("            }");
            code.AppendLine();
            code.AppendLine("            return await next();");
            code.AppendLine("        }");
            code.AppendLine("    }");
        }
    }
}
```

### æ­¥éª¤4ï¼šAspireå¾®æœåŠ¡é›†æˆ

**packages/backend-generator/src/Aspire/AspireServiceGenerator.cs**

```csharp
using System;
using System.Text;
using System.Threading.Tasks;
using Aspire.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;

namespace LowCode.Generator.Aspire
{
    /// <summary>
    /// Aspireå¾®æœåŠ¡ç”Ÿæˆå™¨ - æœ€ä½³å®è·µå®ç°
    /// </summary>
    public sealed class AspireServiceGenerator
    {
        public async Task<string> GenerateAspireHostAsync(MicroserviceDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using Aspire.Hosting;");
            code.AppendLine("using Aspire.Hosting.ApplicationModel;");
            code.AppendLine();
            
            code.AppendLine("var builder = DistributedApplication.CreateBuilder(args);");
            code.AppendLine();
            
            // Redis
            code.AppendLine("// æ·»åŠ Redisç¼“å­˜");
            code.AppendLine("var redis = builder.AddRedis(\"redis\")");
            code.AppendLine("    .WithDataVolume()");
            code.AppendLine("    .WithRedisCommander();");
            code.AppendLine();
            
            // PostgreSQL
            code.AppendLine("// æ·»åŠ PostgreSQLæ•°æ®åº“");
            code.AppendLine("var postgres = builder.AddPostgres(\"postgres\")");
            code.AppendLine("    .WithDataVolume()");
            code.AppendLine("    .WithPgAdmin();");
            code.AppendLine();
            code.AppendLine($"var db = postgres.AddDatabase(\"{definition.DatabaseName}\");");
            code.AppendLine();
            
            // RabbitMQ
            code.AppendLine("// æ·»åŠ RabbitMQæ¶ˆæ¯é˜Ÿåˆ—");
            code.AppendLine("var rabbitmq = builder.AddRabbitMQ(\"rabbitmq\")");
            code.AppendLine("    .WithManagementPlugin()");
            code.AppendLine("    .WithDataVolume();");
            code.AppendLine();
            
            // Elasticsearch
            code.AppendLine("// æ·»åŠ Elasticsearch");
            code.AppendLine("var elasticsearch = builder.AddElasticsearch(\"elasticsearch\")");
            code.AppendLine("    .WithDataVolume();");
            code.AppendLine();
            
            // æ·»åŠ å¾®æœåŠ¡
            foreach (var service in definition.Services)
            {
                code.AppendLine($"// {service.Description}");
                code.AppendLine($"var {service.Name.ToLower()} = builder.AddProject<Projects.{service.Name}>(\"{service.Name.ToLower()}\")");
                code.AppendLine($"    .WithReference(redis)");
                code.AppendLine($"    .WithReference(db)");
                code.AppendLine($"    .WithReference(rabbitmq)");
                code.AppendLine($"    .WithReference(elasticsearch)");
                
                if (service.WithDapr)
                {
                    code.AppendLine($"    .WithDaprSidecar()");
                }
                
                code.AppendLine($"    .WithReplicas({service.Replicas});");
                code.AppendLine();
            }
            
            // APIç½‘å…³
            code.AppendLine("// æ·»åŠ APIç½‘å…³");
            code.AppendLine("var gateway = builder.AddProject<Projects.Gateway>(\"gateway\")");
            foreach (var service in definition.Services)
            {
                code.AppendLine($"    .WithReference({service.Name.ToLower()})");
            }
            code.AppendLine("    .WithExternalHttpEndpoints();");
            code.AppendLine();
            
            code.AppendLine("builder.Build().Run();");
            
            return code.ToString();
        }
        
        /// <summary>
        /// ç”Ÿæˆå¾®æœåŠ¡é¡¹ç›®
        /// </summary>
        public async Task<string> GenerateMicroserviceAsync(ServiceDefinition definition)
        {
            var code = new StringBuilder();
            
            code.AppendLine("using Microsoft.AspNetCore.Builder;");
            code.AppendLine("using Microsoft.Extensions.DependencyInjection;");
            code.AppendLine("using Microsoft.Extensions.Hosting;");
            code.AppendLine("using OpenTelemetry.Metrics;");
            code.AppendLine("using OpenTelemetry.Trace;");
            code.AppendLine();
            
            code.AppendLine("var builder = WebApplication.CreateBuilder(args);");
            code.AppendLine();
            
            // æ·»åŠ Aspireé»˜è®¤æœåŠ¡
            code.AppendLine("// AspireæœåŠ¡");
            code.AppendLine("builder.AddServiceDefaults();");
            code.AppendLine();
            
            // æ·»åŠ OpenTelemetry
            code.AppendLine("// OpenTelemetry");
            code.AppendLine("builder.Services.AddOpenTelemetry()");
            code.AppendLine("    .WithTracing(tracing =>");
            code.AppendLine("    {");
            code.AppendLine("        tracing.AddAspNetCoreInstrumentation()");
            code.AppendLine("               .AddHttpClientInstrumentation()");
            code.AppendLine("               .AddEntityFrameworkCoreInstrumentation();");
            code.AppendLine("    })");
            code.AppendLine("    .WithMetrics(metrics =>");
            code.AppendLine("    {");
            code.AppendLine("        metrics.AddAspNetCoreInstrumentation()");
            code.AppendLine("               .AddHttpClientInstrumentation()");
            code.AppendLine("               .AddRuntimeInstrumentation()");
            code.AppendLine("               .AddProcessInstrumentation();");
            code.AppendLine("    });");
            code.AppendLine();
            
            // å¥åº·æ£€æŸ¥
            code.AppendLine("// å¥åº·æ£€æŸ¥");
            code.AppendLine("builder.Services.AddHealthChecks()");
            code.AppendLine("    .AddDbContextCheck<AppDbContext>()");
            code.AppendLine("    .AddRedis(\"redis\")");
            code.AppendLine("    .AddRabbitMQ()");
            code.AppendLine("    .AddElasticsearch();");
            code.AppendLine();
            
            // æ·»åŠ æœåŠ¡
            code.AppendLine("// ä¸šåŠ¡æœåŠ¡");
            code.AppendLine("builder.Services.AddApplication();");
            code.AppendLine("builder.Services.AddInfrastructure(builder.Configuration);");
            code.AppendLine();
            
            // æ„å»ºåº”ç”¨
            code.AppendLine("var app = builder.Build();");
            code.AppendLine();
            
            code.AppendLine("app.MapDefaultEndpoints();");
            code.AppendLine("app.MapControllers();");
            code.AppendLine("app.MapHealthChecks(\"/health\");");
            code.AppendLine();
            
            code.AppendLine("app.Run();");
            
            return code.ToString();
        }
    }
}
```

### æ­¥éª¤5ï¼šè¿è¡Œç¤ºä¾‹

**examples/backend-definition.json**

```json
{
  "name": "UserManagement",
  "namespace": "MyCompany.UserManagement",
  "boundedContext": "Identity",
  "aggregate": {
    "name": "User",
    "description": "ç”¨æˆ·èšåˆæ ¹",
    "properties": [
      {
        "name": "UserName",
        "type": "string",
        "isRequired": true,
        "maxLength": 256
      },
      {
        "name": "Email",
        "type": "string",
        "isRequired": true,
        "isUnique": true
      },
      {
        "name": "PhoneNumber",
        "type": "string",
        "isRequired": false
      }
    ],
    "valueObjects": [
      {
        "name": "Address",
        "properties": [
          {
            "name": "Street",
            "type": "string"
          },
          {
            "name": "City",
            "type": "string"
          },
          {
            "name": "ZipCode",
            "type": "string"
          }
        ]
      }
    ],
    "domainEvents": [
      {
        "name": "UserCreatedEvent",
        "properties": [
          {
            "name": "UserId",
            "type": "Guid"
          },
          {
            "name": "UserName",
            "type": "string"
          }
        ]
      }
    ],
    "specifications": [
      {
        "name": "ActiveUserSpecification",
        "condition": "x => x.IsActive && !x.IsDeleted"
      }
    ]
  },
  "application": {
    "commands": [
      {
        "name": "CreateUser",
        "returnType": "UserDto",
        "properties": [
          {
            "name": "UserName",
            "type": "string"
          },
          {
            "name": "Email",
            "type": "string"
          }
        ]
      }
    ],
    "queries": [
      {
        "name": "GetUserList",
        "returnType": "PagedResultDto<UserDto>",
        "isPaged": true,
        "isCacheable": true,
        "filters": [
          {
            "name": "Filter",
            "type": "string",
            "property": "UserName",
            "isContains": true
          }
        ]
      }
    ]
  },
  "infrastructure": {
    "database": "PostgreSQL",
    "cache": "Redis",
    "messageQueue": "RabbitMQ",
    "search": "Elasticsearch"
  },
  "microservice": {
    "enableDapr": true,
    "enableAspire": true,
    "replicas": 3
  }
}
```

**æ‰§è¡Œå‘½ä»¤**

```bash
# ç”Ÿæˆåç«¯ä»£ç 
dotnet run --project packages/backend-generator -- generate examples/backend-definition.json --output ./generated

# æ„å»ºç”Ÿæˆçš„é¡¹ç›®
cd generated
dotnet build

# è¿è¡ŒAspireåº”ç”¨
dotnet run --project AspireHost
```

## æ€»ç»“

è¿™ä¸ªP1é˜¶æ®µå®ç°å±•ç¤ºäº†ï¼š

1. **é¡¶å°–çš„CLRä¼˜åŒ–æŠ€æœ¯** - å†…å­˜æ± ã€å¯¹è±¡æ± ã€JITé¢„çƒ­
2. **å®Œæ•´çš„DDDå®ç°** - èšåˆæ ¹ã€å€¼å¯¹è±¡ã€é¢†åŸŸäº‹ä»¶ã€è§„çº¦æ¨¡å¼
3. **CQRSä¸MediatR** - å‘½ä»¤æŸ¥è¯¢åˆ†ç¦»ã€ç®¡é“è¡Œä¸º
4. **é«˜æ€§èƒ½æ¶æ„** - TPL Dataflowã€å¼‚æ­¥æµã€ç¼“å­˜ç­–ç•¥
5. **Aspireæœ€ä½³å®è·µ** - æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ã€åˆ†å¸ƒå¼è¿½è¸ª
6. **åˆ†å¸ƒå¼ç³»ç»Ÿ** - Dapré›†æˆã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼äº‹åŠ¡

æ‰€æœ‰ä»£ç éƒ½æ˜¯ç”Ÿäº§çº§çš„ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚éœ€è¦ç»§ç»­P2é˜¶æ®µçš„å¯è§†åŒ–è®¾è®¡å™¨å®ç°å—ï¼Ÿ