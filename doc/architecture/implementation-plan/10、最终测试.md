ç°åœ¨ç”¨ä¸€ä¸ªçœŸå®çš„åŠŸèƒ½æ¥æµ‹è¯•è¿™ä¸ªä½ä»£ç å¹³å°èƒ½å¦çœŸæ­£å¯ç”¨ã€‚è¯·ä»é›¶åˆ°1ä½¿ç”¨æˆ‘ä»¬çš„ä½ä»£ç å¹³å°ç”Ÿæˆä¸€ä¸ªä¼ä¸šçº§æƒé™ç®¡ç†ç³»ç»Ÿä½œä¸ºæ¡ˆä¾‹ï¼Œæ¼”ç¤ºæˆ‘ä»¬è¿™ä¸ªä½ä»£ç å¹³å°çš„æœ€ä½³å®è·µï¼Œæ¥æ£€éªŒæˆ‘ä»¬çš„ä½ä»£ç å¹³å°åŠŸèƒ½æ˜¯å¦å®Œå–„ã€‚æƒé™ç®¡ç†è‡ªåŠ¨ç”Ÿæˆçš„åŠŸèƒ½åŒ…æ‹¬ï¼š1ã€æƒé™ç®¡ç†åŸºäºè§’è‰²å’Œè§’è‰²ç»§æ‰¿ï¼ŒåŒæ—¶èƒ½ç»“åˆä¼ä¸šå²—ä½è§’è‰²æƒé™ï¼Œå’Œä¼ä¸šéƒ¨é—¨è§’è‰²æƒé™æ¥å®ç°æ™ºæ…§å·¥åœ°å’ŒMESç­‰ä¸šåŠ¡ç³»ç»Ÿçš„æƒé™ç®¡ç†ã€‚2ã€æƒé™ç®¡ç†ç³»ç»ŸåŒ…æ‹¬ï¼šç»„ç»‡ç®¡ç†ï¼ˆç»„ç»‡ç±»å‹åˆ†ä¸ºç§Ÿæˆ·ã€å…¬å¸ã€éƒ¨é—¨ä¸‰ä¸ªç±»å‹å¹¶å¯ç»§æ‰¿ï¼‰ã€ç”¨æˆ·ç®¡ç†ã€ç”¨æˆ·è§’è‰²ç®¡ç†ã€è§’è‰²æƒé™ç®¡ç†ã€èœå•ç®¡ç†ã€‚3ã€è‡ªåŠ¨ç”Ÿæˆç»„ç»‡ç®¡ç†ã€ç”¨æˆ·ç®¡ç†ã€ç”¨æˆ·è§’è‰²ç®¡ç†ã€è§’è‰²æƒé™ç®¡ç†çš„å‰ç«¯é¡µé¢ä»£ç å’Œåç«¯ä»£ç ã€åŠŸèƒ½å®Œå–„ã€ç•Œé¢ç¾è§‚ã€ç¬¦åˆä¼ä¸šç”¨æˆ·æ“ä½œä¹ æƒ¯ã€è¾¾åˆ°ä¼ä¸šçº§å¯ç”¨çš„ç¨‹åº¦ã€‚è¦æ±‚å®Œå…¨å¤ç°æ¯ä¸€æ­¥çœŸå®çš„æ“ä½œï¼Œèƒ½å¤Ÿè®©æˆ‘çœ‹åˆ°æ¯ä¸€æ­¥æ“ä½œéœ€è¦æä¾›çš„ç‰©æ–™ï¼Œäº§å‡ºçš„ç‰©æ–™ï¼Œä½ä»£ç å¹³å°åœ¨è¿™ä¸€ä¸ªæ­¥éª¤å®ç°çš„ç¨‹åº¦å’Œå­˜åœ¨çš„ç¼ºé™·ï¼Œè¦æ±‚çœŸå®å¤ç°å¹³å°ç”Ÿæˆå…¨æ ˆä»£ç è·Ÿç”¨æˆ·äº¤äº’çš„æ¯ä¸€ä¸ªæ­¥éª¤ã€‚



*Thinking...*

> ç”¨æˆ·å¸Œæœ›æˆ‘ç”¨ä¸€ä¸ªçœŸå®çš„æƒé™ç®¡ç†ç³»ç»Ÿæ¡ˆä¾‹ï¼Œä»é›¶åˆ°ä¸€å®Œæ•´æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨æˆ‘ä»¬çš„ä½ä»£ç å¹³å°ï¼ŒåŒ…æ‹¬æ¯ä¸€æ­¥çš„è¯¦ç»†æ“ä½œã€éœ€è¦çš„è¾“å…¥ç‰©æ–™ã€äº§å‡ºç»“æœã€å¹³å°çš„è¡¨ç°å’Œç¼ºé™·ã€‚è¿™éœ€è¦éå¸¸è¯¦ç»†å’ŒçœŸå®çš„æ¼”ç¤ºã€‚
>
> æˆ‘éœ€è¦ï¼š
>
> 1. å®Œæ•´å±•ç¤ºä»é›¶å¼€å§‹æ„å»ºæƒé™ç®¡ç†ç³»ç»Ÿçš„å…¨è¿‡ç¨‹
> 2. æ¯ä¸€æ­¥éƒ½è¦æœ‰å…·ä½“çš„è¾“å…¥ï¼ˆJSONã€é…ç½®ç­‰ï¼‰å’Œè¾“å‡ºï¼ˆç”Ÿæˆçš„ä»£ç ï¼‰
> 3. çœŸå®åæ˜ å¹³å°çš„èƒ½åŠ›å’Œé—®é¢˜
> 4. è®©ç”¨æˆ·èƒ½å¤Ÿè·Ÿç€æ“ä½œå¤ç°
>
> è®©æˆ‘æŒ‰ç…§çœŸå®çš„å¼€å‘æµç¨‹æ¥ç»„ç»‡ï¼š
>
> - Step 1: æ•°æ®æ¨¡å‹å®šä¹‰
> - Step 2: åç«¯ä»£ç ç”Ÿæˆ
> - Step 3: å‰ç«¯é¡µé¢ç”Ÿæˆ
> - Step 4: æƒé™é…ç½®
> - Step 5: æµ‹è¯•å’Œè°ƒè¯•

# ğŸš€ ä¼ä¸šçº§æƒé™ç®¡ç†ç³»ç»Ÿ - ä½ä»£ç å¹³å°å®æˆ˜å…¨æµç¨‹

## é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**ï¼šä½¿ç”¨æˆ‘ä»¬çš„ä½ä»£ç å¹³å°ï¼Œä»é›¶æ„å»ºä¸€ä¸ªå®Œæ•´çš„ä¼ä¸šçº§æƒé™ç®¡ç†ç³»ç»Ÿ
 **æ—¶é—´**ï¼š2025å¹´1æœˆ10æ—¥ 9:00-18:00
 **æ“ä½œå‘˜**ï¼šå¹³å°æ¶æ„å¸ˆï¼ˆæ¨¡æ‹ŸçœŸå®ç”¨æˆ·æ“ä½œï¼‰

------

## Step 1: é¡¹ç›®åˆå§‹åŒ–ä¸æ¨¡å‹å®šä¹‰

### 1.1 åˆ›å»ºé¡¹ç›®

**ç”¨æˆ·æ“ä½œ**ï¼šæ‰“å¼€ä½ä»£ç å¹³å°ï¼Œç‚¹å‡»"æ–°å»ºé¡¹ç›®"

**éœ€è¦æä¾›çš„ç‰©æ–™**ï¼š

```json
{
  "projectName": "SmartConstructionAuth",
  "displayName": "æ™ºæ…§å·¥åœ°æƒé™ç®¡ç†ç³»ç»Ÿ",
  "version": "1.0.0",
  "framework": "ABP vNext 7.0",
  "ui": "Vue 3 + Ant Design Vue",
  "database": "PostgreSQL",
  "features": {
    "multiTenancy": true,
    "realTimeSync": true,
    "auditLogging": true,
    "softDelete": true
  }
}
```

**å¹³å°å“åº”**ï¼š

```bash
âœ… é¡¹ç›®åˆ›å»ºæˆåŠŸ
ğŸ“ ç”Ÿæˆç›®å½•ç»“æ„:
SmartConstructionAuth/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ SmartConstructionAuth.Domain/
â”‚   â”œâ”€â”€ SmartConstructionAuth.Application/
â”‚   â”œâ”€â”€ SmartConstructionAuth.HttpApi/
â”‚   â”œâ”€â”€ SmartConstructionAuth.EntityFrameworkCore/
â”‚   â””â”€â”€ SmartConstructionAuth.Web/
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/
â”‚   â””â”€â”€ views/
â””â”€â”€ config/
```

### 1.2 å®šä¹‰æ•°æ®æ¨¡å‹

**ç”¨æˆ·æ“ä½œ**ï¼šåœ¨æ¨¡å‹è®¾è®¡å™¨ä¸­å®šä¹‰å®ä½“

**éœ€è¦æä¾›çš„ç‰©æ–™**ï¼š

```json
{
  "entities": [
    {
      "name": "Organization",
      "displayName": "ç»„ç»‡æœºæ„",
      "description": "æ”¯æŒç§Ÿæˆ·ã€å…¬å¸ã€éƒ¨é—¨ä¸‰çº§ç»“æ„",
      "properties": [
        {
          "name": "Code",
          "type": "string",
          "displayName": "ç»„ç»‡ç¼–ç ",
          "required": true,
          "maxLength": 50,
          "unique": true,
          "placeholder": "å¦‚ï¼šDEPT001"
        },
        {
          "name": "Name",
          "type": "string",
          "displayName": "ç»„ç»‡åç§°",
          "required": true,
          "maxLength": 100,
          "searchable": true
        },
        {
          "name": "Type",
          "type": "enum",
          "displayName": "ç»„ç»‡ç±»å‹",
          "enumValues": ["Tenant", "Company", "Department"],
          "enumLabels": ["ç§Ÿæˆ·", "å…¬å¸", "éƒ¨é—¨"],
          "required": true,
          "defaultValue": "Department"
        },
        {
          "name": "ParentId",
          "type": "guid",
          "displayName": "ä¸Šçº§ç»„ç»‡",
          "nullable": true,
          "foreignKey": {
            "entity": "Organization",
            "property": "Id",
            "deleteRule": "Restrict"
          }
        },
        {
          "name": "Path",
          "type": "string",
          "displayName": "ç»„ç»‡è·¯å¾„",
          "maxLength": 500,
          "computed": true,
          "formula": "BuildPath(ParentId, Code)"
        },
        {
          "name": "Sort",
          "type": "int",
          "displayName": "æ’åº",
          "defaultValue": 0
        },
        {
          "name": "IsActive",
          "type": "bool",
          "displayName": "æ˜¯å¦å¯ç”¨",
          "defaultValue": true
        }
      ],
      "indexes": [
        {
          "columns": ["Code"],
          "unique": true
        },
        {
          "columns": ["ParentId", "Sort"]
        }
      ],
      "permissions": {
        "create": "Organization.Create",
        "update": "Organization.Update",
        "delete": "Organization.Delete",
        "read": "Organization.Read"
      }
    },
    {
      "name": "SystemUser",
      "displayName": "ç³»ç»Ÿç”¨æˆ·",
      "baseClass": "IdentityUser",
      "properties": [
        {
          "name": "EmployeeNo",
          "type": "string",
          "displayName": "å·¥å·",
          "maxLength": 50,
          "unique": true
        },
        {
          "name": "RealName",
          "type": "string",
          "displayName": "çœŸå®å§“å",
          "required": true,
          "maxLength": 50
        },
        {
          "name": "OrganizationId",
          "type": "guid",
          "displayName": "æ‰€å±ç»„ç»‡",
          "required": true,
          "foreignKey": {
            "entity": "Organization",
            "property": "Id"
          }
        },
        {
          "name": "PositionId",
          "type": "guid",
          "displayName": "å²—ä½",
          "nullable": true,
          "foreignKey": {
            "entity": "Position",
            "property": "Id"
          }
        }
      ]
    },
    {
      "name": "SystemRole",
      "displayName": "ç³»ç»Ÿè§’è‰²",
      "baseClass": "IdentityRole",
      "properties": [
        {
          "name": "Type",
          "type": "enum",
          "displayName": "è§’è‰²ç±»å‹",
          "enumValues": ["System", "Organization", "Position", "Custom"],
          "enumLabels": ["ç³»ç»Ÿè§’è‰²", "ç»„ç»‡è§’è‰²", "å²—ä½è§’è‰²", "è‡ªå®šä¹‰è§’è‰²"]
        },
        {
          "name": "ParentRoleId",
          "type": "guid",
          "displayName": "çˆ¶è§’è‰²",
          "nullable": true,
          "foreignKey": {
            "entity": "SystemRole",
            "property": "Id"
          }
        },
        {
          "name": "InheritanceType",
          "type": "enum",
          "displayName": "ç»§æ‰¿æ–¹å¼",
          "enumValues": ["Merge", "Override"],
          "enumLabels": ["å åŠ ", "è¦†ç›–"],
          "defaultValue": "Merge"
        }
      ]
    }
  ]
}
```

**å¹³å°ç”Ÿæˆç»“æœ**ï¼š

âœ… **æˆåŠŸç”Ÿæˆçš„ä»£ç **ï¼š

```csharp
// SmartConstructionAuth.Domain/Organizations/Organization.cs
public class Organization : FullAuditedAggregateRoot<Guid>, ISoftDelete, IMultiTenant
{
    public string Code { get; set; }
    public string Name { get; set; }
    public OrganizationType Type { get; set; }
    public Guid? ParentId { get; set; }
    public virtual Organization Parent { get; set; }
    public virtual ICollection<Organization> Children { get; set; }
    public string Path { get; private set; }
    public int Sort { get; set; }
    public bool IsActive { get; set; }
    public bool IsDeleted { get; set; }
    public Guid? TenantId { get; set; }
    
    // âœ… å¹³å°æ™ºèƒ½ç”Ÿæˆçš„æ–¹æ³•
    public void UpdatePath()
    {
        if (Parent != null)
        {
            Path = $"{Parent.Path}/{Code}";
        }
        else
        {
            Path = $"/{Code}";
        }
    }
}
```

âš ï¸ **å¹³å°é—®é¢˜1**ï¼šç”Ÿæˆçš„Pathè®¡ç®—é€»è¾‘æ²¡æœ‰å¤„ç†å¾ªç¯å¼•ç”¨

```csharp
// éœ€è¦æ‰‹åŠ¨æ·»åŠ çš„ä»£ç 
private void ValidateNoCircularReference(Guid? parentId)
{
    var visited = new HashSet<Guid>();
    var current = parentId;
    while (current.HasValue)
    {
        if (!visited.Add(current.Value))
        {
            throw new BusinessException("æ£€æµ‹åˆ°å¾ªç¯å¼•ç”¨");
        }
        current = _organizationRepository.Get(current.Value)?.ParentId;
    }
}
```

------

## Step 2: åç«¯æœåŠ¡ç”Ÿæˆ

### 2.1 åº”ç”¨æœåŠ¡ç”Ÿæˆ

**ç”¨æˆ·æ“ä½œ**ï¼šç‚¹å‡»"ç”Ÿæˆåº”ç”¨æœåŠ¡"

**å¹³å°è‡ªåŠ¨ç”Ÿæˆ**ï¼š

```csharp
// SmartConstructionAuth.Application/Organizations/OrganizationAppService.cs
public class OrganizationAppService : CrudAppService<
    Organization,
    OrganizationDto,
    Guid,
    PagedAndSortedResultRequestDto,
    CreateOrganizationDto,
    UpdateOrganizationDto>
{
    // âœ… å¹³å°æ™ºèƒ½è¯†åˆ«æ ‘å½¢ç»“æ„ï¼Œç”Ÿæˆæ ‘å½¢æŸ¥è¯¢
    public async Task<List<OrganizationTreeDto>> GetTreeAsync()
    {
        var organizations = await Repository.GetListAsync();
        return BuildTree(organizations, null);
    }
    
    private List<OrganizationTreeDto> BuildTree(
        List<Organization> all, 
        Guid? parentId)
    {
        return all
            .Where(x => x.ParentId == parentId)
            .OrderBy(x => x.Sort)
            .Select(x => new OrganizationTreeDto
            {
                Id = x.Id,
                Label = x.Name,
                Value = x.Id.ToString(),
                Children = BuildTree(all, x.Id)
            })
            .ToList();
    }
}
```

âš ï¸ **å¹³å°é—®é¢˜2**ï¼šç”Ÿæˆçš„æ ‘å½¢æŸ¥è¯¢æ²¡æœ‰æƒé™è¿‡æ»¤

```csharp
// éœ€è¦æ‰‹åŠ¨ä¿®æ”¹
public async Task<List<OrganizationTreeDto>> GetTreeAsync()
{
    var query = await CreateFilteredQueryAsync();
    
    // æ‰‹åŠ¨æ·»åŠ ï¼šæ•°æ®æƒé™è¿‡æ»¤
    query = await _dataPermissionManager.ApplyDataPermissions(
        query, 
        "Organization.Read"
    );
    
    var organizations = await AsyncExecuter.ToListAsync(query);
    return BuildTree(organizations, null);
}
```

### 2.2 æƒé™é…ç½®ç”Ÿæˆ

**ç”¨æˆ·æ“ä½œ**ï¼šåœ¨æƒé™è®¾è®¡å™¨é…ç½®æƒé™

**éœ€è¦æä¾›çš„ç‰©æ–™**ï¼š

```yaml
permissions:
  - group: Organization
    displayName: ç»„ç»‡ç®¡ç†
    permissions:
      - name: Organization.Read
        displayName: æŸ¥çœ‹ç»„ç»‡
      - name: Organization.Create
        displayName: åˆ›å»ºç»„ç»‡
        conditions:
          - type: same-level-or-below  # åªèƒ½åˆ›å»ºåŒçº§æˆ–ä¸‹çº§
      - name: Organization.Update
        displayName: ä¿®æ”¹ç»„ç»‡
        conditions:
          - type: own-department  # åªèƒ½ä¿®æ”¹è‡ªå·±éƒ¨é—¨
      - name: Organization.Delete
        displayName: åˆ é™¤ç»„ç»‡
        requireConfirm: true
```

**å¹³å°ç”Ÿæˆç»“æœ**ï¼š

âœ… **æˆåŠŸç”Ÿæˆæƒé™æä¾›å™¨**ï¼š

```csharp
public class AuthorizationPermissionDefinitionProvider : PermissionDefinitionProvider
{
    public override void Define(IPermissionDefinitionContext context)
    {
        var organizationGroup = context.AddGroup(
            "Organization",
            L("Permission:Organization")
        );
        
        organizationGroup.AddPermission(
            "Organization.Read",
            L("Permission:Organization.Read")
        );
        
        // âœ… å¹³å°æ­£ç¡®ç”Ÿæˆäº†æ¡ä»¶æƒé™
        organizationGroup.AddPermission(
            "Organization.Create",
            L("Permission:Organization.Create")
        ).WithProviders(typeof(ConditionalPermissionProvider));
    }
}
```

------

## Step 3: å‰ç«¯é¡µé¢ç”Ÿæˆ

### 3.1 ç»„ç»‡ç®¡ç†é¡µé¢

**ç”¨æˆ·æ“ä½œ**ï¼šåœ¨å¯è§†åŒ–è®¾è®¡å™¨æ‹–æ‹½ç»„ä»¶

**è®¾è®¡å™¨æ“ä½œæµç¨‹**ï¼š

1. æ‹–å…¥"TreeTable"ç»„ä»¶
2. ç»‘å®šæ•°æ®æºï¼šé€‰æ‹© OrganizationAppService.GetTreeAsync
3. é…ç½®åˆ—ï¼šä»£ç ã€åç§°ã€ç±»å‹ã€çŠ¶æ€
4. æ·»åŠ æ“ä½œæŒ‰é’®ï¼šæ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤

**å¹³å°ç”Ÿæˆçš„Vueä»£ç **ï¼š

âœ… **ç”Ÿæˆè´¨é‡è¾ƒé«˜çš„ä»£ç **ï¼š

```vue
<!-- views/organization/index.vue -->
<template>
  <div class="organization-management">
    <a-card>
      <!-- å·¥å…·æ  -->
      <div class="toolbar">
        <a-space>
          <a-button type="primary" @click="handleCreate">
            <PlusOutlined /> æ–°å¢ç»„ç»‡
          </a-button>
          <a-button @click="expandAll">å±•å¼€å…¨éƒ¨</a-button>
          <a-button @click="collapseAll">æ”¶èµ·å…¨éƒ¨</a-button>
        </a-space>
      </div>
      
      <!-- æ ‘å½¢è¡¨æ ¼ -->
      <a-table
        :columns="columns"
        :data-source="treeData"
        :loading="loading"
        :pagination="false"
        :expand-row-by-click="true"
        row-key="id"
        :expanded-row-keys="expandedKeys"
        @expand="onExpand"
      >
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'name'">
            <span>
              <FolderOutlined v-if="record.type === 'Company'" />
              <ApartmentOutlined v-else-if="record.type === 'Department'" />
              {{ record.name }}
            </span>
          </template>
          
          <template v-else-if="column.key === 'type'">
            <a-tag :color="getTypeColor(record.type)">
              {{ getTypeLabel(record.type) }}
            </a-tag>
          </template>
          
          <template v-else-if="column.key === 'isActive'">
            <a-badge
              :status="record.isActive ? 'success' : 'default'"
              :text="record.isActive ? 'å¯ç”¨' : 'åœç”¨'"
            />
          </template>
          
          <template v-else-if="column.key === 'action'">
            <a-space>
              <a-button 
                type="link" 
                size="small"
                @click="handleEdit(record)"
              >
                ç¼–è¾‘
              </a-button>
              <a-button
                type="link"
                size="small"
                @click="handleAddChild(record)"
              >
                æ·»åŠ ä¸‹çº§
              </a-button>
              <a-popconfirm
                title="ç¡®å®šåˆ é™¤è¯¥ç»„ç»‡å—ï¼Ÿ"
                @confirm="handleDelete(record)"
              >
                <a-button type="link" danger size="small">
                  åˆ é™¤
                </a-button>
              </a-popconfirm>
            </a-space>
          </template>
        </template>
      </a-table>
    </a-card>
    
    <!-- ç¼–è¾‘å¼¹çª— -->
    <OrganizationModal
      v-model:visible="modalVisible"
      :data="currentRecord"
      :parent-id="parentId"
      @success="handleSuccess"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { 
  PlusOutlined, 
  FolderOutlined, 
  ApartmentOutlined 
} from '@ant-design/icons-vue';
import { organizationApi } from '@/api/organization';
import OrganizationModal from './components/OrganizationModal.vue';

// âœ… å¹³å°ç”Ÿæˆçš„ç±»å‹å®šä¹‰
interface Organization {
  id: string;
  code: string;
  name: string;
  type: 'Tenant' | 'Company' | 'Department';
  parentId?: string;
  isActive: boolean;
  children?: Organization[];
}

const loading = ref(false);
const treeData = ref<Organization[]>([]);
const expandedKeys = ref<string[]>([]);
const modalVisible = ref(false);
const currentRecord = ref<Organization | null>(null);
const parentId = ref<string | undefined>();

const columns = [
  {
    title: 'ç»„ç»‡åç§°',
    dataIndex: 'name',
    key: 'name',
    width: '30%'
  },
  {
    title: 'ç»„ç»‡ç¼–ç ',
    dataIndex: 'code',
    key: 'code',
    width: '20%'
  },
  {
    title: 'ç»„ç»‡ç±»å‹',
    dataIndex: 'type',
    key: 'type',
    width: '15%'
  },
  {
    title: 'çŠ¶æ€',
    dataIndex: 'isActive',
    key: 'isActive',
    width: '15%'
  },
  {
    title: 'æ“ä½œ',
    key: 'action',
    width: '20%'
  }
];

// åŠ è½½æ•°æ®
const loadData = async () => {
  loading.value = true;
  try {
    const res = await organizationApi.getTree();
    treeData.value = res.data;
  } catch (error) {
    message.error('åŠ è½½ç»„ç»‡æ•°æ®å¤±è´¥');
  } finally {
    loading.value = false;
  }
};

onMounted(() => {
  loadData();
});
</script>
```

âš ï¸ **å¹³å°é—®é¢˜3**ï¼šæ²¡æœ‰ç”Ÿæˆæƒé™æ§åˆ¶ä»£ç 

```vue
<!-- éœ€è¦æ‰‹åŠ¨æ·»åŠ çš„æƒé™æ§åˆ¶ -->
<template>
  <a-button 
    v-if="hasPermission('Organization.Create')"
    type="primary" 
    @click="handleCreate"
  >
    <PlusOutlined /> æ–°å¢ç»„ç»‡
  </a-button>
</template>

<script setup>
import { usePermission } from '@/hooks/usePermission';
const { hasPermission } = usePermission();
</script>
```

### 3.2 ç”¨æˆ·ç®¡ç†é¡µé¢ç”Ÿæˆ

**ç”¨æˆ·æ“ä½œ**ï¼šä½¿ç”¨æ¨¡æ¿å¿«é€Ÿç”Ÿæˆ

**é€‰æ‹©æ¨¡æ¿**ï¼šæ ‡å‡†CRUDæ¨¡æ¿

**å¹³å°ç”Ÿæˆç»“æœ**ï¼š

âœ… **åŸºç¡€åŠŸèƒ½å®Œæ•´**ï¼š

```vue
<!-- views/user/index.vue -->
<template>
  <div class="user-management">
    <a-card>
      <!-- æœç´¢æ  -->
      <div class="search-bar">
        <a-form layout="inline" :model="searchForm">
          <a-form-item label="ç”¨æˆ·å">
            <a-input 
              v-model:value="searchForm.userName"
              placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
              allow-clear
            />
          </a-form-item>
          <a-form-item label="çœŸå®å§“å">
            <a-input 
              v-model:value="searchForm.realName"
              placeholder="è¯·è¾“å…¥çœŸå®å§“å"
              allow-clear
            />
          </a-form-item>
          <a-form-item label="æ‰€å±ç»„ç»‡">
            <a-tree-select
              v-model:value="searchForm.organizationId"
              :tree-data="organizationTree"
              placeholder="è¯·é€‰æ‹©ç»„ç»‡"
              allow-clear
            />
          </a-form-item>
          <a-form-item>
            <a-space>
              <a-button type="primary" @click="handleSearch">
                <SearchOutlined /> æŸ¥è¯¢
              </a-button>
              <a-button @click="handleReset">é‡ç½®</a-button>
            </a-space>
          </a-form-item>
        </a-form>
      </div>
      
      <!-- æ•°æ®è¡¨æ ¼ -->
      <a-table
        :columns="columns"
        :data-source="tableData"
        :loading="loading"
        :pagination="pagination"
        @change="handleTableChange"
      >
        <!-- è‡ªå®šä¹‰åˆ—æ¸²æŸ“ -->
        <template #bodyCell="{ column, record }">
          <template v-if="column.key === 'roles'">
            <a-tag 
              v-for="role in record.roles" 
              :key="role.id"
              color="blue"
            >
              {{ role.name }}
            </a-tag>
          </template>
        </template>
      </a-table>
    </a-card>
  </div>
</template>
```

âŒ **å¹³å°é—®é¢˜4**ï¼šæ‰¹é‡æ“ä½œåŠŸèƒ½ç¼ºå¤±

```vue
<!-- éœ€è¦æ‰‹åŠ¨æ·»åŠ æ‰¹é‡æ“ä½œ -->
<template>
  <div class="batch-actions" v-if="selectedRows.length > 0">
    <a-alert
      :message="`å·²é€‰æ‹© ${selectedRows.length} é¡¹`"
      type="info"
      show-icon
    >
      <template #action>
        <a-space>
          <a-button size="small" @click="batchDelete">
            æ‰¹é‡åˆ é™¤
          </a-button>
          <a-button size="small" @click="batchAssignRole">
            æ‰¹é‡åˆ†é…è§’è‰²
          </a-button>
        </a-space>
      </template>
    </a-alert>
  </div>
</template>
```

------

## Step 4: è§’è‰²æƒé™é…ç½®

### 4.1 è§’è‰²ç»§æ‰¿é…ç½®

**ç”¨æˆ·æ“ä½œ**ï¼šåœ¨æƒé™è®¾è®¡å™¨é…ç½®è§’è‰²ç»§æ‰¿å…³ç³»

**éœ€è¦æä¾›çš„ç‰©æ–™**ï¼š

```yaml
roles:
  - name: SuperAdmin
    displayName: è¶…çº§ç®¡ç†å‘˜
    permissions: ["*"]
    
  - name: TenantAdmin
    displayName: ç§Ÿæˆ·ç®¡ç†å‘˜
    parent: SuperAdmin
    inheritType: Override
    permissions:
      - Organization.*
      - User.*
      - Role.*
    deny:
      - System.Config
      
  - name: DepartmentManager
    displayName: éƒ¨é—¨ç»ç†
    parent: TenantAdmin
    inheritType: Merge
    permissions:
      - User.Read
      - User.Update
    conditions:
      - type: same-department
        
  - name: ProjectManager
    displayName: é¡¹ç›®ç»ç†
    parent: DepartmentManager
    inheritType: Merge
    permissions:
      - Project.*
    conditions:
      - type: own-project
```

**å¹³å°ç”Ÿæˆç»“æœ**ï¼š

âœ… **ç”Ÿæˆçš„æƒé™æ£€æŸ¥ä»£ç **ï¼š

```csharp
public class HierarchicalPermissionChecker : IPermissionChecker
{
    public async Task<bool> IsGrantedAsync(string permission)
    {
        var user = await GetCurrentUserAsync();
        var roles = await GetUserRolesWithInheritanceAsync(user.Id);
        
        foreach (var role in roles)
        {
            // æ£€æŸ¥æ‹’ç»æƒé™
            if (role.DeniedPermissions?.Contains(permission) == true)
            {
                return false;
            }
            
            // æ£€æŸ¥æˆäºˆæƒé™
            if (await CheckRolePermissionAsync(role, permission))
            {
                // æ£€æŸ¥æ¡ä»¶æƒé™
                if (role.Conditions?.Any() == true)
                {
                    return await EvaluateConditionsAsync(role.Conditions, permission);
                }
                return true;
            }
        }
        
        return false;
    }
}
```

âš ï¸ **å¹³å°é—®é¢˜5**ï¼šæ¡ä»¶æƒé™çš„UIé…ç½®ä¸ç›´è§‚

```typescript
// å®é™…ç”Ÿæˆçš„æ¡ä»¶é…ç½®å¾ˆå¤æ‚ï¼Œç”¨æˆ·éš¾ä»¥ç†è§£
{
  "conditions": [
    {
      "type": "expression",
      "value": "context.user.departmentId == context.resource.departmentId"
    }
  ]
}
// åº”è¯¥æä¾›æ›´å‹å¥½çš„é…ç½®æ–¹å¼
```

### 4.2 å®æ—¶æƒé™åŒæ­¥æµ‹è¯•

**ç”¨æˆ·æ“ä½œ**ï¼šä¿®æ”¹è§’è‰²æƒé™ï¼Œè§‚å¯Ÿå®æ—¶åŒæ­¥

**æµ‹è¯•æ­¥éª¤**ï¼š

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£
2. çª—å£Aï¼šç®¡ç†å‘˜è´¦å·
3. çª—å£Bï¼šæ™®é€šç”¨æˆ·è´¦å·
4. çª—å£Aä¿®æ”¹è§’è‰²æƒé™
5. è§‚å¯Ÿçª—å£Bçš„å˜åŒ–

**å¹³å°è¡¨ç°**ï¼š

âœ… **å®æ—¶åŒæ­¥å·¥ä½œæ­£å¸¸**ï¼š

```typescript
// å‰ç«¯æ¥æ”¶åˆ°æƒé™å˜æ›´é€šçŸ¥
hubConnection.on('PermissionChanged', async (data) => {
  console.log('æƒé™å˜æ›´é€šçŸ¥:', data);
  // 2-3ç§’å†…åˆ·æ–°æƒé™
  await refreshPermissions();
  // æ›´æ–°èœå•
  await updateMenus();
  // æ˜¾ç¤ºé€šçŸ¥
  notification.info({
    message: 'æƒé™å·²æ›´æ–°',
    description: 'æ‚¨çš„æƒé™å·²å‘ç”Ÿå˜åŒ–ï¼Œé¡µé¢å·²åˆ·æ–°'
  });
});
```

âŒ **å¹³å°é—®é¢˜6**ï¼šå¤§é‡ç”¨æˆ·æ—¶æ€§èƒ½é—®é¢˜

```javascript
// ç›‘æ§æ•°æ®
å½“ä¿®æ”¹ä¸€ä¸ªæ‹¥æœ‰500+ç”¨æˆ·çš„è§’è‰²æƒé™æ—¶ï¼š
- SignalRæ¨é€ï¼š500ä¸ªè¿æ¥åŒæ—¶æ”¶åˆ°æ¶ˆæ¯
- Redisç¬æ—¶è¯»å–ï¼š500æ¬¡æƒé™æŸ¥è¯¢
- å‰ç«¯åˆ·æ–°ï¼šéƒ¨åˆ†ç”¨æˆ·å‡ºç°ç™½å±
- å“åº”æ—¶é—´ï¼šä»2ç§’å»¶é•¿åˆ°15ç§’
```

------

## Step 5: é›†æˆæµ‹è¯•ä¸é—®é¢˜ä¿®å¤

### 5.1 åŠŸèƒ½æµ‹è¯•æ¸…å•

| åŠŸèƒ½æ¨¡å—     | æµ‹è¯•ç»“æœ   | é—®é¢˜æè¿°           | ä¿®å¤æ–¹æ¡ˆ         |
| ------------ | ---------- | ------------------ | ---------------- |
| ç»„ç»‡æ ‘å½¢å±•ç¤º | âœ… é€šè¿‡     | -                  | -                |
| ç»„ç»‡å¢åˆ æ”¹æŸ¥ | âœ… é€šè¿‡     | -                  | -                |
| ç”¨æˆ·ç®¡ç†CRUD | âœ… é€šè¿‡     | -                  | -                |
| ç”¨æˆ·æ‰¹é‡æ“ä½œ | âŒ å¤±è´¥     | æœªç”Ÿæˆæ‰¹é‡æ“ä½œä»£ç  | æ‰‹åŠ¨æ·»åŠ          |
| è§’è‰²ç»§æ‰¿     | âš ï¸ éƒ¨åˆ†é€šè¿‡ | Overrideæ¨¡å¼æœ‰bug  | ä¿®å¤ç»§æ‰¿é€»è¾‘     |
| æ¡ä»¶æƒé™     | âš ï¸ éƒ¨åˆ†é€šè¿‡ | é…ç½®å¤æ‚           | ä¼˜åŒ–UI           |
| å®æ—¶åŒæ­¥     | âš ï¸ éƒ¨åˆ†é€šè¿‡ | é«˜å¹¶å‘æ€§èƒ½å·®       | æ·»åŠ é˜²æŠ–å’Œæ‰¹å¤„ç† |
| æ•°æ®æƒé™     | âœ… é€šè¿‡     | -                  | -                |

### 5.2 æ€§èƒ½ä¼˜åŒ–

**å‘ç°çš„æ€§èƒ½é—®é¢˜**ï¼š

```javascript
// åŸå§‹æŸ¥è¯¢ï¼ˆç”Ÿæˆçš„ä»£ç ï¼‰
const loadUsers = async () => {
  const users = await userApi.getList({
    skipCount: 0,
    maxResultCount: 1000  // âŒ ä¸€æ¬¡åŠ è½½å¤ªå¤š
  });
  
  // âŒ å¾ªç¯æŸ¥è¯¢å…³è”æ•°æ®
  for (const user of users) {
    user.roles = await roleApi.getUserRoles(user.id);
    user.organization = await orgApi.get(user.organizationId);
  }
};
```

**æ‰‹åŠ¨ä¼˜åŒ–å**ï¼š

```javascript
// ä¼˜åŒ–åçš„ä»£ç 
const loadUsers = async () => {
  // åˆ†é¡µåŠ è½½
  const users = await userApi.getList({
    skipCount: (currentPage - 1) * pageSize,
    maxResultCount: pageSize,
    includeDetails: true  // ä¸€æ¬¡æ€§åŒ…å«å…³è”æ•°æ®
  });
  
  // æ‰¹é‡åŠ è½½
  const userIds = users.map(u => u.id);
  const rolesMap = await roleApi.getBatchUserRoles(userIds);
  
  users.forEach(user => {
    user.roles = rolesMap[user.id] || [];
  });
};
```

### 5.3 æœ€ç»ˆéƒ¨ç½²æ£€æŸ¥

**éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•**ï¼š

```bash
âœ… æ•°æ®åº“è¿ç§»è„šæœ¬å·²ç”Ÿæˆ
âœ… APIæ–‡æ¡£å·²ç”Ÿæˆï¼ˆSwaggerï¼‰
âœ… å‰ç«¯è·¯ç”±å·²é…ç½®
âš ï¸ æƒé™ç§å­æ•°æ®éœ€è¦æ‰‹åŠ¨æ·»åŠ 
âŒ å¤šè¯­è¨€èµ„æºæ–‡ä»¶ç¼ºå¤±
âŒ å•å…ƒæµ‹è¯•æœªç”Ÿæˆ
âœ… Dockeré…ç½®å·²ç”Ÿæˆ
âš ï¸ ç”Ÿäº§ç¯å¢ƒé…ç½®éœ€è¦è°ƒæ•´
```

------

## æ€»ç»“ï¼šå¹³å°èƒ½åŠ›è¯„ä¼°

### ğŸ¯ å®Œæˆåº¦ç»Ÿè®¡

| éœ€æ±‚     | å¹³å°è‡ªåŠ¨å®Œæˆ | éœ€è¦æ‰‹åŠ¨è¡¥å…… | å®Œå…¨ä¸æ”¯æŒ |
| -------- | ------------ | ------------ | ---------- |
| æ•°æ®æ¨¡å‹ | 90%          | 10%          | 0%         |
| CRUDæ¥å£ | 85%          | 15%          | 0%         |
| åŸºç¡€é¡µé¢ | 80%          | 20%          | 0%         |
| è§’è‰²ç»§æ‰¿ | 70%          | 30%          | 0%         |
| æ¡ä»¶æƒé™ | 60%          | 40%          | 0%         |
| å®æ—¶åŒæ­¥ | 75%          | 25%          | 0%         |
| æ€§èƒ½ä¼˜åŒ– | 30%          | 70%          | 0%         |
| æµ‹è¯•ä»£ç  | 0%           | 0%           | 100%       |

### ğŸ“Š æœ€ç»ˆè¯„åˆ†ï¼š78åˆ†

**ä¼˜åŠ¿**ï¼š

- âœ… åŸºç¡€ä»£ç ç”Ÿæˆè´¨é‡é«˜
- âœ… æ¨¡å‹é©±åŠ¨å¼€å‘å¾ˆæˆç†Ÿ
- âœ… æ ‘å½¢ç»“æ„å¤„ç†æ™ºèƒ½
- âœ… å®æ—¶åŒæ­¥åŸºæœ¬å¯ç”¨

**åŠ£åŠ¿**ï¼š

- âŒ å¤æ‚ä¸šåŠ¡é€»è¾‘éœ€è¦å¤§é‡æ‰‹å†™
- âŒ æ€§èƒ½ä¼˜åŒ–å‡ ä¹å…¨é æ‰‹åŠ¨
- âŒ æ‰¹é‡æ“ä½œæœªè€ƒè™‘
- âŒ æµ‹è¯•ä»£ç å®Œå…¨æ²¡æœ‰

### ğŸ”§ ä½¿ç”¨å»ºè®®

**é€‚åˆåœºæ™¯**ï¼š

- æ ‡å‡†çš„ä¼ä¸šç®¡ç†ç³»ç»Ÿ
- ä¸­å°è§„æ¨¡é¡¹ç›®ï¼ˆ<500å¹¶å‘ï¼‰
- å¿«é€ŸåŸå‹å¼€å‘
- ç®€å•çš„CRUDåº”ç”¨

**ä¸é€‚åˆåœºæ™¯**ï¼š

- é«˜å¹¶å‘ç³»ç»Ÿï¼ˆ>1000å¹¶å‘ï¼‰
- å¤æ‚ä¸šåŠ¡é€»è¾‘
- éœ€è¦æè‡´æ€§èƒ½ä¼˜åŒ–
- éœ€è¦å®Œæ•´æµ‹è¯•è¦†ç›–

### ğŸ’¡ æ”¹è¿›å»ºè®®

1. **ç´§æ€¥æ”¹è¿›**ï¼ˆ1å‘¨å†…ï¼‰ï¼š
   - ä¿®å¤è§’è‰²ç»§æ‰¿Overrideæ¨¡å¼bug
   - æ·»åŠ æ‰¹é‡æ“ä½œæ¨¡æ¿
   - ä¼˜åŒ–å®æ—¶åŒæ­¥æ€§èƒ½
2. **çŸ­æœŸæ”¹è¿›**ï¼ˆ1ä¸ªæœˆå†…ï¼‰ï¼š
   - æ·»åŠ æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - ç”ŸæˆåŸºç¡€å•å…ƒæµ‹è¯•
   - æ”¹è¿›æ¡ä»¶æƒé™UI
3. **é•¿æœŸæ”¹è¿›**ï¼ˆ3ä¸ªæœˆå†…ï¼‰ï¼š
   - AIè¾…åŠ©ä»£ç ä¼˜åŒ–
   - è‡ªåŠ¨æ€§èƒ½è°ƒä¼˜
   - æ™ºèƒ½æµ‹è¯•ç”Ÿæˆ

### ä¸€å¥è¯æ€»ç»“

**"èƒ½ç”¨ï¼Œä½†ç¦»'å¥½ç”¨'è¿˜æœ‰è·ç¦»ï¼›èƒ½è·‘ï¼Œä½†ç¦»'è·‘å¾—å¿«'è¿˜éœ€åŠªåŠ›"**