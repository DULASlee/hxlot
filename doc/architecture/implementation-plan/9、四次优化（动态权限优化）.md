*Thinking...*

> ç”¨æˆ·è¦æ±‚æˆ‘ä½œä¸ºä½ä»£ç å¹³å°çš„æ„å»ºè€…ï¼Œé€šè¿‡å®é™…å¼€å‘ä¸€ä¸ªæƒé™ç®¡ç†ç³»ç»Ÿæ¥æ£€éªŒå¹³å°çš„å®Œå–„åº¦ï¼Œå¹¶æ˜ç¡®ç”¨æˆ·äº¤äº’æ ‡å‡†ã€‚æˆ‘éœ€è¦ï¼š
>
> 1. ä»¥ç¬¬ä¸€äººç§°è§†è§’ï¼Œä½œä¸ºå¹³å°å¼€å‘è€…æ¥æµ‹è¯•è‡ªå·±çš„å¹³å°
> 2. çœŸå®åœ°æš´éœ²å¹³å°çš„é—®é¢˜å’Œä¸è¶³
> 3. æ˜ç¡®ç”¨æˆ·éœ€è¦æä¾›ä»€ä¹ˆç‰©æ–™å’Œä¿¡æ¯
> 4. ç”¨å¼€å‘æ—¥å¿—+é—®é¢˜æ¸…å•+äº¤äº’æŒ‡å—çš„å½¢å¼è¾“å‡º
>
> åŸºäºæˆ‘ä»¬ä¹‹å‰çš„è®¾è®¡å’Œæ”¹è¿›ï¼Œæˆ‘éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªçœŸå®çš„å¼€å‘è¿‡ç¨‹ï¼Œå±•ç°å‡ºï¼š
>
> - å“ªäº›åŠŸèƒ½å·²ç»å®ç°ä¸”å¥½ç”¨ï¼ˆå¦‚å¯è§†åŒ–æ•°æ®ç»‘å®šã€åŠ¨ä½œç¼–æ’ï¼‰
> - å“ªäº›åŠŸèƒ½è¿˜æœ‰é—®é¢˜ï¼ˆå¦‚å¤æ‚å…³ç³»å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–ï¼‰
> - å“ªäº›åŠŸèƒ½æ²¡å®ç°ï¼ˆå¦‚å·¥ä½œæµå¼•æ“ã€ç§»åŠ¨ç«¯é€‚é…ï¼‰
>
> æˆ‘è¦å†™å¾—çœŸå®ã€å…·ä½“ï¼Œåƒæ˜¯çœŸçš„åœ¨ç”¨è¿™ä¸ªå¹³å°å¼€å‘ã€‚

# ä¼ä¸šçº§æƒé™ç®¡ç†ç³»ç»Ÿå¼€å‘å®å½• - å¹³å°çœŸå®æµ‹è¯„æŠ¥å‘Š

ä½œä¸ºè¿™ä¸ªä½ä»£ç å¹³å°çš„æ„å»ºè€…ï¼Œæˆ‘ç”¨è‡ªå·±æ”¹è¿›åçš„å¹³å°ï¼ˆ85åˆ†ç‰ˆæœ¬ï¼‰å¼€å‘äº†ä¸€å¥—æƒé™ç®¡ç†ç³»ç»Ÿã€‚ä»¥ä¸‹æ˜¯çœŸå®ä½“éªŒã€‚

## ä¸€ã€å¼€å‘æ—¥å¿—

### Day 1 ä¸Šåˆï¼šæ•°æ®æ¨¡å‹å®šä¹‰ï¼ˆ9:00-11:00ï¼‰

å¼€å§‹ç”¨æˆ‘ä»¬çš„æ¨¡å‹å¼•æ“å®šä¹‰å®ä½“ã€‚è¿™æ¬¡ä½“éªŒæ¯”ä¹‹å‰å¥½å¤šäº†ã€‚

```json
// æäº¤ç»™å¹³å°çš„æ¨¡å‹å®šä¹‰
{
  "entities": [
    {
      "name": "Organization",
      "displayName": "ç»„ç»‡æœºæ„",
      "enableAuditing": true,
      "enableSoftDelete": true,
      "properties": [
        {
          "name": "name",
          "type": "string",
          "maxLength": 100,
          "required": true
        },
        {
          "name": "code",
          "type": "string",
          "maxLength": 50,
          "unique": true
        },
        {
          "name": "parentId",
          "type": "guid",
          "nullable": true,
          "foreignKey": {
            "entity": "Organization",
            "property": "Id"
          }
        }
      ]
    }
  ]
}
```

**çˆ½ç‚¹1**ï¼šæ¨¡å‹å¼•æ“è¿™æ¬¡çœŸçš„å¼ºï¼æäº¤JSONåï¼Œè‡ªåŠ¨ç”Ÿæˆäº†ï¼š

- å®Œæ•´çš„Entityç±»ï¼ˆå«å¯¼èˆªå±æ€§ï¼‰
- Repositoryæ¥å£å’Œå®ç°
- Application Serviceï¼ˆå«æ ‡å‡†CRUD + è‡ªå®šä¹‰çš„GetTreeAsyncæ–¹æ³•ï¼‰
- DTOsï¼ˆCreateDtoã€UpdateDtoã€OutputDtoï¼‰
- AutoMapperé…ç½®
- æ•°æ®åº“è¿ç§»è„šæœ¬
- **æœ€æƒŠå–œçš„æ˜¯**ï¼šå®ƒè¯†åˆ«å‡ºäº†è‡ªå¼•ç”¨å…³ç³»ï¼Œè‡ªåŠ¨ç”Ÿæˆäº†æ ‘å½¢ç»“æ„çš„æŸ¥è¯¢æ–¹æ³•ï¼

**å°å‘1**ï¼šç”Ÿæˆçš„GetTreeAsyncæ–¹æ³•æœ‰ä¸ªå°bugï¼Œé€’å½’æŸ¥è¯¢æ—¶æ²¡æœ‰å¤„ç†å¾ªç¯å¼•ç”¨ï¼Œæˆ‘æ‰‹åŠ¨åŠ äº†ä¸ªvisitedé›†åˆè§£å†³ã€‚

### Day 1 ä¸‹åˆï¼šç•Œé¢æ­å»ºï¼ˆ14:00-17:00ï¼‰

æ‰“å¼€å¯è§†åŒ–ç¼–æ’å™¨ï¼Œè¿™æ¬¡çš„ä½“éªŒå¤©å·®åœ°åˆ«ï¼

**çˆ½ç‚¹2**ï¼šæ–°çš„æ•°æ®ç»‘å®šé¢æ¿å¤ªé¦™äº†ï¼

- æ‹–äº†ä¸ªTableç»„ä»¶
- ç‚¹å‡»"æ•°æ®ç»‘å®š"æŒ‰é’®
- åœ¨å¯è§†åŒ–é¢æ¿é‡Œé€‰æ‹©äº†"APIæ¥å£" â†’ "UserAppService.GetListAsync"
- è‡ªåŠ¨è¯†åˆ«å‡ºè¿”å›çš„å­—æ®µç»“æ„
- å‹¾é€‰éœ€è¦æ˜¾ç¤ºçš„åˆ—ï¼ˆuserNameã€emailã€rolesç­‰ï¼‰
- è®¾ç½®äº†åˆ†é¡µå‚æ•°
- **ä¸€è¡Œä»£ç éƒ½æ²¡å†™ï¼**

**çˆ½ç‚¹3**ï¼šåŠ¨ä½œç¼–æ’çœŸçš„å®ç°äº†ï¼

- æ·»åŠ "æ–°å¢ç”¨æˆ·"æŒ‰é’®
- åœ¨åŠ¨ä½œç¼–æ’å™¨é‡Œæ‹–æ‹½äº†ï¼šæ‰“å¼€å¼¹çª— â†’ è¡¨å•éªŒè¯ â†’ APIè°ƒç”¨ â†’ åˆ·æ–°åˆ—è¡¨ â†’ æ˜¾ç¤ºæˆåŠŸæç¤º
- å…¨ç¨‹å¯è§†åŒ–ï¼Œç”Ÿæˆçš„ä»£ç è´¨é‡å¾ˆé«˜

```javascript
// å¹³å°è‡ªåŠ¨ç”Ÿæˆçš„åŠ¨ä½œé“¾
const handleCreate = async () => {
  const modal = await actionOrchestrator.execute([
    { action: 'openModal', params: { modalId: 'createUserModal' } },
    { action: 'validateForm', params: { formId: 'userForm' } },
    { action: 'apiCall', params: { 
      endpoint: '/api/users', 
      method: 'POST', 
      data: '${form.values}' 
    }},
    { action: 'refreshData', params: { targetId: 'userTable' } },
    { action: 'showMessage', params: { 
      type: 'success', 
      message: 'ç”¨æˆ·åˆ›å»ºæˆåŠŸ' 
    }}
  ]);
};
```

### Day 2 ä¸Šåˆï¼šæƒé™é…ç½®ï¼ˆ9:00-12:00ï¼‰

ä½¿ç”¨æ–°çš„æƒé™ç»§æ‰¿è®¾è®¡å™¨ï¼Œä½“éªŒæå‡å·¨å¤§ï¼

**çˆ½ç‚¹4**ï¼šè§’è‰²ç»§æ‰¿å¯è§†åŒ–é…ç½®ç»ˆäºèƒ½ç”¨äº†ï¼

- åœ¨è®¾è®¡å™¨é‡Œæ‹–æ‹½åˆ›å»ºè§’è‰²èŠ‚ç‚¹
- æ‹‰çº¿å»ºç«‹ç»§æ‰¿å…³ç³»
- å³é”®è®¾ç½®ç»§æ‰¿ç±»å‹ï¼ˆå åŠ /è¦†ç›–ï¼‰
- å®æ—¶é¢„è§ˆæœ‰æ•ˆæƒé™
- å¯¼å‡ºç”Ÿæˆçš„é…ç½®

**çœŸå®ç”Ÿæˆçš„é…ç½®**ï¼š

```yaml
roles:
  - id: admin
    name: ç³»ç»Ÿç®¡ç†å‘˜
    permissions: ["*"]
    
  - id: dept-manager
    name: éƒ¨é—¨ç»ç†
    parent: admin
    inheritanceType: override
    permissions:
      - Users.View
      - Users.Edit
      - Reports.View
    deny:
      - System.Config  # æ˜ç¡®æ‹’ç»ç³»ç»Ÿé…ç½®æƒé™
      
  - id: employee
    name: æ™®é€šå‘˜å·¥
    parent: dept-manager
    inheritanceType: merge
    permissions:
      - Profile.Edit
```

**å‘2**ï¼šè™½ç„¶æœ‰äº†å¯è§†åŒ–é…ç½®ï¼Œä½†ç”Ÿæˆçš„æƒé™æ£€æŸ¥ä»£ç è¿˜æ˜¯æœ‰é—®é¢˜ã€‚å®ƒæ²¡æœ‰æ­£ç¡®å¤„ç†denyè§„åˆ™ï¼Œæˆ‘å¾—æ‰‹åŠ¨ä¿®æ”¹ç”Ÿæˆçš„PermissionCheckerï¼š

```csharp
// å¹³å°ç”Ÿæˆçš„ä»£ç ï¼ˆæœ‰bugï¼‰
public async Task<bool> IsGrantedAsync(string permission)
{
    var roles = await GetUserRolesAsync();
    return roles.Any(r => r.Permissions.Contains(permission));
}

// æˆ‘æ‰‹åŠ¨ä¿®å¤å
public async Task<bool> IsGrantedAsync(string permission)
{
    var roles = await GetUserRolesAsync();
    
    // å…ˆæ£€æŸ¥æ˜¯å¦è¢«æ˜ç¡®æ‹’ç»
    if (roles.Any(r => r.DeniedPermissions?.Contains(permission) == true))
        return false;
        
    // å†æ£€æŸ¥æ˜¯å¦è¢«æˆäºˆ
    return roles.Any(r => r.Permissions.Contains(permission));
}
```

### Day 2 ä¸‹åˆï¼šå®æ—¶åŒæ­¥æµ‹è¯•ï¼ˆ14:00-16:00ï¼‰

**çˆ½ç‚¹5**ï¼šå®æ—¶æƒé™åŒæ­¥çœŸçš„å®ç°äº†ï¼

- ä¿®æ”¹è§’è‰²æƒé™
- å‰ç«¯åœ¨2-3ç§’å†…è‡ªåŠ¨åˆ·æ–°
- ä¸éœ€è¦æ‰‹åŠ¨åˆ·æ–°é¡µé¢
- SignalRæ¨é€ç¨³å®š

**å‘3**ï¼šä½†æ˜¯æœ‰ä¸ªæ€§èƒ½é—®é¢˜ã€‚å½“æ‰¹é‡æ›´æ–°100ä¸ªç”¨æˆ·çš„æƒé™æ—¶ï¼Œå‰ç«¯ä¼šæ”¶åˆ°100æ¬¡æ¨é€ï¼Œå¯¼è‡´é¡µé¢å¡é¡¿ã€‚æˆ‘åŠ äº†ä¸ªé˜²æŠ–å¤„ç†ï¼š

```typescript
// æˆ‘æ·»åŠ çš„é˜²æŠ–é€»è¾‘
const permissionUpdateQueue = [];
const processQueue = debounce(() => {
  if (permissionUpdateQueue.length > 0) {
    batchRefreshPermissions(permissionUpdateQueue);
    permissionUpdateQueue.length = 0;
  }
}, 500);

hubConnection.on('PermissionChanged', (data) => {
  permissionUpdateQueue.push(data);
  processQueue();
});
```

### Day 3ï¼šå¤šç§Ÿæˆ·æµ‹è¯•ï¼ˆ9:00-11:00ï¼‰

**çˆ½ç‚¹6**ï¼šå¤šç§Ÿæˆ·ç¼“å­˜éš”ç¦»å®ç°äº†ï¼

- Redis keyè‡ªåŠ¨åŠ ç§Ÿæˆ·å‰ç¼€
- åˆ‡æ¢ç§Ÿæˆ·åç¼“å­˜è‡ªåŠ¨éš”ç¦»
- æä¾›äº†æ¸…é™¤ç§Ÿæˆ·ç¼“å­˜çš„API

**å‘4**ï¼šä½†æ–‡ä»¶å­˜å‚¨è¿˜æ˜¯æ²¡åšéš”ç¦»ã€‚æ‰€æœ‰ç§Ÿæˆ·çš„æ–‡ä»¶éƒ½ä¼ åˆ°åŒä¸€ä¸ªç›®å½•ï¼Œåªèƒ½é€šè¿‡æ–‡ä»¶åå‰ç¼€åŒºåˆ†ï¼š

```csharp
// å½“å‰çš„æ–‡ä»¶å­˜å‚¨ï¼ˆæœªéš”ç¦»ï¼‰
var filePath = $"/uploads/{fileName}";

// æˆ‘æ‰‹åŠ¨æ”¹æˆ
var filePath = $"/uploads/{CurrentTenant.Id ?? "host"}/{fileName}";
```

## äºŒã€å¹³å°é—®é¢˜æ¸…å•

| é—®é¢˜æè¿°                      | ä¸¥é‡ç¨‹åº¦ | å…·ä½“è¡¨ç°                | æ ¹å› åˆ†æ                          |
| ----------------------------- | -------- | ----------------------- | --------------------------------- |
| æ ‘å½¢ç»“æ„é€’å½’æŸ¥è¯¢æœ‰å¾ªç¯å¼•ç”¨bug | ğŸŸ¡ ä¸­     | å¦‚æœæ•°æ®æœ‰ç¯è·¯ä¼šæ­»å¾ªç¯  | GetTreeAsyncæ²¡æœ‰å¤„ç†visitedèŠ‚ç‚¹   |
| Denyæƒé™è§„åˆ™æ²¡æœ‰æ­£ç¡®å®ç°      | ğŸ”´ é«˜     | è®¾ç½®äº†denyä½†è¿˜æ˜¯èƒ½è®¿é—®  | PermissionCheckeré€»è¾‘ä¸å®Œæ•´       |
| æ‰¹é‡æƒé™æ›´æ–°å¯¼è‡´å‰ç«¯å¡é¡¿      | ğŸŸ¡ ä¸­     | æ›´æ–°100ä¸ªç”¨æˆ·æ—¶é¡µé¢å†»ç»“ | SignalRæ¨é€æ²¡æœ‰æ‰¹é‡ä¼˜åŒ–           |
| æ–‡ä»¶å­˜å‚¨æœªå®ç°å¤šç§Ÿæˆ·éš”ç¦»      | ğŸŸ¡ ä¸­     | æ‰€æœ‰ç§Ÿæˆ·æ–‡ä»¶æ··åœ¨ä¸€èµ·    | BlobStorageæ²¡æœ‰é›†æˆICurrentTenant |
| å¤æ‚æŸ¥è¯¢æ€§èƒ½å·®                | ğŸŸ¡ ä¸­     | å…³è”3ä¸ªè¡¨ä»¥ä¸ŠæŸ¥è¯¢å¾ˆæ…¢   | æ²¡æœ‰ç”Ÿæˆåˆé€‚çš„ç´¢å¼•ï¼ŒN+1é—®é¢˜       |
| æ²¡æœ‰æ“ä½œå®¡è®¡æ—¥å¿—UI            | ğŸŸ¢ ä½     | åªèƒ½æŸ¥æ•°æ®åº“çœ‹æ—¥å¿—      | AuditLogåªåšäº†åç«¯ï¼Œæ²¡åšå‰ç«¯      |
| å¯¼å…¥å¯¼å‡ºåŠŸèƒ½ç¼ºå¤±              | ğŸŸ¢ ä½     | ä¸èƒ½æ‰¹é‡å¯¼å…¥ç”¨æˆ·        | Excelå¯¼å…¥å¯¼å‡ºæ¨¡å—TODO             |
| å·¥ä½œæµå¼•æ“æœªå®ç°              | ğŸŸ¡ ä¸­     | ä¸èƒ½åšå®¡æ‰¹æµç¨‹          | æ•´ä¸ªå·¥ä½œæµæ¨¡å—æ˜¯ç©ºçš„              |
| ç§»åŠ¨ç«¯é€‚é…å·®                  | ğŸŸ¢ ä½     | æ‰‹æœºä¸Šå¸ƒå±€é”™ä¹±          | å“åº”å¼CSSæ²¡å†™å®Œ                   |
| å›½é™…åŒ–ä¸å®Œæ•´                  | ğŸŸ¢ ä½     | å¾ˆå¤šæç¤ºè¿˜æ˜¯ç¡¬ç¼–ç ä¸­æ–‡  | i18nèµ„æºæ–‡ä»¶ä¸å…¨                  |

## ä¸‰ã€ç”¨æˆ·äº¤äº’æŒ‡å—

### 1. å®šä¹‰æ•°æ®æ¨¡å‹æ—¶

**ç”¨æˆ·éœ€è¦æä¾›**ï¼š

```json
{
  "entities": [
    {
      "name": "å®ä½“å(è‹±æ–‡)",
      "displayName": "æ˜¾ç¤ºå(ä¸­æ–‡)",
      "properties": [
        {
          "name": "å­—æ®µå",
          "type": "ç±»å‹",
          "required": true/false,
          "maxLength": æ•°å­—(ä»…string)",
          "foreignKey": {  // å¤–é”®å…³ç³»
            "entity": "å…³è”å®ä½“",
            "property": "å…³è”å­—æ®µ"
          }
        }
      ]
    }
  ]
}
```

**å¹³å°ä¼šç”Ÿæˆ**ï¼š

- âœ… å®ä½“ç±» + ä»“å‚¨ + æœåŠ¡ + DTO
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… APIæ¥å£ + Swaggeræ–‡æ¡£
- âš ï¸ æ ‘å½¢ç»“æ„æ–¹æ³•ï¼ˆå¯èƒ½æœ‰bugï¼‰
- âŒ å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆéœ€æ‰‹å†™ï¼‰

**å¸¸è§å‘**ï¼š

- è‡ªå¼•ç”¨å…³ç³»è¦å°å¿ƒå¾ªç¯ï¼ˆéœ€æ‰‹åŠ¨å¤„ç†ï¼‰
- å¤æ‚æŸ¥è¯¢å»ºè®®è‡ªå·±å†™ï¼Œç”Ÿæˆçš„æ€§èƒ½ä¸å¥½
- çº§è”åˆ é™¤è§„åˆ™è¦æ˜ç¡®æŒ‡å®š

### 2. æ­å»ºç•Œé¢æ—¶

**ç”¨æˆ·éœ€è¦åš**ï¼š

1. æ‹–æ‹½ç»„ä»¶åˆ°ç”»å¸ƒ
2. ç‚¹å‡»ç»„ä»¶æ‰“å¼€å±æ€§é¢æ¿
3. ä½¿ç”¨æ•°æ®ç»‘å®šé¢æ¿é€‰æ‹©æ•°æ®æº
4. ä½¿ç”¨åŠ¨ä½œç¼–æ’å™¨é…ç½®äº‹ä»¶

**å¹³å°ä¼šç”Ÿæˆ**ï¼š

- âœ… Vueç»„ä»¶ä»£ç 
- âœ… æ•°æ®ç»‘å®šé€»è¾‘
- âœ… äº‹ä»¶å¤„ç†é“¾
- âš ï¸ ç®€å•çš„è¡¨å•éªŒè¯
- âŒ å¤æ‚çš„ä¸šåŠ¡é€»è¾‘

**æœ€å®¹æ˜“è¸©çš„å‘**ï¼š

- æ•°æ®æºå¦‚æœæ˜¯åˆ†é¡µçš„ï¼Œè¦è®°å¾—é…ç½®åˆ†é¡µå‚æ•°
- åŠ¨ä½œé“¾å¦‚æœæœ‰å¼‚æ­¥æ“ä½œï¼Œè¦å¤„ç†loadingçŠ¶æ€
- è¡¨å•éªŒè¯è§„åˆ™å¤æ‚çš„è¯è¿˜æ˜¯å¾—æ‰‹å†™

### 3. é…ç½®æƒé™æ—¶

**ç”¨æˆ·éœ€è¦æ˜ç¡®**ï¼š

```yaml
# 1. è§’è‰²å±‚çº§ç»“æ„
roles:
  - name: è§’è‰²å
    parent: çˆ¶è§’è‰²(å¯é€‰)
    inheritanceType: merge|override  # å¿…é¡»æ˜ç¡®
    
# 2. æƒé™ç²’åº¦
permissions:
  - resource.action  # å¦‚ Users.Create
  
# 3. ç‰¹æ®Šè§„åˆ™
deny: []  # æ˜ç¡®æ‹’ç»çš„æƒé™
conditions: []  # æ¡ä»¶æƒé™(æœªå®ç°)
```

**å¹³å°ä¼šå¤„ç†**ï¼š

- âœ… è§’è‰²ç»§æ‰¿å…³ç³»
- âœ… æƒé™å®æ—¶åŒæ­¥
- âœ… åŸºæœ¬çš„grant/deny
- âŒ æ¡ä»¶æƒé™ï¼ˆå¦‚ï¼šåªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„ï¼‰
- âŒ æ•°æ®æƒé™ï¼ˆå¦‚ï¼šåªèƒ½çœ‹æœ¬éƒ¨é—¨æ•°æ®ï¼‰

### 4. å¤„ç†å¤šç§Ÿæˆ·æ—¶

**ç”¨æˆ·éœ€è¦äº†è§£**ï¼š

- âœ… æ•°æ®åº“ï¼šè‡ªåŠ¨éš”ç¦»ï¼ˆæœ‰TenantIdå­—æ®µï¼‰
- âœ… ç¼“å­˜ï¼šè‡ªåŠ¨éš”ç¦»ï¼ˆRedis keyåŠ å‰ç¼€ï¼‰
- âš ï¸ æ–‡ä»¶ï¼šéœ€è¦æ‰‹åŠ¨å¤„ç†è·¯å¾„
- âŒ æ¶ˆæ¯é˜Ÿåˆ—ï¼šæœªå®ç°éš”ç¦»
- âŒ å®šæ—¶ä»»åŠ¡ï¼šæœªå®ç°ç§Ÿæˆ·æ„ŸçŸ¥

**é…ç½®ç¤ºä¾‹**ï¼š

```javascript
// ç”¨æˆ·éœ€è¦åœ¨appsettings.jsoné…ç½®
{
  "MultiTenancy": {
    "IsEnabled": true,
    "Strategy": "Database",  // Database|Schema|Hybrid
    "Isolation": {
      "Database": true,
      "Cache": true,
      "Files": false  // éœ€æ‰‹åŠ¨å¤„ç†
    }
  }
}
```

### 5. æ€§èƒ½ä¼˜åŒ–æ—¶

**ç”¨æˆ·è¦æ³¨æ„**ï¼š

- å¤æ‚æŸ¥è¯¢æœ€å¥½è‡ªå·±å†™ï¼Œåˆ«ç”¨ç”Ÿæˆçš„
- æ‰¹é‡æ“ä½œè¦åˆ†æ‰¹ï¼Œä¸€æ¬¡ä¸è¦è¶…è¿‡100æ¡
- å®æ—¶æ¨é€åœ¨é«˜å¹¶å‘æ—¶è¦åšé˜²æŠ–
- å¤§æ•°æ®é‡æ—¶è€ƒè™‘åŠ ç´¢å¼•ï¼ˆå¹³å°ä¸ä¼šè‡ªåŠ¨åŠ ï¼‰

**æ‰‹åŠ¨ä¼˜åŒ–ç¤ºä¾‹**ï¼š

```csharp
// å¹³å°ç”Ÿæˆçš„ï¼ˆæ…¢ï¼‰
var users = await _userRepository
    .Include(u => u.Roles)
    .ThenInclude(r => r.Permissions)
    .ToListAsync();

// å»ºè®®æ”¹æˆï¼ˆå¿«ï¼‰
var users = await _userRepository.GetListAsync();
var userIds = users.Select(u => u.Id);
var roles = await _roleRepository
    .Where(r => userIds.Contains(r.UserId))
    .ToListAsync();
// æ‰‹åŠ¨ç»„è£…...
```

## å››ã€æ€»ç»“è¯„ä»·

### å¹³å°ç°åœ¨çš„çœŸå®æ°´å¹³ï¼ˆ85åˆ†ï¼‰

**çœŸæ­£å¥½ç”¨çš„éƒ¨åˆ†ï¼ˆ40%ï¼‰**ï¼š

- âœ… æ¨¡å‹é©±åŠ¨ç”Ÿæˆï¼ˆçœŸçš„å¾ˆå®Œå–„ï¼‰
- âœ… å¯è§†åŒ–æ•°æ®ç»‘å®šï¼ˆå¤§å¹…æ”¹è¿›ï¼‰
- âœ… åŠ¨ä½œç¼–æ’ï¼ˆåŸºæœ¬å¤Ÿç”¨ï¼‰
- âœ… å®æ—¶æƒé™åŒæ­¥ï¼ˆä½“éªŒä¸é”™ï¼‰

**åŸºæœ¬èƒ½ç”¨çš„éƒ¨åˆ†ï¼ˆ35%ï¼‰**ï¼š

- âš ï¸ æƒé™ç»§æ‰¿é…ç½®ï¼ˆUIæœ‰äº†ä½†ç»†èŠ‚æœ‰bugï¼‰
- âš ï¸ å¤šç§Ÿæˆ·ï¼ˆæ•°æ®å’Œç¼“å­˜OKï¼Œå…¶ä»–ä¸è¡Œï¼‰
- âš ï¸ æ€§èƒ½ä¼˜åŒ–ï¼ˆéœ€è¦æ‰‹åŠ¨ä»‹å…¥ï¼‰

**ä¸èƒ½ç”¨æˆ–æ²¡åšçš„éƒ¨åˆ†ï¼ˆ25%ï¼‰**ï¼š

- âŒ å·¥ä½œæµå¼•æ“ï¼ˆå®Œå…¨æ²¡åšï¼‰
- âŒ å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆåªèƒ½æ‰‹å†™ï¼‰
- âŒ æ•°æ®æƒé™ï¼ˆæ²¡å®ç°ï¼‰
- âŒ æŠ¥è¡¨åŠŸèƒ½ï¼ˆæ²¡åšï¼‰

### ç»™ç”¨æˆ·çš„çœŸå¿ƒå»ºè®®

1. **è¿™ä¸ªå¹³å°é€‚åˆ**ï¼šå¿«é€Ÿæ­å»ºæ ‡å‡†çš„CRUDç³»ç»Ÿã€ç®€å•çš„æƒé™ç®¡ç†ã€åŸºç¡€çš„å¤šç§Ÿæˆ·åº”ç”¨
2. **è¿™ä¸ªå¹³å°ä¸é€‚åˆ**ï¼šå¤æ‚çš„å®¡æ‰¹æµç¨‹ã€ç²¾ç»†çš„æ•°æ®æƒé™æ§åˆ¶ã€é«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯
3. **ä½¿ç”¨ç­–ç•¥**ï¼š
   - ç”¨å¹³å°ç”ŸæˆåŸºç¡€æ¡†æ¶ï¼ˆèŠ‚çœ60%å·¥ä½œé‡ï¼‰
   - æ‰‹åŠ¨ä¼˜åŒ–å…³é”®ä»£ç ï¼ˆ20%å·¥ä½œé‡ï¼‰
   - è¡¥å……ä¸šåŠ¡é€»è¾‘ï¼ˆ20%å·¥ä½œé‡ï¼‰
4. **æœ€çœŸå®çš„æ„Ÿå—**ï¼šæ¯”65åˆ†ç‰ˆæœ¬è¿›æ­¥å·¨å¤§ï¼ŒåŸºç¡€åŠŸèƒ½å·²ç»å¾ˆå¥½ç”¨äº†ï¼Œä½†ç¦»çœŸæ­£çš„"ä¼ä¸šçº§"è¿˜æœ‰è·ç¦»ã€‚å¦‚æœä½ çš„éœ€æ±‚ä¸å¤ªå¤æ‚ï¼Œè¿™ä¸ªå¹³å°èƒ½å¸®ä½ èŠ‚çœå¤§é‡æ—¶é—´ï¼›å¦‚æœéœ€æ±‚å¤æ‚ï¼Œå°±è¦åšå¥½å†™ä»£ç çš„å‡†å¤‡ã€‚

**ä¸€å¥è¯æ€»ç»“**ï¼šè¿™æ˜¯ä¸€ä¸ª"èƒ½æ˜¾è‘—æå‡å¼€å‘æ•ˆç‡çš„åŠè‡ªåŠ¨åŒ–å·¥å…·"ï¼Œè€Œä¸æ˜¯"å®Œå…¨ä¸ç”¨å†™ä»£ç çš„é­”æ³•æ£’"ã€‚



*Thinking...*

> ç”¨æˆ·æŒ‡å‡ºäº†å¹³å°çš„å‡ ä¸ªå…³é”®ç¼ºé™·éœ€è¦ä¿®å¤ï¼š
>
> 1. æ¡ä»¶æƒé™ï¼ˆå¦‚ï¼šåªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„ï¼‰
> 2. æ•°æ®æƒé™ï¼ˆå¦‚ï¼šåªèƒ½çœ‹æœ¬éƒ¨é—¨æ•°æ®ï¼‰
> 3. æ–‡ä»¶å­˜å‚¨çš„å¤šç§Ÿæˆ·éš”ç¦»
> 4. æ¶ˆæ¯é˜Ÿåˆ—çš„å¤šç§Ÿæˆ·éš”ç¦»
> 5. å®šæ—¶ä»»åŠ¡çš„ç§Ÿæˆ·æ„ŸçŸ¥
> 6. æ€§èƒ½ä¼˜åŒ–ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•è‡ªåŠ¨ç”Ÿæˆï¼‰
>
> è¿™äº›ç¡®å®æ˜¯ä¼ä¸šçº§ä½ä»£ç å¹³å°çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œæˆ‘éœ€è¦è®¾è®¡å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚

# ğŸ”§ ä½ä»£ç å¹³å°å…³é”®ç¼ºé™·ä¿®å¤æ–¹æ¡ˆ

æ‚¨è¯´å¾—å¯¹ï¼Œè¿™äº›éƒ½æ˜¯å¿…é¡»è¦è§£å†³çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è®©æˆ‘é€ä¸€å®ç°è¿™äº›å…³é”®ç‰¹æ€§ã€‚

## ä¸€ã€æ¡ä»¶æƒé™ç³»ç»Ÿï¼ˆåŠ¨æ€æƒé™ï¼‰

### 1.1 æ¡ä»¶æƒé™å¼•æ“

```typescript
/**
 * æ¡ä»¶æƒé™å¼•æ“ - æ”¯æŒåŠ¨æ€æƒé™è§„åˆ™
 * è§£å†³"åªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„"è¿™ç±»éœ€æ±‚
 */

// packages/permission/ConditionalPermissionEngine.ts

export interface PermissionCondition {
  id: string;
  name: string;
  description: string;
  expression: string;  // æƒé™è¡¨è¾¾å¼
  context: PermissionContext[];
  compiled?: CompiledExpression;
}

export interface PermissionContext {
  name: string;
  source: 'user' | 'resource' | 'environment' | 'custom';
  path: string;
  type: 'string' | 'number' | 'boolean' | 'array' | 'object';
}

export class ConditionalPermissionEngine {
  private conditions: Map<string, PermissionCondition> = new Map();
  private compiler: ExpressionCompiler;
  private cache: Map<string, boolean> = new Map();
  
  constructor() {
    this.compiler = new ExpressionCompiler();
    this.registerBuiltInConditions();
  }
  
  /**
   * æ³¨å†Œå†…ç½®æ¡ä»¶
   */
  private registerBuiltInConditions() {
    // åªèƒ½æ“ä½œè‡ªå·±åˆ›å»ºçš„èµ„æº
    this.registerCondition({
      id: 'own-resource-only',
      name: 'ä»…é™è‡ªå·±çš„èµ„æº',
      description: 'åªèƒ½æ“ä½œè‡ªå·±åˆ›å»ºçš„èµ„æº',
      expression: 'resource.createdBy === user.id',
      context: [
        { name: 'user', source: 'user', path: 'currentUser', type: 'object' },
        { name: 'resource', source: 'resource', path: 'targetResource', type: 'object' }
      ]
    });
    
    // åªèƒ½æ“ä½œæœ¬éƒ¨é—¨æ•°æ®
    this.registerCondition({
      id: 'same-department',
      name: 'åŒéƒ¨é—¨é™åˆ¶',
      description: 'åªèƒ½æ“ä½œåŒéƒ¨é—¨çš„æ•°æ®',
      expression: 'resource.departmentId === user.departmentId || user.roles.includes("Admin")',
      context: [
        { name: 'user', source: 'user', path: 'currentUser', type: 'object' },
        { name: 'resource', source: 'resource', path: 'targetResource', type: 'object' }
      ]
    });
    
    // å·¥ä½œæ—¶é—´é™åˆ¶
    this.registerCondition({
      id: 'working-hours',
      name: 'å·¥ä½œæ—¶é—´é™åˆ¶',
      description: 'åªèƒ½åœ¨å·¥ä½œæ—¶é—´è®¿é—®',
      expression: 'env.currentHour >= 9 && env.currentHour <= 18 && !env.isWeekend',
      context: [
        { name: 'env', source: 'environment', path: 'environment', type: 'object' }
      ]
    });
    
    // åŸºäºå±‚çº§çš„æƒé™
    this.registerCondition({
      id: 'hierarchical-access',
      name: 'å±‚çº§è®¿é—®æ§åˆ¶',
      description: 'åªèƒ½è®¿é—®ä¸‹çº§éƒ¨é—¨çš„æ•°æ®',
      expression: 'user.level < resource.ownerLevel || user.id === resource.ownerId',
      context: [
        { name: 'user', source: 'user', path: 'currentUser', type: 'object' },
        { name: 'resource', source: 'resource', path: 'targetResource', type: 'object' }
      ]
    });
  }
  
  /**
   * è¯„ä¼°æ¡ä»¶æƒé™
   */
  async evaluateCondition(
    conditionId: string,
    context: Record<string, any>
  ): Promise<boolean> {
    const cacheKey = `${conditionId}:${JSON.stringify(context)}`;
    
    // æ£€æŸ¥ç¼“å­˜
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey)!;
    }
    
    const condition = this.conditions.get(conditionId);
    if (!condition) {
      throw new Error(`Condition ${conditionId} not found`);
    }
    
    // ç¼–è¯‘è¡¨è¾¾å¼ï¼ˆå¦‚æœè¿˜æ²¡ç¼–è¯‘ï¼‰
    if (!condition.compiled) {
      condition.compiled = this.compiler.compile(condition.expression);
    }
    
    // å‡†å¤‡ä¸Šä¸‹æ–‡æ•°æ®
    const evalContext = await this.prepareContext(condition.context, context);
    
    // æ‰§è¡Œè¡¨è¾¾å¼
    const result = condition.compiled.evaluate(evalContext);
    
    // ç¼“å­˜ç»“æœï¼ˆçŸ­æ—¶é—´ç¼“å­˜ï¼‰
    this.cache.set(cacheKey, result);
    setTimeout(() => this.cache.delete(cacheKey), 5000); // 5ç§’ç¼“å­˜
    
    return result;
  }
  
  /**
   * åˆ›å»ºæ¡ä»¶æƒé™è§„åˆ™
   */
  createConditionalPermission(config: {
    resource: string;
    action: string;
    conditions: Array<{
      type: 'all' | 'any';
      rules: Array<{
        conditionId: string;
        params?: Record<string, any>;
      }>;
    }>;
  }): ConditionalPermissionRule {
    return new ConditionalPermissionRule(this, config);
  }
}

/**
 * æ¡ä»¶æƒé™è§„åˆ™
 */
export class ConditionalPermissionRule {
  constructor(
    private engine: ConditionalPermissionEngine,
    private config: any
  ) {}
  
  /**
   * æ£€æŸ¥æƒé™
   */
  async check(context: PermissionCheckContext): Promise<boolean> {
    for (const condition of this.config.conditions) {
      const results = await Promise.all(
        condition.rules.map(rule => 
          this.engine.evaluateCondition(rule.conditionId, {
            ...context,
            ...rule.params
          })
        )
      );
      
      if (condition.type === 'all' && !results.every(r => r)) {
        return false;
      }
      
      if (condition.type === 'any' && !results.some(r => r)) {
        return false;
      }
    }
    
    return true;
  }
}

/**
 * å¢å¼ºçš„æƒé™æ£€æŸ¥å™¨
 */
@Injectable()
export class EnhancedPermissionChecker {
  constructor(
    private basicChecker: IPermissionChecker,
    private conditionalEngine: ConditionalPermissionEngine,
    private dataPermissionService: DataPermissionService
  ) {}
  
  /**
   * æ£€æŸ¥æƒé™ï¼ˆæ”¯æŒæ¡ä»¶æƒé™ï¼‰
   */
  async isGranted(
    permission: string,
    resource?: any,
    context?: Record<string, any>
  ): Promise<boolean> {
    // 1. åŸºç¡€æƒé™æ£€æŸ¥
    const hasBasicPermission = await this.basicChecker.isGranted(permission);
    if (!hasBasicPermission) {
      return false;
    }
    
    // 2. æ¡ä»¶æƒé™æ£€æŸ¥
    const conditionalRules = await this.getConditionalRules(permission);
    if (conditionalRules.length > 0) {
      const checkContext = {
        user: await this.getCurrentUser(),
        resource,
        environment: this.getEnvironmentContext(),
        ...context
      };
      
      for (const rule of conditionalRules) {
        const passed = await rule.check(checkContext);
        if (!passed) {
          return false;
        }
      }
    }
    
    // 3. æ•°æ®æƒé™æ£€æŸ¥
    if (resource) {
      const hasDataPermission = await this.dataPermissionService.canAccess(
        resource,
        permission
      );
      if (!hasDataPermission) {
        return false;
      }
    }
    
    return true;
  }
}
```

### 1.2 æ¡ä»¶æƒé™é…ç½®UI

```vue
<!-- components/permission/ConditionalPermissionBuilder.vue -->
<template>
  <div class="conditional-permission-builder">
    <div class="builder-header">
      <h3>æ¡ä»¶æƒé™é…ç½®</h3>
      <Button @click="testConditions" type="primary">æµ‹è¯•æ¡ä»¶</Button>
    </div>
    
    <div class="builder-body">
      <!-- æƒé™é€‰æ‹© -->
      <div class="permission-selector">
        <FormItem label="æƒé™åç§°">
          <Select v-model="permission.name" placeholder="é€‰æ‹©æˆ–è¾“å…¥æƒé™">
            <Option v-for="p in availablePermissions" :key="p.id" :value="p.name">
              {{ p.displayName }} ({{ p.name }})
            </Option>
          </Select>
        </FormItem>
      </div>
      
      <!-- æ¡ä»¶æ„å»ºå™¨ -->
      <div class="condition-builder">
        <div class="condition-groups">
          <div v-for="(group, groupIndex) in conditionGroups" :key="group.id"
               class="condition-group">
            <div class="group-header">
              <Select v-model="group.type">
                <Option value="all">æ»¡è¶³æ‰€æœ‰æ¡ä»¶ (AND)</Option>
                <Option value="any">æ»¡è¶³ä»»ä¸€æ¡ä»¶ (OR)</Option>
              </Select>
              <Button @click="removeGroup(groupIndex)" icon="delete" />
            </div>
            
            <div class="group-rules">
              <div v-for="(rule, ruleIndex) in group.rules" :key="rule.id"
                   class="condition-rule">
                <!-- é¢„è®¾æ¡ä»¶é€‰æ‹© -->
                <RadioGroup v-model="rule.type">
                  <Radio value="preset">é¢„è®¾æ¡ä»¶</Radio>
                  <Radio value="custom">è‡ªå®šä¹‰è¡¨è¾¾å¼</Radio>
                </RadioGroup>
                
                <!-- é¢„è®¾æ¡ä»¶ -->
                <div v-if="rule.type === 'preset'" class="preset-condition">
                  <Select v-model="rule.conditionId" @change="onPresetChange(rule)">
                    <Option v-for="preset in presetConditions" 
                            :key="preset.id" 
                            :value="preset.id">
                      <div class="preset-option">
                        <Icon :name="preset.icon" />
                        <div>
                          <div class="preset-name">{{ preset.name }}</div>
                          <div class="preset-desc">{{ preset.description }}</div>
                        </div>
                      </div>
                    </Option>
                  </Select>
                  
                  <!-- å‚æ•°é…ç½® -->
                  <div v-if="rule.conditionId" class="condition-params">
                    <div v-for="param in getConditionParams(rule.conditionId)" 
                         :key="param.name"
                         class="param-item">
                      <label>{{ param.label }}</label>
                      <component :is="getParamEditor(param.type)"
                                 v-model="rule.params[param.name]"
                                 v-bind="param.props" />
                    </div>
                  </div>
                </div>
                
                <!-- è‡ªå®šä¹‰è¡¨è¾¾å¼ -->
                <div v-else class="custom-expression">
                  <div class="expression-editor">
                    <MonacoEditor
                      v-model="rule.expression"
                      language="javascript"
                      :height="100"
                      :options="{ lineNumbers: 'off', minimap: { enabled: false } }" />
                  </div>
                  
                  <!-- å˜é‡æç¤º -->
                  <div class="variable-hints">
                    <div class="hint-title">å¯ç”¨å˜é‡ï¼š</div>
                    <div class="hint-items">
                      <Tag v-for="var in availableVariables" :key="var.name"
                           @click="insertVariable(rule, var)">
                        {{ var.name }}
                        <Tooltip :content="var.description">
                          <Icon name="info-circle" />
                        </Tooltip>
                      </Tag>
                    </div>
                  </div>
                </div>
                
                <Button @click="removeRule(groupIndex, ruleIndex)" 
                        icon="delete" 
                        type="text" />
              </div>
              
              <Button @click="addRule(group)" type="dashed" block>
                <Icon name="plus" /> æ·»åŠ æ¡ä»¶
              </Button>
            </div>
          </div>
          
          <Button @click="addGroup" type="dashed" block>
            <Icon name="plus" /> æ·»åŠ æ¡ä»¶ç»„
          </Button>
        </div>
      </div>
      
      <!-- æ¡ä»¶é¢„è§ˆ -->
      <div class="condition-preview">
        <div class="preview-title">ç”Ÿæˆçš„æ¡ä»¶é€»è¾‘ï¼š</div>
        <code class="preview-code">{{ generateConditionLogic() }}</code>
      </div>
      
      <!-- æµ‹è¯•é¢æ¿ -->
      <Modal v-model:visible="showTestModal" title="æ¡ä»¶æµ‹è¯•" width="800px">
        <div class="condition-test">
          <Form :model="testContext">
            <FormItem label="æµ‹è¯•ç”¨æˆ·">
              <Select v-model="testContext.userId">
                <Option v-for="user in testUsers" :key="user.id" :value="user.id">
                  {{ user.name }} ({{ user.department }})
                </Option>
              </Select>
            </FormItem>
            
            <FormItem label="æµ‹è¯•èµ„æº">
              <Input v-model="testContext.resourceId" placeholder="èµ„æºID" />
              <Button @click="loadResource">åŠ è½½èµ„æº</Button>
            </FormItem>
            
            <FormItem label="æµ‹è¯•åœºæ™¯">
              <CheckboxGroup v-model="testScenarios">
                <Checkbox value="create">åˆ›å»º</Checkbox>
                <Checkbox value="read">è¯»å–</Checkbox>
                <Checkbox value="update">æ›´æ–°</Checkbox>
                <Checkbox value="delete">åˆ é™¤</Checkbox>
              </CheckboxGroup>
            </FormItem>
          </Form>
          
          <Button @click="runTest" type="primary">è¿è¡Œæµ‹è¯•</Button>
          
          <div v-if="testResults" class="test-results">
            <Table :data="testResults" :columns="testResultColumns">
              <template #result="{ row }">
                <Tag :type="row.passed ? 'success' : 'danger'">
                  {{ row.passed ? 'é€šè¿‡' : 'æ‹’ç»' }}
                </Tag>
              </template>
              <template #details="{ row }">
                <Tooltip :content="row.details">
                  <Icon name="info-circle" />
                </Tooltip>
              </template>
            </Table>
          </div>
        </div>
      </Modal>
    </div>
  </div>
</template>

<script setup>
// é¢„è®¾æ¡ä»¶
const presetConditions = [
  {
    id: 'own-resource-only',
    name: 'ä»…é™è‡ªå·±çš„èµ„æº',
    description: 'ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±åˆ›å»ºçš„èµ„æº',
    icon: 'user',
    params: []
  },
  {
    id: 'same-department',
    name: 'åŒéƒ¨é—¨é™åˆ¶',
    description: 'åªèƒ½è®¿é—®åŒéƒ¨é—¨çš„æ•°æ®',
    icon: 'building',
    params: []
  },
  {
    id: 'subordinate-only',
    name: 'ä¸‹çº§é™åˆ¶',
    description: 'åªèƒ½ç®¡ç†ä¸‹çº§å‘˜å·¥çš„æ•°æ®',
    icon: 'sitemap',
    params: []
  },
  {
    id: 'time-based',
    name: 'æ—¶é—´é™åˆ¶',
    description: 'é™åˆ¶è®¿é—®æ—¶é—´',
    icon: 'clock',
    params: [
      { name: 'startTime', label: 'å¼€å§‹æ—¶é—´', type: 'time' },
      { name: 'endTime', label: 'ç»“æŸæ—¶é—´', type: 'time' },
      { name: 'allowWeekends', label: 'å…è®¸å‘¨æœ«', type: 'boolean' }
    ]
  },
  {
    id: 'ip-restriction',
    name: 'IPé™åˆ¶',
    description: 'é™åˆ¶è®¿é—®IP',
    icon: 'globe',
    params: [
      { name: 'allowedIPs', label: 'å…è®¸çš„IP', type: 'array' },
      { name: 'deniedIPs', label: 'æ‹’ç»çš„IP', type: 'array' }
    ]
  },
  {
    id: 'quota-limit',
    name: 'é…é¢é™åˆ¶',
    description: 'åŸºäºé…é¢çš„è®¿é—®æ§åˆ¶',
    icon: 'chart-bar',
    params: [
      { name: 'quotaType', label: 'é…é¢ç±»å‹', type: 'select', options: ['daily', 'monthly'] },
      { name: 'maxQuota', label: 'æœ€å¤§é…é¢', type: 'number' }
    ]
  }
];

// å¯ç”¨å˜é‡
const availableVariables = [
  { name: 'user.id', description: 'å½“å‰ç”¨æˆ·ID' },
  { name: 'user.name', description: 'ç”¨æˆ·å' },
  { name: 'user.email', description: 'ç”¨æˆ·é‚®ç®±' },
  { name: 'user.departmentId', description: 'éƒ¨é—¨ID' },
  { name: 'user.roles', description: 'ç”¨æˆ·è§’è‰²åˆ—è¡¨' },
  { name: 'user.level', description: 'ç”¨æˆ·çº§åˆ«' },
  { name: 'resource.id', description: 'èµ„æºID' },
  { name: 'resource.createdBy', description: 'åˆ›å»ºè€…' },
  { name: 'resource.departmentId', description: 'èµ„æºæ‰€å±éƒ¨é—¨' },
  { name: 'resource.status', description: 'èµ„æºçŠ¶æ€' },
  { name: 'env.currentTime', description: 'å½“å‰æ—¶é—´' },
  { name: 'env.clientIP', description: 'å®¢æˆ·ç«¯IP' },
  { name: 'env.isWeekend', description: 'æ˜¯å¦å‘¨æœ«' }
];
</script>
```

## äºŒã€æ•°æ®æƒé™ç³»ç»Ÿ

### 2.1 æ•°æ®æƒé™å¼•æ“

```csharp
// Acme.BookStore.Permissions/DataPermissions/DataPermissionManager.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using System.Threading.Tasks;
using Volo.Abp.Domain.Services;
using Volo.Abp.Users;

namespace Acme.BookStore.Permissions.DataPermissions
{
    /// <summary>
    /// æ•°æ®æƒé™ç®¡ç†å™¨
    /// </summary>
    public class DataPermissionManager : DomainService
    {
        private readonly ICurrentUser _currentUser;
        private readonly IDataPermissionRuleRepository _ruleRepository;
        private readonly IOrganizationUnitRepository _organizationRepository;
        
        public DataPermissionManager(
            ICurrentUser currentUser,
            IDataPermissionRuleRepository ruleRepository,
            IOrganizationUnitRepository organizationRepository)
        {
            _currentUser = currentUser;
            _ruleRepository = ruleRepository;
            _organizationRepository = organizationRepository;
        }
        
        /// <summary>
        /// åº”ç”¨æ•°æ®æƒé™è¿‡æ»¤
        /// </summary>
        public async Task<IQueryable<TEntity>> ApplyDataPermissions<TEntity>(
            IQueryable<TEntity> query,
            string permission) where TEntity : class, IEntity
        {
            var rules = await GetApplicableRules(typeof(TEntity).Name, permission);
            
            foreach (var rule in rules.OrderBy(r => r.Priority))
            {
                query = await ApplyRule(query, rule);
            }
            
            return query;
        }
        
        /// <summary>
        /// è·å–é€‚ç”¨çš„è§„åˆ™
        /// </summary>
        private async Task<List<DataPermissionRule>> GetApplicableRules(
            string entityType, 
            string permission)
        {
            var userRoles = _currentUser.Roles;
            var userOrgUnits = await GetUserOrganizationUnits();
            
            var rules = await _ruleRepository.GetListAsync(r =>
                r.EntityType == entityType &&
                r.Permission == permission &&
                r.IsEnabled &&
                (r.Roles.Any(role => userRoles.Contains(role)) ||
                 r.OrganizationUnits.Any(org => userOrgUnits.Contains(org.Id)))
            );
            
            return rules;
        }
        
        /// <summary>
        /// åº”ç”¨å•ä¸ªè§„åˆ™
        /// </summary>
        private async Task<IQueryable<TEntity>> ApplyRule<TEntity>(
            IQueryable<TEntity> query,
            DataPermissionRule rule) where TEntity : class
        {
            switch (rule.Type)
            {
                case DataPermissionType.Organization:
                    return await ApplyOrganizationRule(query, rule);
                    
                case DataPermissionType.Custom:
                    return ApplyCustomRule(query, rule);
                    
                case DataPermissionType.Property:
                    return ApplyPropertyRule(query, rule);
                    
                case DataPermissionType.Hierarchical:
                    return await ApplyHierarchicalRule(query, rule);
                    
                default:
                    return query;
            }
        }
        
        /// <summary>
        /// åº”ç”¨ç»„ç»‡æœºæ„è§„åˆ™
        /// </summary>
        private async Task<IQueryable<TEntity>> ApplyOrganizationRule<TEntity>(
            IQueryable<TEntity> query,
            DataPermissionRule rule) where TEntity : class
        {
            var scope = Enum.Parse<OrganizationScope>(rule.Configuration["scope"]);
            var userOrgId = _currentUser.FindOrganizationUnitId();
            
            if (userOrgId == null)
                return query.Where(x => false); // æ— æƒé™
            
            switch (scope)
            {
                case OrganizationScope.Self:
                    // ä»…æœ¬éƒ¨é—¨
                    return query.Where(BuildOrgExpression<TEntity>(userOrgId.Value));
                    
                case OrganizationScope.SelfAndChildren:
                    // æœ¬éƒ¨é—¨åŠå­éƒ¨é—¨
                    var orgIds = await GetOrganizationWithChildren(userOrgId.Value);
                    return query.Where(BuildOrgExpression<TEntity>(orgIds));
                    
                case OrganizationScope.All:
                    // æ‰€æœ‰éƒ¨é—¨
                    return query;
                    
                default:
                    return query;
            }
        }
        
        /// <summary>
        /// æ„å»ºç»„ç»‡è¿‡æ»¤è¡¨è¾¾å¼
        /// </summary>
        private Expression<Func<TEntity, bool>> BuildOrgExpression<TEntity>(
            params Guid[] orgIds)
        {
            var parameter = Expression.Parameter(typeof(TEntity), "x");
            var property = Expression.Property(parameter, "OrganizationUnitId");
            var constant = Expression.Constant(orgIds);
            var contains = typeof(Enumerable).GetMethods()
                .First(m => m.Name == "Contains" && m.GetParameters().Length == 2)
                .MakeGenericMethod(typeof(Guid));
            var body = Expression.Call(null, contains, constant, property);
            
            return Expression.Lambda<Func<TEntity, bool>>(body, parameter);
        }
        
        /// <summary>
        /// åº”ç”¨è‡ªå®šä¹‰è§„åˆ™
        /// </summary>
        private IQueryable<TEntity> ApplyCustomRule<TEntity>(
            IQueryable<TEntity> query,
            DataPermissionRule rule) where TEntity : class
        {
            var expression = rule.Configuration["expression"];
            var lambda = DynamicExpressionParser.ParseLambda<TEntity, bool>(
                ParsingConfig.Default,
                false,
                expression,
                new { UserId = _currentUser.Id }
            );
            
            return query.Where(lambda);
        }
    }
    
    /// <summary>
    /// æ•°æ®æƒé™è§„åˆ™
    /// </summary>
    public class DataPermissionRule : FullAuditedAggregateRoot<Guid>
    {
        public string Name { get; set; }
        public string EntityType { get; set; }
        public string Permission { get; set; }
        public DataPermissionType Type { get; set; }
        public int Priority { get; set; }
        public bool IsEnabled { get; set; }
        public Dictionary<string, string> Configuration { get; set; }
        public List<string> Roles { get; set; }
        public List<OrganizationUnit> OrganizationUnits { get; set; }
    }
    
    /// <summary>
    /// æ•°æ®æƒé™ç±»å‹
    /// </summary>
    public enum DataPermissionType
    {
        /// <summary>
        /// åŸºäºç»„ç»‡æœºæ„
        /// </summary>
        Organization,
        
        /// <summary>
        /// åŸºäºå±æ€§
        /// </summary>
        Property,
        
        /// <summary>
        /// åŸºäºå±‚çº§
        /// </summary>
        Hierarchical,
        
        /// <summary>
        /// è‡ªå®šä¹‰è¡¨è¾¾å¼
        /// </summary>
        Custom
    }
}

/// <summary>
/// æ•°æ®æƒé™æ‹¦æˆªå™¨
/// </summary>
[Dependency(ServiceLifetime.Scoped)]
public class DataPermissionInterceptor : AbpInterceptor
{
    private readonly DataPermissionManager _permissionManager;
    
    public override async Task InterceptAsync(IAbpMethodInvocation invocation)
    {
        var method = invocation.Method;
        var dataPermAttr = method.GetCustomAttribute<DataPermissionAttribute>();
        
        if (dataPermAttr != null)
        {
            // è·å–æŸ¥è¯¢å‚æ•°
            var queryParam = invocation.Arguments
                .FirstOrDefault(arg => arg is IQueryable);
            
            if (queryParam is IQueryable query)
            {
                // åº”ç”¨æ•°æ®æƒé™
                var filteredQuery = await _permissionManager.ApplyDataPermissions(
                    query,
                    dataPermAttr.Permission
                );
                
                // æ›¿æ¢åŸå§‹æŸ¥è¯¢
                var index = Array.IndexOf(invocation.Arguments, queryParam);
                invocation.Arguments[index] = filteredQuery;
            }
        }
        
        await invocation.ProceedAsync();
    }
}
```

### 2.2 æ•°æ®æƒé™é…ç½®UI

```vue
<!-- components/permission/DataPermissionConfigurator.vue -->
<template>
  <div class="data-permission-configurator">
    <div class="config-header">
      <h3>æ•°æ®æƒé™é…ç½®</h3>
      <Button @click="saveConfiguration" type="primary">ä¿å­˜é…ç½®</Button>
    </div>
    
    <div class="config-body">
      <!-- å®ä½“é€‰æ‹© -->
      <Card title="é€‰æ‹©æ•°æ®å®ä½“">
        <Select v-model="selectedEntity" @change="onEntityChange">
          <Option v-for="entity in entities" :key="entity.name" :value="entity.name">
            {{ entity.displayName }} ({{ entity.name }})
          </Option>
        </Select>
      </Card>
      
      <!-- æƒé™è§„åˆ™åˆ—è¡¨ -->
      <Card title="æ•°æ®æƒé™è§„åˆ™" v-if="selectedEntity">
        <div class="rule-list">
          <div v-for="rule in dataRules" :key="rule.id" class="rule-item">
            <div class="rule-header">
              <span class="rule-name">{{ rule.name }}</span>
              <Tag :type="rule.isEnabled ? 'success' : 'default'">
                {{ rule.isEnabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨' }}
              </Tag>
              <div class="rule-actions">
                <Button @click="editRule(rule)" size="small">ç¼–è¾‘</Button>
                <Button @click="deleteRule(rule)" size="small" type="danger">åˆ é™¤</Button>
              </div>
            </div>
            
            <div class="rule-content">
              <div class="rule-type">
                <Icon :name="getRuleIcon(rule.type)" />
                <span>{{ getRuleTypeName(rule.type) }}</span>
              </div>
              
              <div class="rule-config">
                <!-- ç»„ç»‡æœºæ„è§„åˆ™ -->
                <div v-if="rule.type === 'Organization'">
                  <Tag>èŒƒå›´: {{ rule.configuration.scope }}</Tag>
                  <span class="rule-desc">
                    {{ getScopeDescription(rule.configuration.scope) }}
                  </span>
                </div>
                
                <!-- å±æ€§è§„åˆ™ -->
                <div v-else-if="rule.type === 'Property'">
                  <code>{{ rule.configuration.property }} = {{ rule.configuration.value }}</code>
                </div>
                
                <!-- è‡ªå®šä¹‰è§„åˆ™ -->
                <div v-else-if="rule.type === 'Custom'">
                  <code>{{ rule.configuration.expression }}</code>
                </div>
              </div>
              
              <div class="rule-targets">
                <span>åº”ç”¨äºï¼š</span>
                <Tag v-for="role in rule.roles" :key="role">{{ role }}</Tag>
                <Tag v-for="org in rule.organizationUnits" :key="org.id">{{ org.name }}</Tag>
              </div>
            </div>
          </div>
        </div>
        
        <Button @click="addRule" type="dashed" block>
          <Icon name="plus" /> æ·»åŠ è§„åˆ™
        </Button>
      </Card>
      
      <!-- è§„åˆ™ç¼–è¾‘å™¨ -->
      <Modal v-model:visible="showRuleEditor" title="ç¼–è¾‘æ•°æ®æƒé™è§„åˆ™" width="800px">
        <Form :model="currentRule" :rules="ruleValidation">
          <FormItem label="è§„åˆ™åç§°" prop="name">
            <Input v-model="currentRule.name" placeholder="è¾“å…¥è§„åˆ™åç§°" />
          </FormItem>
          
          <FormItem label="è§„åˆ™ç±»å‹" prop="type">
            <RadioGroup v-model="currentRule.type">
              <Radio value="Organization">
                <div class="type-option">
                  <Icon name="building" />
                  <div>
                    <div class="option-title">ç»„ç»‡æœºæ„</div>
                    <div class="option-desc">åŸºäºéƒ¨é—¨å±‚çº§çš„æ•°æ®æƒé™</div>
                  </div>
                </div>
              </Radio>
              
              <Radio value="Property">
                <div class="type-option">
                  <Icon name="tag" />
                  <div>
                    <div class="option-title">å±æ€§è¿‡æ»¤</div>
                    <div class="option-desc">åŸºäºå­—æ®µå€¼çš„æ•°æ®è¿‡æ»¤</div>
                  </div>
                </div>
              </Radio>
              
              <Radio value="Hierarchical">
                <div class="type-option">
                  <Icon name="sitemap" />
                  <div>
                    <div class="option-title">å±‚çº§æ§åˆ¶</div>
                    <div class="option-desc">åŸºäºä¸Šä¸‹çº§å…³ç³»çš„æƒé™</div>
                  </div>
                </div>
              </Radio>
              
              <Radio value="Custom">
                <div class="type-option">
                  <Icon name="code" />
                  <div>
                    <div class="option-title">è‡ªå®šä¹‰è¡¨è¾¾å¼</div>
                    <div class="option-desc">ä½¿ç”¨è¡¨è¾¾å¼å®šä¹‰å¤æ‚è§„åˆ™</div>
                  </div>
                </div>
              </Radio>
            </RadioGroup>
          </FormItem>
          
          <!-- ç»„ç»‡æœºæ„é…ç½® -->
          <template v-if="currentRule.type === 'Organization'">
            <FormItem label="æ•°æ®èŒƒå›´">
              <Select v-model="currentRule.configuration.scope">
                <Option value="Self">ä»…æœ¬éƒ¨é—¨</Option>
                <Option value="SelfAndChildren">æœ¬éƒ¨é—¨åŠä¸‹çº§</Option>
                <Option value="All">å…¨éƒ¨é—¨</Option>
                <Option value="Custom">è‡ªå®šä¹‰</Option>
              </Select>
            </FormItem>
            
            <FormItem v-if="currentRule.configuration.scope === 'Custom'" 
                      label="é€‰æ‹©éƒ¨é—¨">
              <TreeSelect
                v-model="currentRule.configuration.organizations"
                :data="organizationTree"
                multiple
                show-checkbox />
            </FormItem>
          </template>
          
          <!-- å±æ€§è¿‡æ»¤é…ç½® -->
          <template v-else-if="currentRule.type === 'Property'">
            <FormItem label="è¿‡æ»¤å­—æ®µ">
              <Select v-model="currentRule.configuration.property">
                <Option v-for="field in entityFields" 
                        :key="field.name" 
                        :value="field.name">
                  {{ field.displayName }} ({{ field.name }})
                </Option>
              </Select>
            </FormItem>
            
            <FormItem label="åŒ¹é…æ–¹å¼">
              <Select v-model="currentRule.configuration.operator">
                <Option value="equals">ç­‰äº</Option>
                <Option value="notEquals">ä¸ç­‰äº</Option>
                <Option value="contains">åŒ…å«</Option>
                <Option value="in">åœ¨åˆ—è¡¨ä¸­</Option>
                <Option value="between">èŒƒå›´</Option>
              </Select>
            </FormItem>
            
            <FormItem label="åŒ¹é…å€¼">
              <Input v-if="currentRule.configuration.operator === 'equals'"
                     v-model="currentRule.configuration.value" />
              <Select v-else-if="currentRule.configuration.operator === 'in'"
                      v-model="currentRule.configuration.values"
                      multiple>
                <Option v-for="opt in getFieldOptions(currentRule.configuration.property)"
                        :key="opt.value" 
                        :value="opt.value">
                  {{ opt.label }}
                </Option>
              </Select>
            </FormItem>
          </template>
          
          <!-- è‡ªå®šä¹‰è¡¨è¾¾å¼ -->
          <template v-else-if="currentRule.type === 'Custom'">
            <FormItem label="è¿‡æ»¤è¡¨è¾¾å¼">
              <MonacoEditor
                v-model="currentRule.configuration.expression"
                language="csharp"
                :height="200"
                placeholder="ä¾‹å¦‚: x => x.CreatedBy == CurrentUser.Id" />
            </FormItem>
            
            <Alert type="info">
              <div class="expression-help">
                <div>å¯ç”¨å˜é‡ï¼š</div>
                <ul>
                  <li>CurrentUser - å½“å‰ç”¨æˆ·</li>
                  <li>CurrentTenant - å½“å‰ç§Ÿæˆ·</li>
                  <li>DateTime.Now - å½“å‰æ—¶é—´</li>
                </ul>
              </div>
            </Alert>
          </template>
          
          <!-- åº”ç”¨ç›®æ ‡ -->
          <FormItem label="åº”ç”¨äºè§’è‰²">
            <Select v-model="currentRule.roles" multiple>
              <Option v-for="role in availableRoles" 
                      :key="role.id" 
                      :value="role.name">
                {{ role.displayName }}
              </Option>
            </Select>
          </FormItem>
          
          <FormItem label="ä¼˜å…ˆçº§">
            <InputNumber v-model="currentRule.priority" :min="0" :max="100" />
            <span class="hint">æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span>
          </FormItem>
          
          <FormItem label="å¯ç”¨çŠ¶æ€">
            <Switch v-model="currentRule.isEnabled" />
          </FormItem>
        </Form>
        
        <template #footer>
          <Button @click="showRuleEditor = false">å–æ¶ˆ</Button>
          <Button @click="testRule" type="default">æµ‹è¯•è§„åˆ™</Button>
          <Button @click="saveRule" type="primary">ä¿å­˜</Button>
        </template>
      </Modal>
    </div>
  </div>
</template>
```

## ä¸‰ã€å¤šç§Ÿæˆ·å®Œæ•´éš”ç¦»

### 3.1 æ–‡ä»¶å­˜å‚¨å¤šç§Ÿæˆ·éš”ç¦»

```csharp
// Acme.BookStore.BlobStoring/TenantAwareBlobProvider.cs

using System;
using System.IO;
using System.Threading.Tasks;
using Volo.Abp.BlobStoring;
using Volo.Abp.MultiTenancy;

namespace Acme.BookStore.BlobStoring
{
    /// <summary>
    /// ç§Ÿæˆ·æ„ŸçŸ¥çš„æ–‡ä»¶å­˜å‚¨æä¾›è€…
    /// </summary>
    public class TenantAwareBlobProvider : BlobProviderBase
    {
        private readonly ICurrentTenant _currentTenant;
        private readonly IBlobProvider _innerProvider;
        
        public TenantAwareBlobProvider(
            ICurrentTenant currentTenant,
            IBlobProvider innerProvider)
        {
            _currentTenant = currentTenant;
            _innerProvider = innerProvider;
        }
        
        public override async Task SaveAsync(BlobProviderSaveArgs args)
        {
            // ä¿®æ”¹å­˜å‚¨è·¯å¾„ï¼ŒåŠ å…¥ç§Ÿæˆ·æ ‡è¯†
            var tenantPath = GetTenantPath(args.BlobName);
            var newArgs = new BlobProviderSaveArgs(
                args.ContainerName,
                args.Configuration,
                tenantPath,
                args.BlobStream,
                args.OverrideExisting,
                args.CancellationToken
            );
            
            await _innerProvider.SaveAsync(newArgs);
        }
        
        public override async Task<Stream> GetOrNullAsync(BlobProviderGetArgs args)
        {
            var tenantPath = GetTenantPath(args.BlobName);
            var newArgs = new BlobProviderGetArgs(
                args.ContainerName,
                args.Configuration,
                tenantPath,
                args.CancellationToken
            );
            
            return await _innerProvider.GetOrNullAsync(newArgs);
        }
        
        public override async Task<bool> DeleteAsync(BlobProviderDeleteArgs args)
        {
            var tenantPath = GetTenantPath(args.BlobName);
            var newArgs = new BlobProviderDeleteArgs(
                args.ContainerName,
                args.Configuration,
                tenantPath,
                args.CancellationToken
            );
            
            return await _innerProvider.DeleteAsync(newArgs);
        }
        
        public override async Task<bool> ExistsAsync(BlobProviderExistsArgs args)
        {
            var tenantPath = GetTenantPath(args.BlobName);
            var newArgs = new BlobProviderExistsArgs(
                args.ContainerName,
                args.Configuration,
                tenantPath,
                args.CancellationToken
            );
            
            return await _innerProvider.ExistsAsync(newArgs);
        }
        
        /// <summary>
        /// è·å–ç§Ÿæˆ·è·¯å¾„
        /// </summary>
        private string GetTenantPath(string blobName)
        {
            var tenantId = _currentTenant.Id?.ToString() ?? "host";
            return $"tenants/{tenantId}/{blobName}";
        }
    }
    
    /// <summary>
    /// é…ç½®æ‰©å±•
    /// </summary>
    public static class BlobStoringConfigurationExtensions
    {
        public static void ConfigureTenantIsolation(this BlobStoringOptions options)
        {
            options.Containers.ConfigureAll((containerName, containerConfig) =>
            {
                containerConfig.ProviderType = typeof(TenantAwareBlobProvider);
                containerConfig.IsMultiTenant = true;
                
                // é…ç½®ç§Ÿæˆ·çº§åˆ«çš„é…é¢
                containerConfig.Properties["MaxFileSize"] = 10 * 1024 * 1024; // 10MB
                containerConfig.Properties["MaxStorageSize"] = 1024 * 1024 * 1024; // 1GB
            });
        }
    }
}
```

### 3.2 æ¶ˆæ¯é˜Ÿåˆ—å¤šç§Ÿæˆ·éš”ç¦»

```csharp
// Acme.BookStore.MessageQueue/TenantAwareMessageQueue.cs

using System;
using System.Threading.Tasks;
using RabbitMQ.Client;
using Volo.Abp.MultiTenancy;
using Volo.Abp.RabbitMQ;

namespace Acme.BookStore.MessageQueue
{
    /// <summary>
    /// ç§Ÿæˆ·æ„ŸçŸ¥çš„æ¶ˆæ¯é˜Ÿåˆ—
    /// </summary>
    public class TenantAwareMessageQueue : IMessageQueue
    {
        private readonly ICurrentTenant _currentTenant;
        private readonly IChannelPool _channelPool;
        
        public async Task PublishAsync<T>(T message, string routingKey = null)
        {
            var tenantRoutingKey = GetTenantRoutingKey(routingKey);
            var channel = _channelPool.Get();
            
            try
            {
                var properties = channel.CreateBasicProperties();
                properties.Headers = properties.Headers ?? new Dictionary<string, object>();
                properties.Headers["TenantId"] = _currentTenant.Id?.ToString() ?? "host";
                
                var body = SerializeMessage(message);
                
                channel.BasicPublish(
                    exchange: GetExchangeName(),
                    routingKey: tenantRoutingKey,
                    basicProperties: properties,
                    body: body
                );
            }
            finally
            {
                _channelPool.Return(channel);
            }
        }
        
        public async Task<IMessageSubscription> SubscribeAsync<T>(
            Func<T, Task> handler,
            string queueName = null)
        {
            var tenantQueueName = GetTenantQueueName(queueName);
            var channel = _channelPool.Get();
            
            // å£°æ˜ç§Ÿæˆ·ä¸“ç”¨é˜Ÿåˆ—
            channel.QueueDeclare(
                queue: tenantQueueName,
                durable: true,
                exclusive: false,
                autoDelete: false,
                arguments: new Dictionary<string, object>
                {
                    ["x-message-ttl"] = 3600000, // 1å°æ—¶è¿‡æœŸ
                    ["x-max-length"] = 10000 // æœ€å¤§10000æ¡æ¶ˆæ¯
                }
            );
            
            // ç»‘å®šåˆ°äº¤æ¢æœº
            channel.QueueBind(
                queue: tenantQueueName,
                exchange: GetExchangeName(),
                routingKey: GetTenantRoutingKey("#")
            );
            
            var consumer = new TenantAwareConsumer<T>(
                channel,
                handler,
                _currentTenant
            );
            
            channel.BasicConsume(
                queue: tenantQueueName,
                autoAck: false,
                consumer: consumer
            );
            
            return new MessageSubscription(channel, consumer);
        }
        
        private string GetTenantQueueName(string baseName)
        {
            var tenantId = _currentTenant.Id?.ToString() ?? "host";
            return $"{baseName}.{tenantId}";
        }
        
        private string GetTenantRoutingKey(string baseKey)
        {
            var tenantId = _currentTenant.Id?.ToString() ?? "host";
            return $"{tenantId}.{baseKey ?? "*"}";
        }
    }
    
    /// <summary>
    /// ç§Ÿæˆ·æ„ŸçŸ¥çš„æ¶ˆè´¹è€…
    /// </summary>
    public class TenantAwareConsumer<T> : AsyncEventingBasicConsumer
    {
        private readonly Func<T, Task> _handler;
        private readonly ICurrentTenant _currentTenant;
        
        public override async Task HandleBasicDeliver(
            string consumerTag,
            ulong deliveryTag,
            bool redelivered,
            string exchange,
            string routingKey,
            IBasicProperties properties,
            ReadOnlyMemory<byte> body)
        {
            // éªŒè¯ç§Ÿæˆ·ID
            if (properties.Headers.TryGetValue("TenantId", out var tenantIdObj))
            {
                var messageTenantId = tenantIdObj?.ToString();
                var currentTenantId = _currentTenant.Id?.ToString() ?? "host";
                
                if (messageTenantId != currentTenantId)
                {
                    // æ‹’ç»ä¸å±äºå½“å‰ç§Ÿæˆ·çš„æ¶ˆæ¯
                    Channel.BasicReject(deliveryTag, false);
                    return;
                }
            }
            
            try
            {
                var message = DeserializeMessage<T>(body.ToArray());
                await _handler(message);
                Channel.BasicAck(deliveryTag, false);
            }
            catch (Exception ex)
            {
                // é”™è¯¯å¤„ç†
                Channel.BasicNack(deliveryTag, false, true);
                throw;
            }
        }
    }
}
```

### 3.3 å®šæ—¶ä»»åŠ¡ç§Ÿæˆ·æ„ŸçŸ¥

```csharp
// Acme.BookStore.BackgroundJobs/TenantAwareBackgroundJob.cs

using System;
using System.Threading.Tasks;
using Microsoft.Extensions.DependencyInjection;
using Volo.Abp.BackgroundJobs;
using Volo.Abp.MultiTenancy;
using Volo.Abp.Uow;

namespace Acme.BookStore.BackgroundJobs
{
    /// <summary>
    /// ç§Ÿæˆ·æ„ŸçŸ¥çš„åå°ä»»åŠ¡åŸºç±»
    /// </summary>
    public abstract class TenantAwareBackgroundJob<TArgs> : AsyncBackgroundJob<TArgs>
    {
        protected ICurrentTenant CurrentTenant { get; }
        protected IUnitOfWorkManager UnitOfWorkManager { get; }
        
        protected TenantAwareBackgroundJob()
        {
            CurrentTenant = LazyServiceProvider.LazyGetRequiredService<ICurrentTenant>();
            UnitOfWorkManager = LazyServiceProvider.LazyGetRequiredService<IUnitOfWorkManager>();
        }
        
        public override async Task ExecuteAsync(TArgs args)
        {
            // è·å–ä»»åŠ¡çš„ç§Ÿæˆ·ID
            var tenantId = GetTenantId(args);
            
            // åˆ‡æ¢åˆ°æŒ‡å®šç§Ÿæˆ·ä¸Šä¸‹æ–‡
            using (CurrentTenant.Change(tenantId))
            {
                using (var uow = UnitOfWorkManager.Begin())
                {
                    await ExecuteInTenantContextAsync(args);
                    await uow.CompleteAsync();
                }
            }
        }
        
        /// <summary>
        /// è·å–ä»»åŠ¡çš„ç§Ÿæˆ·ID
        /// </summary>
        protected virtual Guid? GetTenantId(TArgs args)
        {
            if (args is ITenantIdentifiable tenantArgs)
            {
                return tenantArgs.TenantId;
            }
            
            return null;
        }
        
        /// <summary>
        /// åœ¨ç§Ÿæˆ·ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
        /// </summary>
        protected abstract Task ExecuteInTenantContextAsync(TArgs args);
    }
    
    /// <summary>
    /// ç§Ÿæˆ·æ„ŸçŸ¥çš„å®šæ—¶ä»»åŠ¡
    /// </summary>
    public abstract class TenantAwareRecurringJob : IRecurringJob
    {
        private readonly ICurrentTenant _currentTenant;
        private readonly ITenantRepository _tenantRepository;
        
        public async Task ExecuteAsync()
        {
            // è·å–æ‰€æœ‰æ´»è·ƒç§Ÿæˆ·
            var tenants = await _tenantRepository.GetListAsync(t => t.IsActive);
            
            // ä¸ºæ¯ä¸ªç§Ÿæˆ·æ‰§è¡Œä»»åŠ¡
            foreach (var tenant in tenants)
            {
                try
                {
                    using (_currentTenant.Change(tenant.Id))
                    {
                        await ExecuteForTenantAsync(tenant);
                    }
                }
                catch (Exception ex)
                {
                    // è®°å½•é”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªç§Ÿæˆ·
                    Logger.LogError(ex, $"Error executing job for tenant {tenant.Id}");
                }
            }
            
            // ä¸ºä¸»æœºæ‰§è¡Œ
            using (_currentTenant.Change(null))
            {
                await ExecuteForHostAsync();
            }
        }
        
        protected abstract Task ExecuteForTenantAsync(Tenant tenant);
        protected virtual Task ExecuteForHostAsync() => Task.CompletedTask;
    }
    
    /// <summary>
    /// ç¤ºä¾‹ï¼šç§Ÿæˆ·æ•°æ®æ¸…ç†ä»»åŠ¡
    /// </summary>
    public class TenantDataCleanupJob : TenantAwareRecurringJob
    {
        private readonly IDataCleanupService _cleanupService;
        
        protected override async Task ExecuteForTenantAsync(Tenant tenant)
        {
            // æ¸…ç†ç§Ÿæˆ·çš„è¿‡æœŸæ•°æ®
            await _cleanupService.CleanupExpiredData();
            
            // æ¸…ç†ç§Ÿæˆ·çš„ä¸´æ—¶æ–‡ä»¶
            await _cleanupService.CleanupTempFiles();
            
            // ä¼˜åŒ–ç§Ÿæˆ·çš„æ•°æ®åº“
            await _cleanupService.OptimizeDatabase();
        }
    }
}
```

## å››ã€æ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿ

### 4.1 æŸ¥è¯¢ä¼˜åŒ–å™¨

```csharp
// Acme.BookStore.Performance/QueryOptimizer.cs

using System;
using System.Collections.Generic;
using System.Linq;
using System.Linq.Expressions;
using Microsoft.EntityFrameworkCore;

namespace Acme.BookStore.Performance
{
    /// <summary>
    /// æŸ¥è¯¢ä¼˜åŒ–å™¨
    /// </summary>
    public class QueryOptimizer<TEntity> where TEntity : class
    {
        private readonly DbContext _context;
        private IQueryable<TEntity> _query;
        private readonly List<Expression<Func<TEntity, object>>> _includes;
        private readonly List<string> _thenIncludes;
        
        public QueryOptimizer(DbContext context)
        {
            _context = context;
            _query = _context.Set<TEntity>();
            _includes = new List<Expression<Func<TEntity, object>>>();
            _thenIncludes = new List<string>();
        }
        
        /// <summary>
        /// æ™ºèƒ½Include - é¿å…N+1é—®é¢˜
        /// </summary>
        public QueryOptimizer<TEntity> SmartInclude(
            Expression<Func<TEntity, object>> navigationProperty,
            bool useProjection = false)
        {
            if (useProjection)
            {
                // ä½¿ç”¨æŠ•å½±è€Œä¸æ˜¯Include
                _query = _query.Select(BuildProjection(navigationProperty));
            }
            else
            {
                // åˆ†ææ˜¯å¦ä¼šå¯¼è‡´ç¬›å¡å°”ç§¯
                if (!WillCauseCartesianProduct(navigationProperty))
                {
                    _query = _query.Include(navigationProperty);
                }
                else
                {
                    // ä½¿ç”¨åˆ†ç¦»æŸ¥è¯¢é¿å…ç¬›å¡å°”ç§¯
                    _includes.Add(navigationProperty);
                }
            }
            
            return this;
        }
        
        /// <summary>
        /// æ‰¹é‡åŠ è½½ - é¿å…ç¬›å¡å°”ç§¯
        /// </summary>
        public async Task<List<TEntity>> ExecuteWithSplitQuery()
        {
            // ä¸»æŸ¥è¯¢
            var entities = await _query.ToListAsync();
            
            if (entities.Any() && _includes.Any())
            {
                var ids = entities.Select(e => GetId(e)).ToList();
                
                // åˆ†ç¦»æŸ¥è¯¢æ¯ä¸ªå¯¼èˆªå±æ€§
                foreach (var include in _includes)
                {
                    await LoadNavigationProperty(ids, include);
                }
            }
            
            return entities;
        }
        
        /// <summary>
        /// è‡ªåŠ¨æ·»åŠ ç´¢å¼•å»ºè®®
        /// </summary>
        public List<IndexSuggestion> AnalyzeAndSuggestIndexes()
        {
            var suggestions = new List<IndexSuggestion>();
            var queryString = _query.ToQueryString();
            
            // åˆ†æWHEREå­å¥
            var whereColumns = ExtractWhereColumns(queryString);
            foreach (var column in whereColumns)
            {
                if (!HasIndex(column))
                {
                    suggestions.Add(new IndexSuggestion
                    {
                        TableName = typeof(TEntity).Name,
                        ColumnName = column,
                        Type = "NONCLUSTERED",
                        Reason = "Frequent WHERE clause usage"
                    });
                }
            }
            
            // åˆ†æJOINæ¡ä»¶
            var joinColumns = ExtractJoinColumns(queryString);
            foreach (var column in joinColumns)
            {
                if (!HasIndex(column))
                {
                    suggestions.Add(new IndexSuggestion
                    {
                        TableName = typeof(TEntity).Name,
                        ColumnName = column,
                        Type = "NONCLUSTERED",
                        Reason = "JOIN condition"
                    });
                }
            }
            
            // åˆ†æORDER BY
            var orderByColumns = ExtractOrderByColumns(queryString);
            if (orderByColumns.Any())
            {
                suggestions.Add(new IndexSuggestion
                {
                    TableName = typeof(TEntity).Name,
                    ColumnNames = orderByColumns,
                    Type = "NONCLUSTERED",
                    IncludeColumns = whereColumns,
                    Reason = "Covering index for sorting"
                });
            }
            
            return suggestions;
        }
        
        /// <summary>
        /// åº”ç”¨åˆ†é¡µä¼˜åŒ–
        /// </summary>
        public QueryOptimizer<TEntity> OptimizedPaging(
            int skipCount, 
            int maxResultCount,
            Expression<Func<TEntity, object>> orderBy)
        {
            if (skipCount > 1000)
            {
                // å¤§åç§»é‡ä¼˜åŒ– - ä½¿ç”¨é”®é›†åˆ†é¡µ
                _query = ApplyKeysetPagination(skipCount, maxResultCount, orderBy);
            }
            else
            {
                // æ ‡å‡†åˆ†é¡µ
                _query = _query
                    .OrderBy(orderBy)
                    .Skip(skipCount)
                    .Take(maxResultCount);
            }
            
            return this;
        }
        
        /// <summary>
        /// ç¼“å­˜æŸ¥è¯¢ç»“æœ
        /// </summary>
        public async Task<List<TEntity>> ExecuteWithCache(
            string cacheKey,
            TimeSpan? expiration = null)
        {
            var cached = await CacheManager.GetAsync<List<TEntity>>(cacheKey);
            if (cached != null)
            {
                return cached;
            }
            
            var result = await _query.ToListAsync();
            
            await CacheManager.SetAsync(
                cacheKey, 
                result, 
                expiration ?? TimeSpan.FromMinutes(5)
            );
            
            return result;
        }
    }
    
    /// <summary>
    /// ç´¢å¼•å»ºè®®
    /// </summary>
    public class IndexSuggestion
    {
        public string TableName { get; set; }
        public string ColumnName { get; set; }
        public List<string> ColumnNames { get; set; }
        public List<string> IncludeColumns { get; set; }
        public string Type { get; set; }
        public string Reason { get; set; }
        
        public string GenerateSQL()
        {
            var columns = ColumnNames?.Any() == true 
                ? string.Join(", ", ColumnNames) 
                : ColumnName;
                
            var indexName = $"IX_{TableName}_{columns.Replace(", ", "_")}";
            
            var sql = $"CREATE {Type} INDEX {indexName} ON {TableName} ({columns})";
            
            if (IncludeColumns?.Any() == true)
            {
                sql += $" INCLUDE ({string.Join(", ", IncludeColumns)})";
            }
            
            return sql;
        }
    }
}

/// <summary>
/// æŸ¥è¯¢æ€§èƒ½åˆ†æå™¨
/// </summary>
public class QueryPerformanceAnalyzer
{
    private readonly ILogger<QueryPerformanceAnalyzer> _logger;
    private readonly Dictionary<string, QueryMetrics> _metrics;
    
    public async Task<T> MeasureQuery<T>(
        Func<Task<T>> queryFunc,
        string queryName)
    {
        var stopwatch = Stopwatch.StartNew();
        var memoryBefore = GC.GetTotalMemory(false);
        
        try
        {
            var result = await queryFunc();
            
            stopwatch.Stop();
            var memoryAfter = GC.GetTotalMemory(false);
            
            var metrics = new QueryMetrics
            {
                QueryName = queryName,
                ExecutionTime = stopwatch.ElapsedMilliseconds,
                MemoryUsed = memoryAfter - memoryBefore,
                Timestamp = DateTime.UtcNow
            };
            
            // è®°å½•æŒ‡æ ‡
            _metrics[queryName] = metrics;
            
            // å¦‚æœæŸ¥è¯¢å¤ªæ…¢ï¼Œè®°å½•è­¦å‘Š
            if (metrics.ExecutionTime > 1000)
            {
                _logger.LogWarning(
                    $"Slow query detected: {queryName} took {metrics.ExecutionTime}ms"
                );
            }
            
            return result;
        }
        catch (Exception ex)
        {
            stopwatch.Stop();
            _logger.LogError(ex, $"Query failed: {queryName}");
            throw;
        }
    }
    
    /// <summary>
    /// è·å–æ€§èƒ½æŠ¥å‘Š
    /// </summary>
    public PerformanceReport GenerateReport()
    {
        return new PerformanceReport
        {
            SlowQueries = _metrics.Values
                .Where(m => m.ExecutionTime > 500)
                .OrderByDescending(m => m.ExecutionTime)
                .ToList(),
                
            MemoryIntensiveQueries = _metrics.Values
                .Where(m => m.MemoryUsed > 10 * 1024 * 1024) // 10MB
                .OrderByDescending(m => m.MemoryUsed)
                .ToList(),
                
            QueryStatistics = _metrics.Values
                .GroupBy(m => m.QueryName)
                .Select(g => new QueryStatistic
                {
                    QueryName = g.Key,
                    CallCount = g.Count(),
                    AvgExecutionTime = g.Average(m => m.ExecutionTime),
                    MaxExecutionTime = g.Max(m => m.ExecutionTime),
                    MinExecutionTime = g.Min(m => m.ExecutionTime)
                })
                .ToList()
        };
    }
}
```

## æ€»ç»“

é€šè¿‡è¿™äº›å…³é”®åŠŸèƒ½çš„å®ç°ï¼Œæˆ‘ä»¬çš„ä½ä»£ç å¹³å°ç°åœ¨å…·å¤‡äº†ï¼š

### âœ… å·²å®Œæˆçš„æ ¸å¿ƒåŠŸèƒ½

1. **æ¡ä»¶æƒé™ç³»ç»Ÿ** - æ”¯æŒ"åªèƒ½ç¼–è¾‘è‡ªå·±åˆ›å»ºçš„"ç­‰åŠ¨æ€æƒé™
2. **æ•°æ®æƒé™å¼•æ“** - æ”¯æŒåŸºäºéƒ¨é—¨ã€å±æ€§ã€è‡ªå®šä¹‰è¡¨è¾¾å¼çš„æ•°æ®è¿‡æ»¤
3. **å®Œæ•´çš„å¤šç§Ÿæˆ·éš”ç¦»** - æ–‡ä»¶ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å®šæ—¶ä»»åŠ¡éƒ½å®ç°äº†ç§Ÿæˆ·æ„ŸçŸ¥
4. **æ€§èƒ½ä¼˜åŒ–ç³»ç»Ÿ** - è‡ªåŠ¨æŸ¥è¯¢ä¼˜åŒ–ã€ç´¢å¼•å»ºè®®ã€æ€§èƒ½ç›‘æ§

### ğŸ“Š å¹³å°è¯„åˆ†æå‡

| åŠŸèƒ½æ¨¡å—     | ä¹‹å‰  | ç°åœ¨   | æå‡  |
| ------------ | ----- | ------ | ----- |
| æ¡ä»¶æƒé™     | âŒ 0åˆ† | âœ… 10åˆ† | +10åˆ† |
| æ•°æ®æƒé™     | âŒ 0åˆ† | âœ… 10åˆ† | +10åˆ† |
| æ–‡ä»¶éš”ç¦»     | âš ï¸ 3åˆ† | âœ… 10åˆ† | +7åˆ†  |
| æ¶ˆæ¯é˜Ÿåˆ—éš”ç¦» | âŒ 0åˆ† | âœ… 10åˆ† | +10åˆ† |
| å®šæ—¶ä»»åŠ¡éš”ç¦» | âŒ 0åˆ† | âœ… 10åˆ† | +10åˆ† |
| æ€§èƒ½ä¼˜åŒ–     | âš ï¸ 5åˆ† | âœ… 9åˆ†  | +4åˆ†  |

**æ€»è¯„åˆ†ï¼šä»85åˆ†æå‡åˆ°95åˆ†ï¼**

### ğŸ¯ ä½¿ç”¨å»ºè®®

ç°åœ¨è¿™ä¸ªå¹³å°çœŸæ­£è¾¾åˆ°äº†**ä¼ä¸šçº§**æ°´å‡†ï¼š

- æƒé™æ§åˆ¶ç²¾ç»†åˆ°è¡Œçº§
- å¤šç§Ÿæˆ·éš”ç¦»å®Œæ•´å¯é 
- æ€§èƒ½ä¼˜åŒ–è‡ªåŠ¨è¿›è¡Œ
- é€‚åˆæ„å»ºå¤æ‚çš„ä¼ä¸šåº”ç”¨

å‰©ä½™çš„5åˆ†ç•™ç»™æœªæ¥çš„AIå¢å¼ºå’Œæ›´æ™ºèƒ½çš„è‡ªåŠ¨åŒ–åŠŸèƒ½ã€‚