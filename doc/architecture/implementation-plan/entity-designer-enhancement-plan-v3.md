# 实体设计器增强计划 V3 (Entity Designer Enhancement Plan V3)

## 1. 概述

本计划（V3）是基于对现有 `SmartAbp.CodeGenerator` 后端代码生成服务的发现而制定的修订版方案。先前版本（V2）侧重于在前端实现完整的代码生成逻辑，而本计划将核心重点转向 **前端体验优化、核心功能完善** 以及 **与现有后端生成服务的精准对接**。

计划的目标不变：将实体设计器（Entity Designer）提升至2025年业界主流低代码引擎的核心组件水平。

## 2. 核心分析结论

1.  **后端API已存在**: 后端已提供一个位于 `[POST] /api/code-generator/generate-entity` 的代码生成端点。
2.  **数据模型不匹配**: 前端UI所使用的 `EnhancedEntityModel` 类型定义（位于 `packages/lowcode-designer/src/types/index.ts`）与后端API所需的 `EntityDefinitionDto` 存在显著差异。前端模型更为详尽，包含了后端当前无法处理的验证规则、关系细节、UI配置等。
3.  **核心任务**: 开发工作的关键挑战在于 **弥合前后端数据模型的差异**，并通过一个高效的数据映射层（Data Mapper）实现无缝集成。

## 3. 重构与开发原则

*   **务实优先**：聚焦核心功能（实体、属性、关系、验证），确保核心链路稳定可靠。
*   **渐进式重构**：分阶段实施，确保每个阶段都可交付、可测试、可演示。
*   **用户体验为核心**：确保设计器界面直观、交互流畅、性能稳定。
*   **API驱动开发**：前端开发与后端API的契约紧密对齐，确保生成代码的质量符合企业级标准和ABP框架规范。

## 4. 详细开发计划

### 阶段一：架构清理与基础建设（1周）

*   **P0 - 统一类型系统**:
    *   **任务**: 彻底废弃并删除 `packages/lowcode-core/src/types/entity-designer.ts`，解决类型定义冲突问题。
    *   **行动**: 重构所有相关代码，确保仅从 `packages/lowcode-designer/src/types` 导入类型定义，建立唯一的“事实来源”。
    *   **估时**: 0.5天
*   **P0 - 重构状态管理**:
    *   **任务**: 引入 Pinia，创建一个 `useEntityDesignerStore` 来集中管理设计器的所有状态，包括实体模型、UI状态、历史记录等。
    *   **行动**: 将 `EntityDesigner.vue` 及其子组件中的本地 `reactive` 状态迁移至该 Pinia store，实现状态的集中化和可预测化。
    *   **估时**: 2天
*   **P1 - 增强类型安全**:
    *   **任务**: 消除代码库中的 `any` 类型断言，特别是在 `RelationshipDesigner.vue` 和 `useRelationshipDesigner.ts` 中。
    *   **行动**: 为组件的 props 和 emits 创建严格的 TypeScript 接口，确保端到端的类型安全。
    *   **估时**: 1天
*   **P1 - 建立测试基础**:
    *   **任务**: 为 `lowcode-designer` 包配置 Vitest 和 Vue Test Utils 测试环境。
    *   **行动**: 为新创建的 Pinia store 编写第一批单元测试，覆盖其核心 `actions` 和 `mutations`。
    *   **估时**: 1.5天

### 阶段二：关系建模功能完善（2周）

*   **P0 - 实现 `RelationshipConfigForm.vue`**:
    *   **任务**: 开发一个专用的关系配置表单组件。
    *   **行动**: 表单需包含关系类型（一对一、一对多等）、导航属性、外键字段名、级联删除策略等配置项，并提供输入校验。
    *   **估时**: 4天
*   **P0 - 集成关系配置面板**:
    *   **任务**: 将 `RelationshipConfigForm` 集成到 `RelationshipDesigner.vue` 的侧边栏中。
    *   **行动**: 实现当用户在画布上选中一条关系线时，表单自动填充该关系的数据；表单数据的任何变更都应实时同步回 Pinia store。
    *   **估时**: 2天
*   **P1 - 视觉与交互优化**:
    *   **任务**: 优化关系连线的视觉表现。
    *   **行动**: 使用不同的SVG线端样式（例如箭头、圆圈）来清晰地区分“一”和“多”的关系。
    *   **估时**: 2天
*   **P2 - 编写测试用例**:
    *   **任务**: 为关系建模功能添加单元测试和集成测试。
    *   **行动**: 测试 `RelationshipConfigForm` 的验证逻辑，并覆盖从“选择关系”到“更新配置”的完整用户流程。
    *   **估时**: 2天

### 阶段三：验证规则系统重构（2周）

*   **P0 - 重建 `ValidationRuleDesigner.vue`**:
    *   **任务**: 重新架构验证规则设计器，使其支持动态组件渲染。
    *   **行动**: 基于所选的规则类型（如`Required`, `StringLength`），动态加载并渲染对应的专用配置组件。
    *   **估时**: 2天
*   **P0 - 开发专用规则配置组件**:
    *   **任务**: 开发 `RequiredRuleConfig.vue`, `StringLengthRuleConfig.vue`, `RangeRuleConfig.vue`, `RegexRuleConfig.vue` 等一系列小型配置组件。
    *   **行动**: 每个组件都是一个高度定制化的微型表单，用于配置特定规则的参数。
    *   **估时**: 4天
*   **P1 - 实现智能规则推荐**:
    *   **任务**: 根据属性的数据类型，动态推荐可用的验证规则。
    *   **行动**: 例如，`StringLength` 规则只应在属性类型为 `string` 时可用。同时增加规则间的冲突检测逻辑。
    *   **估时**: 2天
*   **P2 - 编写测试用例**:
    *   **任务**: 为所有新创建的规则配置组件编写单元测试。
    *   **估时**: 2天

### 阶段四：后端API集成（2周）

*   **P0 - 创建前端API客户端**:
    *   **任务**: 在 `packages/lowcode-api/` 目录下创建 `code-generator.ts` 服务文件。
    *   **行动**: 定义一个 `generateEntity` 函数，负责调用后端 `POST /api/code-generator/generate-entity` 接口。
    *   **估时**: 2天
*   **P0 - 实现数据映射器 (Data Mapper)**:
    *   **任务**: 编写 `mapEnhancedEntityToDefinitionDto` 函数，这是本阶段的**核心任务**。
    *   **行动**: 该函数负责将前端丰富的 `EnhancedEntityModel` 对象转换为后端API所需的 `EntityDefinitionDto` 格式，处理两者之间的结构差异。初期可以忽略后端不支持的字段。
    *   **估时**: 4天
*   **P0 - UI与API对接**:
    *   **任务**: 将新的API客户端集成到 `EntityDesigner.vue` 中。
    *   **行动**: 当用户点击“生成”按钮时，调用 `generateEntity` 服务，并将从 Pinia store 中获取的实体模型作为参数。将API返回的生成代码展示在 `EnhancedCodePreview.vue` 组件中。
    *   **估时**: 2天
*   **P1 - 推动后端DTO增强 (协作任务)**:
    *   **任务**: 与后端团队沟通，推动 `EntityDefinitionDto` 的升级。
    *   **行动**: 提交需求，建议在后端DTO中增加对验证规则（`ValidationRules`）和更详细关系（`Relationships`）的支持，以便未来能够生成更精确的代码。
    *   **估时**: 2天 (用于后端完成后，前端适配新DTO的工作)

### 阶段五：用户体验与优化（1周）

*   **P1 - 实现撤销/重做功能**:
    *   **任务**: 为 Pinia store 增加历史状态快照（History）机制。
    *   **行动**: 实现 `undo` 和 `redo` action，允许用户在最近的操作历史中进行导航。
    *   **估时**: 2天
*   **P1 - 性能优化**:
    *   **任务**: 评估并优化关系画布在处理大量实体（如50+）时的渲染性能。
    *   **行动**: 采用虚拟化、事件防抖（debouncing）等技术减少不必要的渲染开销。
    *   **估时**: 1.5天
*   **P2 - 增加键盘快捷键**:
    *   **任务**: 为核心操作添加快捷键支持。
    *   **行动**: 实现 `Ctrl+Z` (撤销), `Ctrl+Y` (重做), `Delete` (删除选中项) 等常用快捷键。
    *   **估时**: 1.5天

## 5. 风险评估与缓解策略

*   **风险 1：状态管理复杂性**
    *   **描述**: 随着功能增加，单一的 Pinia store 可能会变得过于臃肿和复杂。
    *   **缓解策略**: 采用 Pinia 的模块化设计，将状态拆分到不同的模块中（如 `entityState`, `uiState`, `historyState`），并坚持使用严格的 `action` 来变更状态。
*   **风险 2：画布渲染性能**
    *   **描述**: 在关系设计器中渲染大量的SVG/HTML节点可能会导致性能下降，影响用户体验。
    *   **缓解策略**: 采用性能优化策略，如虚拟化渲染（只渲染视口内的节点）、对拖拽事件进行防抖处理。若性能问题依然存在，可考虑引入专用的Canvas渲染库（如 Konva.js）。
*   **风险 3：前后端数据模型不匹配**
    *   **描述**: 这是当前最大的风险。如果数据映射逻辑处理不当，或后端API无法按时升级，将导致设计器的许多高级功能无法转化为最终生成的代码。
    *   **缓解策略**: 保持与后端团队的密切沟通，将DTO的升级作为高优先级任务推进。在前端，数据映射层需要编写完善的单元测试，确保转换逻辑的正确性。
*   **风险 4：范围蔓延**
    *   **描述**: 设计器面向用户，很容易在开发过程中收到各种“小功能”请求，从而影响核心计划的进度。
    *   **缓解策略**: 严格遵守已定义的阶段性计划。将所有非核心的体验优化需求（如画布缩放、多选等）明确放入待办列表，并沟通说明将在核心功能全部稳定交付后再进行排期。

## 6. 验收标准

### 功能完整性
- [ ] 支持完整的实体属性配置（包括名称、类型、是否必须等）
- [ ] 可视化的关系建模（一对一、一对多、多对多），并支持详细配置
- [ ] 智能的、基于属性类型的验证规则系统
- [ ] 能够成功调用后端API，生成符合企业级标准的代码（实体、仓储、应用服务、DTO）
- [ ] 提供实时的多文件代码预览和基础验证

### 代码质量
- [ ] TypeScript 类型定义覆盖率 > 95%
- [ ] 核心逻辑的单元测试覆盖率 > 80%
- [ ] 所有代码均通过 ESLint/Prettier 规范检查
- [ ] 无重大性能瓶颈，交互流畅

### 用户体验
- [ ] 核心操作的响应时间 < 200ms
- [ ] 支持撤销/重做功能
- [ ] 提供完整的错误提示和用户引导
- [ ] 操作流程直观，符合用户预期

## 7. 不开发范围 (Out of Scope)

*   AI 智能辅助设计与代码生成
*   多人在线实时协作
*   插件化与可扩展架构
