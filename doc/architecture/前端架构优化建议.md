# 前端架构优化建议（SmartAbp.Vue）

版本：v0.1 ｜ 状态：草案 ｜ 适用范围：`src/SmartAbp.Vue`

## 1. 现状体检（基于代码仓库）

- 技术栈：Vue 3 + TypeScript + Pinia + Vue Router + Vite + Element Plus
- 目录：`src/SmartAbp.Vue/src` 下包含 `components、views、stores、utils、styles、router、composables、plugins`。
- 关键实现：
  - 应用入口：`src/SmartAbp.Vue/src/main.ts`
  - 路由：`src/SmartAbp.Vue/src/router/index.ts`
  - 认证：`src/SmartAbp.Vue/src/utils/auth.ts`（生产方案，对接 OpenIddict Password/Refresh Flow）与 `src/stores/auth.ts`（演示/Mock 登录）并存
  - HTTP 封装：`src/SmartAbp.Vue/src/utils/api.ts`
  - Vite 代理：`src/SmartAbp.Vue/vite.config.ts`（将 `/connect|/api|/swagger|/health-status` 代理到后端）

## 2. 主要缺陷（聚焦模块化、组件化、结构化、工程化）

1) 模块边界松散，功能散落在 `components/` 与 `views/` 下，缺少“按业务域组织”的边界与可插拔性。
- 症状：`system、projects、logs` 等功能的页面/组件、store、服务、路由分散，难以按“功能模块”整体复用与发布。

2) 认证实现重复且规范不一（演示 Store 与生产 AuthService 并存）。
- 影响：存在两套登录逻辑与状态来源，容易造成鉴权状态不一致、可维护性差。
- 证据：`src/stores/auth.ts` 为演示 Mock；`src/utils/auth.ts` 为真正对接 OpenIddict。

3) HTTP 封装存在分歧与边界不清，缺乏“强类型 API 客户端”。
- 影响：请求/响应类型不统一、缺少全局错误码与重试熔断策略；对后端 DTO 改动敏感且无编译期保障。
- 现状：代码使用 `fetch` 封装，但仓库存在 `axios` 依赖与集成文档，两者未统一。

4) 权限体系前端静态化，未对接后端权限树与菜单/路由动态化。
- 影响：权限与路由/菜单脱耦，无法根据租户/角色动态裁剪页面，后续自动生成难以落地。
- 现状：`router/index.ts` 以 `meta.requiresAuth/requiredRoles` 静态字段控制。

5) 多租户上下文透传不一致。
- 影响：登录时在头中附加 `__tenant`，但业务请求未统一附加；跨租户操作与切换体验不一致。

6) 国际化基础缺失。
- 影响：企业级 SaaS 多语言通常是标配；当前未集成 `vue-i18n` 与按模块拆分的多语言包。

7) 设计系统与样式 Token 分散，组件库（Element Plus）与自研样式结合缺少统一层。
- 影响：主题切换、品牌色/密度/尺寸策略难以系统化复用；CSS 组织与组件库样式覆盖策略不统一。

8) 目录结构偏“页面驱动”，缺少面向领域的可扩展骨架与“模块装配层”。
- 影响：后续“代码自动生成”无法把页面、服务、store、路由成组生成并装配。

9) 工程化能力有缺口。
- 缺少：OpenAPI → TS 客户端自动生成；模块脚手架（plop/hygen）；lint-staged 规则；包分析与分包策略；Sentry/日志上报；运行时配置注入等。

10) 测试金字塔不完整。
- 虽已有 Vitest/Cypress，但欠缺“模块模板化测试”与关键层（路由守卫、权限指令、HTTP 拦截器）的标准用例。

11) 运行时配置与环境管理不足。
- 影响：`API_BASE_URL` 回退到 `window.location.origin`，对多环境/多租户/多区域部署不友好，期望支持“无需重构即可变更配置”。

12) 性能工程不足。
- 缺少：按业务模块切分 chunk 的明确策略、图标与三方库分包、预加载/懒加载策略、打包体积分析与基准。

## 3. 目标蓝图：企业级 SaaS 前端基线

- 采用“领域/功能切片”（Feature-Sliced Design，FSD）的模块化结构：
```
src/
  core/                 # 核心设施层（可复用基础）
    config/             # 运行时配置与环境解析
    http/               # 统一 HTTP 客户端（axios）与拦截器
    auth/               # 认证/OIDC 与多租户上下文
    i18n/               # 国际化与按模块懒加载
    router/             # 路由守卫、动态路由装配
    store/              # Pinia 启动与插件（持久化等）
    ui/                 # 设计系统适配层（主题、尺寸、密度、暗色）
  modules/
    system/             # 领域模块：系统管理
      pages/
      components/
      services/
      stores/
      types/
      routes.ts
      i18n/
    projects/
    logs/
  app/
    app.vue
    main.ts
    routes.ts           # 汇总各模块 routes 并装配
    layout/
```

- 设计原则：强类型、契约先行（OpenAPI → TS）、按模块自治、可插拔、低耦合；统一的错误/权限/主题/日志策略；自动生成优先。

## 4. 落地方案（12 个方面）

1) HTTP 客户端统一（axios + 强类型）
- 做法：在 `core/http` 建立 `httpClient.ts`，统一实例、重试/熔断、错误码映射、超时与取消；从 `utils/api.ts` 迁移并删除重复实现。
- 强类型：集成 `openapi-typescript-codegen` 或 ABP CLI 的 TypeScript 代理生成，生成到 `core/api`。
- 收益：编译期保障、变更可控、错误观测统一。

2) 认证与多租户统一
- 做法：仅保留 `utils/auth.ts` 能力，封装为 `core/auth`，提供 `getAuthHeader()`、`getTenantHeader()`；HTTP 拦截器全局注入 `Authorization` 与 `__tenant`。
- 移除/迁移：废弃 `stores/auth.ts` 的 Mock；将“选择租户”的 UI/状态持久化，提供租户切换事件总线。

3) 权限、菜单与路由动态化
- 做法：启动时拉取后端权限/菜单（如 ABP 权限与导航），构建“权限树”，生成动态路由与侧边菜单；提供 `v-permission` 指令与 `usePermission()`。
- 收益：与后端权限保持一致；支持按租户/角色裁剪；支撑自动生成路由。

4) 国际化（vue-i18n + 模块懒加载）
- 做法：集成 `vue-i18n`，在 `core/i18n` 定义基础设施；各 `modules/*/i18n` 放置按语言拆分的消息包，路由进入时按需加载。
- 收益：SaaS 多语言支持；支撑自动生成翻译占位。

5) 设计系统适配层
- 做法：将现有 tokens（`styles/design-system/tokens/*`）上收为 `core/ui/tokens`，统一暴露 CSS Vars；封装 Element Plus 主题变量与密度/尺寸方案；提供 `DesignProvider` 组件。
- 收益：跨模块一致风格；主题切换更稳；便于在自动生成时套用统一样式。

6) 目录与模块骨架
- 做法：将 `views/` 与 `components/` 中的领域页面归位到 `modules/<feature>`；每个模块内自带 `pages/components/services/stores/types/routes.ts/i18n`。
- 收益：高内聚、易于分包与发布；自然支撑“模块脚手架自动生成”。

7) 工程化与脚手架
- 做法：
  - OpenAPI 生成：
    - 依赖：`npm i -D openapi-typescript-codegen` 或使用 `abp generate-proxy -t typescript`。
    - 脚本：`"gen:api": "openapi --input https://localhost:44379/swagger/v1/swagger.json --output src/SmartAbp.Vue/src/core/api --client axios"`。
  - 模块脚手架：
    - 依赖：`npm i -D plop`（或 `hygen`）。
    - 脚本：`"gen:module": "plop --plopfile scripts/plopfile.cjs"`，模板生成 `modules/<name>/...` 的页面/路由/服务/测试骨架。
  - 提交校验：配置 `husky + lint-staged`，在提交前执行 eslint、type-check、单测快照。

8) 测试金字塔与模板
- 做法：
  - 单元：核心 hooks（`usePermission`、`useAuth`）、HTTP 拦截器、路由守卫。
  - 组件：业务组件快照与交互；为脚手架模板提供测试文件。
  - 端到端：关键用户流程（登录→跳转→接口调用→权限控制）。
- 收益：保证基线质量，模板化可自动生成测试。

9) 运行时配置与环境
- 做法：引入 `public/app-config.json` 与 `window.__APP_CONFIG__` 注入（后端在 wwwroot 发布时可覆盖）；`core/config` 统一解析。
- 收益：无需重构即可改 URL/租户/开关；适合多环境多租户部署。

10) 性能工程
- 做法：
  - 按模块 `manualChunks` 分包；`rollup-plugin-visualizer` 进行分析；
  - 路由级懒加载已具备，补充组件级懒加载与 icon 按需；
  - HTTP 缓存策略与 SWR（可选）。

11) 日志与可观测性
- 做法：标准化前端日志格式并可选上报（Sentry/后端日志 API）；为 HTTP、路由、权限提供埋点；
- 收益：问题快速定位；联动后端审计日志。

12) 安全与合规
- 做法：
  - Token 存储策略可选切换（LocalStorage → Cookie + SameSite/HttpOnly，需配合后端）；
  - XSS/CSRF 基线；
  - 统一脱敏与隐私开关。

## 5. 支持“前后端代码自动生成”的具体方案

A. 后端 → 前端 API 客户端（自动）
- 方案一（推荐）：OpenAPI 生成 TS 客户端
  - `npm i -D openapi-typescript-codegen`
  - `npm run gen:api`（见第 7 点脚本），产物输出 `src/core/api`，内置 axios 客户端与类型。
- 方案二（ABP CLI）：`abp generate-proxy -t typescript -u https://localhost:44379 -o src/SmartAbp.Vue/src/core/api`

B. 前端模块脚手架（自动）
- 使用 Plop/Hygen 模板化：一条命令生成 `modules/<feature>` 的页面、服务、store、types、routes、i18n、测试。

C. 权限/菜单 → 路由/菜单（自动）
- 在登录后拉取权限/菜单定义，转换为前端路由树；模板支持“权限编码 → 路由 meta.permission”。

D. 表单/列表（元数据驱动）
- 引入 `FormSchema/TableSchema` 抽象；从 DTO（OpenAPI schema）生成增删改查页面骨架。

## 6. 迁移路径（建议 3 周）

- 第 1 周：搭建 `core/*` 基础设施（http/auth/config/i18n/router/ui），接入 OpenAPI 客户端；删除 Mock store；统一拦截器与多租户头。
- 第 2 周：按 FSD 重构 `system、projects、logs` 三个模块；接入权限动态路由与菜单；集成 i18n。
- 第 3 周：脚手架与自动生成（Plop + OpenAPI）；补充测试、lint-staged、打包分析与性能优化策略。

## 7. 风险与兼容

- 统一 HTTP/认证后，历史调用需根据新封装调整；
- 动态路由引入需审视现有静态路由 meta 依赖；
- 大量 CSS 需经由设计系统适配层统一变量名，避免破坏性覆盖；
- 分阶段灰度迁移，保留兼容层直到业务验证通过。

---

如需，我可以在 `src/SmartAbp.Vue/src/core` 建好骨架与示例模块，并加上 `gen:api / gen:module` 脚本，帮助快速落地上述方案。
