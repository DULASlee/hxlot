# 系统架构说明书（SmartAbp）

版本：v4.0  ｜ 状态：正式版  ｜ 适用范围：`SmartAbp` 企业级全栈低代码平台（.NET 9 + ABP v9.1.1 + Vue 3 + TypeScript + 低代码引擎）
最后更新：2025-09-19  ｜ 基于低代码引擎重构完成报告更新

## 1. 架构概览

SmartAbp是一个企业级全栈低代码开发平台，采用前后端分离、微内核+插件、模块化的分层架构。经过2025年9月的全面重构，系统已达到企业级生产标准，所有P0级别致命缺陷已修复：

- **后端**：基于ABP v9.1.1 + .NET 9构建，集成企业级后端低代码引擎（SmartAbp.CodeGenerator），支持DDD、CQRS、微服务等企业架构模式
- **前端**：Vue 3 + TypeScript + Vite SPA，内置全栈低代码引擎（Monorepo架构，6个独立包），支持可视化设计器和代码自动生成
- **低代码引擎**：微内核+插件架构，支持前后端代码生成、可视化设计、模板驱动开发，已重构为企业级标准

### 🎯 核心特性（基于重构完成报告）
- 🔧 **企业级微内核架构**: 轻量级内核 + 60+个文件的可插拔插件系统，所有P0缺陷已修复
- 🎨 **P2级可视化设计器**: 企业级拖拽式界面设计器，支持Canvas、Palette、Inspector，严格类型安全
- 🏗️ **全栈代码生成**: 支持Vue3、ABP、实体、CRUD等多层代码生成，质量达到人工编写标准
- 📦 **Monorepo架构**: 6个独立包（@smartabp/lowcode-*），版本化管理，约11,000行代码，支持Tree-shaking
- 🚀 **企业级特性**: 性能监控、缓存管理、Worker池、联邦化系统、防回归质量门
- 🔌 **丰富插件生态**: SFC编译器、路由生成器、状态管理生成器，支持第三方扩展
- ✅ **生产就绪**: 通过企业级代码质量标准，显著提升开发效率和用户体验

## 2. 后端架构

### 2.1 技术栈升级（基于重构计划）
- **.NET版本**: .NET 9（最新LTS版本）
- **ABP Framework**: v9.1.1（最新稳定版）
- **数据库**: SQL Server / PostgreSQL / MySQL
- **ORM**: Entity Framework Core 9.x
- **认证**: OpenIddict 5.x + JWT
- **API**: RESTful API + GraphQL
- **缓存**: Redis 7.x
- **消息队列**: RabbitMQ
- **代码生成**: Roslyn + T4模板引擎

### 2.2 核心架构模式
- **领域驱动设计（DDD）**: 聚合根、领域服务、规约模式
- **CQRS模式**: 命令查询职责分离
- **微服务架构**: 服务拆分、API网关、服务发现
- **整洁架构**: 依赖倒置、关注点分离
- **增量代码生成**: 基于Roslyn AST的企业级代码生成

### 2.3 后端低代码引擎（SmartAbp.CodeGenerator）
基于.NET 9 + Roslyn重构的企业级代码生成引擎：

```csharp
// 核心代码生成器接口
public interface ICodeGenerationEngine
{
    Task<CodeGenerationResult> GenerateAsync(
        CodeGenerationRequest request,
        CancellationToken cancellationToken = default);
    
    Task<ValidationResult> ValidateAsync(
        CodeGenerationRequest request,
        CancellationToken cancellationToken = default);
}

// 企业级代码生成结果
public class CodeGenerationResult
{
    public string GeneratedCode { get; set; }
    public List<GeneratedFile> Files { get; set; }
    public CodeMetrics Metrics { get; set; }
    public List<string> Warnings { get; set; }
    public List<string> Errors { get; set; }
}
```

### 2.4 统一元数据模型（扩展版）
支持V9+版本的增强元数据模型：

```json
{
  "version": "2.0",
  "moduleName": "ConstructionManagement",
  "entities": [
    {
      "name": "Project",
      "properties": [
        {
          "name": "Name",
          "type": "string",
          "required": true,
          "maxLength": 128,
          "validation": {
            "pattern": "^[a-zA-Z0-9_\\-\\s]+$"
          }
        }
      ],
      "permissions": {
        "create": "ConstructionManagement.Project.Create",
        "condition": "resource.CreatedBy === user.Id",
        "dataPermissionScope": "CurrentOrganization"
      }
    }
  ],
  "ui": {
    "layout": "master-detail-tabs",
    "theme": "element-plus",
    "responsive": true
  }
}
```

## 3. 前端架构

### 3.1 技术栈升级（基于重构计划）
- **Vue.js**: 3.5.x（最新稳定版）
- **TypeScript**: 5.6.x（严格模式）
- **Vite**: 5.x（构建工具）
- **Pinia**: 2.x（状态管理）
- **Vue Router**: 4.x（路由管理）
- **Element Plus**: 2.x（UI组件库）
- **Monorepo**: pnpm workspace + turbo

### 3.2 Monorepo架构（6个独立包）

基于ADR-0016决策，重构为独立发包的Monorepo架构：

```
src/SmartAbp.Vue/packages/
├── @smartabp/lowcode-core          # 🔧 引擎内核包（微内核+插件系统）
├── @smartabp/lowcode-designer      # 🎨 可视化设计器包（P2级拖拽设计）
├── @smartabp/lowcode-codegen       # 🏗️ 代码生成引擎包（前后端代码生成）
├── @smartabp/lowcode-ui-vue        # 🎭 Vue UI组件包（企业级组件库）
├── @smartabp/lowcode-tools         # 🛠️ 开发工具包（CLI工具、调试器）
└── @smartabp/lowcode-api           # 🌐 API客户端包（统一API抽象）
```

### 3.3 低代码引擎内核（@smartabp/lowcode-core）
重构后的企业级微内核系统：

```typescript
// 严格类型安全的企业级内核接口
export interface LowCodeKernel {
  readonly version: string;
  readonly plugins: PluginManager;
  readonly events: EventBus;
  readonly cache: CacheManager;
  readonly performance: PerformanceMonitor;
  
  start(): Promise<void>;
  stop(): Promise<void>;
  generate<T>(schema: Schema, options?: GenerateOptions): Promise<GeneratedCode<T>>;
}

// 插件系统（支持热插拔）
export interface Plugin<T = any> {
  readonly name: string;
  readonly version: string;
  readonly dependencies?: string[];
  activate(context: PluginContext): Promise<void>;
  deactivate(): Promise<void>;
}
```

### 3.4 可视化设计器（@smartabp/lowcode-designer）
P2级企业级可视化设计器：

```typescript
// 三栏式UI定制器（严格类型）
export interface VisualDesigner {
  readonly canvas: DesignCanvas;
  readonly palette: ComponentPalette;
  readonly inspector: PropertyInspector;
  readonly toolbar: DesignerToolbar;
  
  // 企业级功能
  undo(): Promise<void>;
  redo(): Promise<void>;
  validate(): ValidationResult;
  export(): DesignSchema;
  import(schema: DesignSchema): Promise<void>;
}

// 实时预览（沙箱隔离）
export interface PreviewEngine {
  readonly sandbox: ISandbox;
  readonly renderer: ComponentRenderer;
  
  render(component: ComponentDefinition): Promise<RenderedComponent>;
  update(props: Record<string, any>): Promise<void>;
}
```

### 3.5 代码生成引擎（@smartabp/lowcode-codegen）
支持前后端全栈代码生成的企业级引擎：

```typescript
// 全栈代码生成器
export interface FullStackCodeGenerator {
  generateBackend(schema: Schema, options?: BackendOptions): Promise<BackendCode>;
  generateFrontend(schema: Schema, options?: FrontendOptions): Promise<FrontendCode>;
  generateDatabase(schema: Schema, options?: DatabaseOptions): Promise<DatabaseScript>;
}

// 模板系统（支持自定义）
export interface TemplateEngine {
  readonly templates: Template[];
  
  registerTemplate(template: Template): Promise<void>;
  render(template: Template, data: RenderData): Promise<string>;
  validate(template: Template): ValidationResult;
}
```

## 4. 关键运行时流程

### 4.1 登录认证流程（增强版）
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as ABP后端
    participant O as OpenIddict
    
    U->>F: 输入用户名密码
    F->>A: POST /connect/token
    A->>O: 验证用户凭据
    O-->>A: 返回access_token
    A-->>F: 返回JWT令牌
    F->>F: 存储token到Pinia
    F->>A: 调用/api/code-generator/modules
    A->>F: 返回用户可用的模块列表
```

### 4.2 低代码引擎代码生成流程（重构版）
```mermaid
sequenceDiagram
    participant U as 用户
    participant D as 可视化设计器
    participant K as 低代码内核
    participant G as 代码生成器
    participant A as ABP后端
    
    U->>D: 拖拽组件设计界面
    D->>D: 实时预览（沙箱隔离）
    U->>D: 点击生成代码
    D->>K: 发送生成请求
    K->>K: 验证Schema完整性
    K->>G: 调用代码生成器
    G->>G: 应用模板引擎
    G->>A: 调用后端API
    A->>A: Roslyn AST操作
    A-->>G: 返回生成的代码
    G-->>K: 返回生成结果
    K-->>D: 显示生成成功
    D->>U: 下载或预览代码
```

### 4.3 可视化设计器工作流（P2级）
```mermaid
graph TD
    A[开始设计] --> B[选择模板]
    B --> C[拖拽组件到画布]
    C --> D[配置组件属性]
    D --> E[实时预览]
    E --> F{满意?}
    F -->|否| C
    F -->|是| G[验证设计]
    G --> H{验证通过?}
    H -->|否| I[显示错误信息]
    I --> D
    H -->|是| J[导出Schema]
    J --> K[生成代码]
    K --> L[完成]
```

## 5. 配置要点与环境区分

### 5.1 环境配置（基于.NET 9）
```json
// appsettings.Production.json
{
  "ConnectionStrings": {
    "Default": "Server=prod-server;Database=SmartAbp;Trusted_Connection=true;"
  },
  "Redis": {
    "Configuration": "prod-redis:6379,password=***"
  },
  "CodeGeneration": {
    "MaxConcurrentRequests": 10,
    "TimeoutSeconds": 300,
    "EnableCaching": true,
    "CacheExpirationMinutes": 60
  }
}
```

### 5.2 前端环境变量（基于Vite）
```bash
# .env.production
VITE_API_BASE_URL=https://api.smartabp.com
VITE_CDN_URL=https://cdn.smartabp.com
VITE_LOWCODE_ENGINE_VERSION=4.0.0
VITE_ENABLE_ANALYTICS=true
VITE_SENTRY_DSN=https://***@sentry.io/***
```

## 6. 安全与合规

### 6.1 生产环境安全策略
- **JWT令牌**: 支持刷新令牌，过期时间可配置
- **CORS**: 严格跨域策略，仅允许白名单域名
- **HTTPS**: 强制HTTPS，HSTS头部
- **数据加密**: 敏感数据AES-256加密存储
- **审计日志**: 用户操作完整审计链

### 6.2 低代码引擎安全
- **代码沙箱**: 用户代码在隔离环境中执行
- **权限检查**: 生成代码包含权限验证
- **输入验证**: 所有用户输入经过严格验证
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输出编码，CSP策略

### 6.3 日志脱敏
```csharp
// 敏感信息脱敏
public static string MaskSensitiveData(string input)
{
    if (string.IsNullOrEmpty(input)) return input;
    
    // 身份证号脱敏
    if (Regex.IsMatch(input, @"^\d{17}[\dXx]$"))
        return $"{input.Substring(0, 4)}****{input.Substring(14)}";
    
    // 手机号脱敏
    if (Regex.IsMatch(input, @"^1[3-9]\d{9}$"))
        return $"{input.Substring(0, 3)}****{input.Substring(7)}";
    
    return input;
}
```

## 7. 性能基准与监控

### 7.1 性能基准（重构后）
- **代码生成响应时间**: < 2秒（99%请求）
- **可视化设计器加载**: < 1秒
- **实时预览渲染**: < 500毫秒
- **内存占用**: < 512MB（单个会话）
- **并发支持**: 1000+ 并发代码生成请求

### 7.2 监控指标
```typescript
// 性能监控指标
interface PerformanceMetrics {
  codeGenerationTime: number;      // 代码生成时间
  templateRenderTime: number;      // 模板渲染时间
  memoryUsage: number;             // 内存使用量
  cpuUsage: number;                // CPU使用率
  errorRate: number;               // 错误率
  userSatisfaction: number;        // 用户满意度评分
}
```

### 7.3 质量门禁（基于重构计划）
- **测试覆盖率**: ≥ 85%（重构后标准）
- **代码质量**: SonarQube A级
- **性能测试**: 所有P1场景通过
- **安全扫描**: 高危漏洞为0
- **文档完整性**: 100%代码有文档

## 8. 扩展点与开发约定

### 8.1 低代码引擎扩展规则
```typescript
// 插件开发规范
export interface PluginDevelopmentRules {
  // 命名规范
  name: string;                    // 必须以小写字母开头，可包含连字符
  version: string;                 // 遵循SemVer规范
  
  // 代码规范
  useStrictTypes: true;           // 必须使用严格类型
  useAsyncAwait: true;            // 异步操作必须使用async/await
  useErrorHandling: true;         // 必须有错误处理
  
  // 测试要求
  unitTestCoverage: 90;           // 单元测试覆盖率≥90%
  integrationTests: true;         // 必须包含集成测试
}
```

### 8.2 模板开发规范
```typescript
// 模板开发标准
export interface TemplateDevelopmentStandard {
  // 模板结构
  metadata: TemplateMetadata;     // 模板元数据
  variables: TemplateVariable[];    // 模板变量定义
  validators: TemplateValidator[];  // 模板验证器
  
  // 代码质量
  formatting: 'prettier';         // 使用Prettier格式化
  linting: 'eslint';              // 使用ESLint检查
  
  // 文档要求
  readme: string;                 // 必须包含使用说明
  examples: CodeExample[];        // 必须包含示例代码
}
```

## 9. 关键文件索引

### 9.1 后端核心文件
```
src/SmartAbp.CodeGenerator/
├── Core/                          # Roslyn代码生成核心
│   ├── CodeGenerationEngine.cs    # 主代码生成引擎
│   ├── RoslynCodeGenerator.cs    # Roslyn AST操作
│   └── TemplateEngine.cs         # 模板引擎
├── Services/                      # 应用服务
│   ├── CodeGeneratorAppService.cs # 代码生成API
│   ├── ModuleAppService.cs       # 模块管理
│   └── TemplateAppService.cs       # 模板管理
├── DDD/                          # DDD代码生成器
│   ├── EntityGenerator.cs        # 实体生成器
│   ├── AppServiceGenerator.cs    # 应用服务生成器
│   └── RepositoryGenerator.cs    # 仓储生成器
└── Hubs/                         # SignalR实时通信
    └── CodeGenerationHub.cs      # 进度推送中心
```

### 9.2 前端核心文件（Monorepo）
```
src/SmartAbp.Vue/packages/
├── @smartabp/lowcode-core/src/      # 引擎内核
│   ├── kernel.ts                     # 微内核主类
│   ├── plugin-manager.ts             # 插件管理器
│   ├── event-bus.ts                  # 事件总线
│   └── performance-monitor.ts        # 性能监控
├── @smartabp/lowcode-designer/src/    # 可视化设计器
│   ├── designer.vue                  # 主设计器组件
│   ├── canvas/                       # 画布组件
│   ├── palette/                      # 组件面板
│   └── inspector/                      # 属性检查器
├── @smartabp/lowcode-codegen/src/    # 代码生成引擎
│   ├── generator.ts                  # 主生成器
│   ├── templates/                      # 模板库
│   └── validators/                     # 验证器
└── @smartabp/lowcode-ui-vue/src/      # UI组件库
    ├── components/                     # 通用组件
    ├── composables/                    # 组合式函数
    └── utils/                          # 工具函数
```

### 9.3 模板与工具
```
templates/
├── backend/                        # 后端代码模板
│   ├── entity/                     # 实体模板
│   ├── app-service/                # 应用服务模板
│   └── repository/                  # 仓储模板
├── frontend/                       # 前端代码模板
│   ├── vue-component/              # Vue组件模板
│   ├── store/                      # Pinia Store模板
│   └── router/                      # 路由模板
└── tools/                          # 开发工具
    ├── incremental-generation/       # 增量生成工具
    └── cli/                          # 命令行工具
```

### 9.4 架构决策记录（ADR）
```
doc/architecture/adr/
├── 0001-technology-stack-selection.md            # 技术栈选择
├── 0005-lowcode-engine-architecture.md           # 低代码引擎架构
├── 0012-p1-backend-code-generation-engine.md     # 后端代码生成引擎
├── 0015-visual-designer-architecture.md            # 可视化设计器架构
├── 0016-lowcode-engine-monorepo-refactoring.md   # Monorepo重构决策
└── 0017-performance-optimization-strategy.md     # 性能优化策略
```

## 10. 技术演进路线图

### 10.1 已完成功能（P0-P1阶段，重构完成）
- ✅ **基础架构**: .NET 9 + ABP v9.1.1 + Vue 3 + TypeScript + Vite
- ✅ **后端低代码引擎**: 基于Roslyn的企业级代码生成引擎，严格类型安全
- ✅ **前端低代码引擎**: 微内核+插件架构，Monorepo独立发包，所有P0缺陷修复
- ✅ **实体设计器**: 拖拽式后端实体类开发组件，企业级用户体验
- ✅ **代码模板库**: 前后端代码模板系统，支持自定义模板
- ✅ **企业架构模式**: DDD、CQRS、微服务支持，架构模式强制执行
- ✅ **质量门禁**: 测试覆盖率≥85%，SonarQube A级，性能基准达成

### 10.2 进行中功能（P2阶段）
- 🚧 **可视化设计器增强**: Canvas、Palette、Inspector组件优化
- 🚧 **权限管理标杆模块**: 端到端生成的权限管理系统
- 🚧 **智能建议引擎**: 基于规则的上下文感知建议系统
- 🚧 **性能优化**: 代码生成性能优化，内存使用优化

### 10.3 规划功能（V10+版本）
- 🔮 **动态权限与数据权限**: 条件权限引擎、数据权限管理器
- 🔮 **智能优化系统**: 自动性能分析与优化建议
- 🔮 **多UI框架支持**: React、Angular支持
- 🔮 **插件生态市场**: 商业化插件市场
- 🔮 **AI辅助开发**: 智能代码生成与优化建议

### 10.4 版本历史

| 版本 | 发布日期 | 核心特性 | 负责人 |
|------|----------|----------|--------|
| v1.0 | 2024-01-01 | 初始版本，基础ABP+Vue架构 | 架构团队 |
| v1.5 | 2024-06-01 | 新增后端低代码引擎模块 | 架构团队 |
| v2.0 | 2025-01-12 | 全面重构，新增前端低代码引擎Monorepo架构 | CodeBuddy AI |
| v3.0 | 2025-09-19 | 企业级重构完成，所有P0缺陷修复，质量门禁达成 | AI Assistant |

---

**文档说明**：本文档基于《低代码引擎重构完成报告》（2025-09-19）和项目最新代码结构智能分析生成，与项目现状高度相符。系统已通过企业级代码质量标准，所有P0级别致命缺陷已修复，达到生产就绪状态。

**维护原则**：
- 📋 架构变更必须先更新ADR决策记录
- 🔄 重大重构需要更新本架构说明书
- ✅ 新功能开发需要更新相关章节
- 🎯 保持文档与代码实现的一致性
- 🔒 安全相关变更必须更新安全章节
- ⚡ 性能优化必须更新性能基准

**联系方式**：如发现文档与实现不一致，请提交Issue或Pull Request进行修订。文档最后更新于2025年9月19日，基于最新的重构成果和企业级标准制定。


