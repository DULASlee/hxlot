# 智慧工地项目管理模块测试输入物料和操作说明

> 目的：用于在多步骤模块向导（/CodeGen/wizard）中，端到端验证全栈低代码引擎是否能正确生成后端（ABP）与前端（Vue3/TS）代码，并产出企业级默认 UI。
>
> 使用范围：本说明覆盖向导的 5 个步骤，提供每一步所需输入、可选项、示例 SQL、权限与 UI 配置、以及操作顺序与校验要点。

---

## 步骤 0 · 前置准备
- 后端已编译通过（net9.0 + ABP v9.1.1），并运行在本地（或你常用环境）。
- 前端 dev 服务器运行在 `http://localhost:11369`。
- 向导入口：菜单 → 代码生成 → 向导，或直接访问 `http://localhost:11369/CodeGen/wizard`。
- 数据库：建议使用 SqlServer；连接字符串名为 `Default`；Schema `dbo`。

> 若你计划用“数据库导入”快速建模，可先准备好本文档末尾的 SQL（附录 A）。

---

## 步骤 1 · 系统与模块定义（System & Module）
请在向导第 1 步填入：
- 系统名称（SystemName）: `SmartConstruction`
- 模块名称（ModuleName）: `ProjectManagement`
- 模块显示名称: `项目管理`
- 版本（SemVer）: `1.0.0`
- 路由前缀（RoutePrefix）: `/construction/project`
- 父菜单（ParentId）: 可留空（顶级）；或选择“系统/智慧工地”下的合适节点（若已存在）。

校验要点：
- SystemName / ModuleName 必须首字母大写的驼峰式命名（如 `SmartConstruction`、`ProjectManagement`）。
- 版本需满足 `x.y.z` 格式；填写后如格式不正确，向导会给出预检提示。

---

## 步骤 2 · 实体与关系建模（Entities & Relationships）
本模块建议实体集合（可先建 3~4 个核心实体完成验证，后续可逐步补齐）：

### 2.1 Project（项目）
- 表名建议：`AppProjects`
- 关键属性：
  - `Id: guid (PK)`
  - `Code: string(32) required unique` 项目编号
  - `Name: string(128) required` 项目名称
  - `Status: enum [Planned, InProgress, OnHold, Completed, Closed] required`
  - `StartDate: date required`
  - `EndDate: date`
  - `ManagerUserId: guid` 项目经理用户 Id
  - `Budget: decimal(18,2)` 预算
  - `Description: text`
  - `CreatedAt: datetime`（自动审计）
  - `UpdatedAt: datetime`（自动审计）

### 2.2 ProjectPhase（项目阶段）
- 表名建议：`AppProjectPhases`
- 关键属性：
  - `Id: guid (PK)`
  - `ProjectId: guid (FK→AppProjects.Id) required`
  - `Name: string(64) required`
  - `OrderNo: int required`
  - `StartDate: date`
  - `EndDate: date`
  - `Status: enum [NotStarted, Ongoing, Done] required`

### 2.3 ProjectTask（任务）
- 表名建议：`AppProjectTasks`
- 关键属性：
  - `Id: guid (PK)`
  - `ProjectId: guid (FK→AppProjects.Id) required`
  - `PhaseId: guid (FK→AppProjectPhases.Id)`
  - `Name: string(128) required`
  - `AssignedToUserId: guid`
  - `Priority: enum [Low, Medium, High, Critical]`
  - `Status: enum [Todo, Doing, Blocked, Done] required`
  - `StartDate: date`
  - `DueDate: date`
  - `PercentComplete: int (0~100)`

### 2.4 ProjectMember（项目成员/参与者，建议作为连接表）
- 表名建议：`AppProjectMembers`
- 关键属性：
  - `Id: guid (PK)`（或联合键 `ProjectId+UserId`）
  - `ProjectId: guid (FK→AppProjects.Id) required`
  - `UserId: guid required`
  - `Role: enum [Manager, Supervisor, Engineer, Safety, QA, Other] required`
  - `JoinedAt: datetime`

### 2.5 可选扩展实体（按需添加）
- `ProjectIssue`（问题）：严重度/状态/责任人/所属任务
- `ProjectRisk`（风险）：等级/概率/影响/缓解计划/责任人
- `ProjectAttachment`（附件）：文件名/URL/MIME/大小/上传人/所属任务

### 2.6 关系建议
- `Project` 1—N `ProjectPhase`
- `Project` 1—N `ProjectTask`
- `Project` 1—N `ProjectMember`
- `ProjectPhase` 1—N `ProjectTask`
- `ProjectTask` 可与 `ProjectAttachment`、`ProjectIssue`（如有）形成 1—N

> 操作提示：
> - 你可以手动逐一添加实体及属性；或使用“数据库导入”功能从 SQL 建表语句快速生成基础模型（见附录 A）。
> - 重复实体或相同名称（大小写不同）会在设计器中被自动合并与规范化（PascalCase）。

---

## 步骤 3 · 服务与权限（Services & Permissions）
权限组与权限点建议如下（示例）：

- 权限组：`SmartAbp.SmartConstruction`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Create`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Read`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Update`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Delete`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Export`
  - `SmartAbp.SmartConstruction.ProjectManagement.Project.Approve`
  - `SmartAbp.SmartConstruction.ProjectManagement.Task.Create`
  - `SmartAbp.SmartConstruction.ProjectManagement.Task.Read`
  - `SmartAbp.SmartConstruction.ProjectManagement.Task.Update`
  - `SmartAbp.SmartConstruction.ProjectManagement.Task.Delete`

> 操作提示：
> - 在向导“权限组/权限点”编辑面板中新增权限组与权限点；
> - 标准 CRUD 权限将被后端生成器自动识别，不必重复作为“自定义权限”提交；
> - 自定义权限（如 Export/Approve）可在此维护。

---

## 步骤 4 · UI 与菜单（UI & Menu）
- 路由前缀：`/construction/project`
- 父菜单：可留空为顶级，或选择“智慧工地”上层节点

### 4.1 默认列表页（Project）
- 列：`code, name, status, startDate, endDate, managerUserId, budget, createdAt`
- 搜索：`code, name`
- 筛选：`status, startDate/endDate（范围）`
- 排序：`startDate desc, createdAt desc`
- 每页条数：`20`
- 常用动作：`Create, Edit, Delete, Export`

### 4.2 表单配置（Project）
- 布局：`vertical`，列数：`2`
- 分组：
  - 基本信息：`code, name, status`
  - 时间与责任：`startDate, endDate, managerUserId`
  - 财务与备注：`budget, description`

### 4.3 其他页面建议
- 任务列表（Task）与阶段（Phase）页采用相同规范（列表列 + 表单布局），任务页额外增加 `priority, percentComplete, dueDate` 等字段展示/编辑。

> 操作提示：
> - 可在向导“UI 默认配置”区域，一键将列表显示列与表单列数应用到所有实体；
> - 生成后你可以在手工扩展文件（*.vue 与 *.generated.vue 并行）进一步微调，不会被覆盖。

---

## 步骤 5 · 预检、Dry-Run 与生成（Validate, Dry-Run & Generate）
操作顺序：
1) 点击“执行预检（Validate）”：应返回 `isValid=true` 或列出需修正的问题清单。
2) 点击“Dry-Run”：应展示待写入文件列表与统计信息（文件数/行数）。
3) 点击“生成全栈代码”：向导会先保存元数据，再触发后端生成。完成后提示“生成成功 + 文件总数”。

生成后建议本地 QA：
- 后端：`dotnet build -c Release`；
- 前端：`npm run type-check && npm run build`；
- 运行前端，访问 `/construction/project` 路由检查：列表页、表单、筛选、操作按钮与权限控制是否按预期。

---

## 附录 A · SQL 建表语句（可选，用于“数据库导入”快速建模）
> 供“步骤 2 / 数据库导入”使用；如需精简可仅保留 AppProjects / AppProjectPhases / AppProjectTasks。

```sql
-- AppProjects
create table [dbo].[AppProjects](
  [Id] uniqueidentifier not null,
  [Code] nvarchar(32) not null,
  [Name] nvarchar(128) not null,
  [Status] nvarchar(32) not null,
  [StartDate] date not null,
  [EndDate] date null,
  [ManagerUserId] uniqueidentifier null,
  [Budget] decimal(18,2) null,
  [Description] nvarchar(max) null,
  [CreatedAt] datetime2 null,
  [UpdatedAt] datetime2 null,
  constraint [PK_AppProjects] primary key ([Id])
);
create unique index IX_AppProjects_Code on [dbo].[AppProjects]([Code]);

-- AppProjectPhases
create table [dbo].[AppProjectPhases](
  [Id] uniqueidentifier not null,
  [ProjectId] uniqueidentifier not null,
  [Name] nvarchar(64) not null,
  [OrderNo] int not null,
  [StartDate] date null,
  [EndDate] date null,
  [Status] nvarchar(32) not null,
  constraint [PK_AppProjectPhases] primary key ([Id]),
  constraint [FK_AppProjectPhases_Projects] foreign key ([ProjectId]) references [dbo].[AppProjects]([Id])
);
create index IX_AppProjectPhases_ProjectId on [dbo].[AppProjectPhases]([ProjectId]);

-- AppProjectTasks
create table [dbo].[AppProjectTasks](
  [Id] uniqueidentifier not null,
  [ProjectId] uniqueidentifier not null,
  [PhaseId] uniqueidentifier null,
  [Name] nvarchar(128) not null,
  [AssignedToUserId] uniqueidentifier null,
  [Priority] nvarchar(32) null,
  [Status] nvarchar(32) not null,
  [StartDate] date null,
  [DueDate] date null,
  [PercentComplete] int null,
  constraint [PK_AppProjectTasks] primary key ([Id]),
  constraint [FK_AppProjectTasks_Projects] foreign key ([ProjectId]) references [dbo].[AppProjects]([Id]),
  constraint [FK_AppProjectTasks_Phases] foreign key ([PhaseId]) references [dbo].[AppProjectPhases]([Id])
);
create index IX_AppProjectTasks_ProjectId on [dbo].[AppProjectTasks]([ProjectId]);
create index IX_AppProjectTasks_PhaseId on [dbo].[AppProjectTasks]([PhaseId]);

-- AppProjectMembers
create table [dbo].[AppProjectMembers](
  [Id] uniqueidentifier not null,
  [ProjectId] uniqueidentifier not null,
  [UserId] uniqueidentifier not null,
  [Role] nvarchar(32) not null,
  [JoinedAt] datetime2 null,
  constraint [PK_AppProjectMembers] primary key ([Id]),
  constraint [FK_AppProjectMembers_Projects] foreign key ([ProjectId]) references [dbo].[AppProjects]([Id])
);
create index IX_AppProjectMembers_ProjectId on [dbo].[AppProjectMembers]([ProjectId]);
```

---

## 附录 B · 建议权限清单（可直接粘贴到“权限点”面板逐条录入）
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Create`
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Read`
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Update`
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Delete`
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Export`
- `SmartAbp.SmartConstruction.ProjectManagement.Project.Approve`
- `SmartAbp.SmartConstruction.ProjectManagement.Task.Create`
- `SmartAbp.SmartConstruction.ProjectManagement.Task.Read`
- `SmartAbp.SmartConstruction.ProjectManagement.Task.Update`
- `SmartAbp.SmartConstruction.ProjectManagement.Task.Delete`

---

## 操作清单（最短路径）
1) 第 1 步：填写系统/模块/版本/路由前缀，保存草稿。
2) 第 2 步：优先“数据库导入”三张表（项目/阶段/任务），或手工建模并补齐关系。
3) 第 3 步：录入权限组与必要的自定义权限（如 Export/Approve）。
4) 第 4 步：一键应用默认 UI 列与表单列数，选择父菜单（可选）。
5) 第 5 步：先“预检”，再“Dry-Run”，最后“生成全栈代码”。
6) 生成后：后端 build、前端 type-check/build，访问 `/construction/project` 验证企业级默认 UI。
