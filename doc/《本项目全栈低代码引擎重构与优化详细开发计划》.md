# 本项目全栈低代码引擎重构与优化详细开发计划

## 目标与范围
- **总体目标**: 以 net9.0 + ABP v9.1.1 + Vue3/TS 为基线，重构并完善全栈低代码引擎，实现企业级可用与业内领先用户体验。
- **范围**: 向导（Wizard）、Schema 与版本管理、模板系统、代码生成（前后端）、混合架构、防回归质量门、日志与可观测、性能优化、权限管理标杆模块。

## 里程碑
- M1 向导可用性与规范落地（T+3d）
- M2 统一Schema/版本治理与模板映射（T+6d）
- M3 权限管理标杆模块端到端生成（T+10d）
- M4 质量门与可观测全面达标（T+12d）

## 架构基线与约束
- 后端：ABP 分层；生成器通过 `SmartAbp.CodeGenerator` 暴露；OpenIddict/Identity 与权限策略一致。
- 前端：低代码引擎包化 `@smartabp/lowcode-*`；appshell 聚合；Hybrid 生成 `*.generated.*` + 手工扩展。
- 模板优先：所有 CRUD/服务/DTO/组件均使用 `templates/*`；禁止硬编码绕过模板。

## 核心工作包（WBS）
1) 向导（/CodeGen/wizard）提升
- 分步校验（表单规则+异步后端校验）与禁用下一步
- 自动保存：`useDebounceFn + requestIdleCallback`，失败回退与提示
- 性能：虚拟化长列表、按需加载元数据、实时预览隔离沙箱
- 可用性：操作反馈、进度条、错误 ProblemDetails 解析

2) Schema 与版本治理
- 统一 `UnifiedModuleSchemaDto`，前端强类型 Discriminated Union
- `SchemaVersioningService`：manifest、兼容矩阵、迁移规则、预检
- 前后端 preflight 校验：不兼容中止并给出迁移建议

3) 模板与生成
- 后端：`CrudAppService`、Contracts DTO、PermissionDefinitionProvider、EF Core 配置
- 前端：`CrudManagement.vue`、`EntityStore.ts`、`ModuleRoutes.ts`
- 质量钩子：Roslyn 诊断、JS 安全检查、生成后编译/类型检查预验证

4) 混合架构
- 后端 `*.generated.cs` + `partial class` 手工扩展；前端 `*.generated.vue/ts` + 邻近手写文件
- 写入器避免覆盖手写文件；提供 `--force` 与差异报告

5) 权限管理标杆模块
- 实体：`Permission`, `Role`, `UserRole`, `RolePermission`（或复用 ABP Identity + 权限扩展）
- 业务：角色-权限矩阵、批量授权、差异对比、一键回滚、审计日志
- 界面：角色列表/编辑、权限树/矩阵、用户分配、变更审计

6) 可观测与质量门
- 前端结构化日志（开发控制台 + 可选上报）；后端 Serilog 多文件分桶（app/warn/error/requests）
- 质量四连：type/lint/tests/build；覆盖率 ≥ 80%
- 性能基线：交互 ≤ 100ms；生成 ≤ 3s；预览 60fps

## 风险与对策
- 模板遗漏 → 模板索引 `templates/index.json` 强校验
- 版本不兼容 → 版本矩阵 + 迁移脚本
- 性能退化 → 性能埋点 + 阈值告警

## 验收标准
- 向导每步操作闭环（校验/保存/回退/提示）
- 代码生成端到端可编译、可运行、带权限校验与审计
- 标杆模块按设计交付并通过质量门
