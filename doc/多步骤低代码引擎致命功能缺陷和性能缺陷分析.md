# 多步骤低代码引擎致命功能缺陷和性能缺陷分析

> 目标：面向“多步骤模块向导”低代码链路，基于实际代码实现，识别阻断级缺陷与关键性能/体验问题，并给出企业级可落地的修复方案与优先级。

## 范围与基准

- 分析对象：
  - 前端模块向导与生成链
    - `packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue`
    - `packages/lowcode-designer/src/components/ModuleWizard.vue`
    - `packages/lowcode-designer/src/core/wizard-state-machine.ts`
    - `packages/lowcode-designer/src/types/strict-types.ts`
    - `packages/lowcode-designer/src/api/code-generator.ts`
    - `packages/lowcode-tools/src/dev/moduleWizardDev.ts`
  - 后端代码生成器
    - `src/SmartAbp.CodeGenerator/Services/CodeGenerationAppService.cs`
    - `src/SmartAbp.CodeGenerator/Core/Generation/Crud/*.cs`
    - `src/SmartAbp.CodeGenerator/Services/Dtos.cs`

- 相关 ADR：
  - ADR-0005 低代码引擎架构（微内核+插件，模板驱动，安全/性能基线）
  - ADR-0015 可视化设计器（Schema 唯一来源、回执、沙箱）
  - ADR-0016 Monorepo 决策修订（现阶段源码直集成）

---

## 一、致命功能缺陷（阻断“自动生成企业级可用代码”）

1) 向后端 DTO 的序列化转换严重缺失（类型与字段不匹配）

```228:302:src/SmartAbp.Vue/packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue
// 调用后端生成接口的入口
const result = await codeGeneratorApi.generateModule(currentState as any)
```

```41:94:src/SmartAbp.Vue/packages/lowcode-designer/src/api/code-generator.ts
// 仅做浅拷贝透传，未将 Strict types → 后端 EnhancedEntityModelDto 正确映射
entities: metadata.entities.map(entity => ({
  ...entity,
  properties: entity.properties.map(prop => ({
    ...prop,
    // TODO: 缺少 type 映射、命名、主键/索引/验证等结构化转换
  }))
})),
```

- 影响：后端期望 `EnhancedEntityModelDto`（见 `Dtos.cs`）包含大量强约束字段（如 `IsKey/ColumnName/Relationships/Constraints/UiConfig/...`），当前前端仅透传 `StrictEntityModel`/`StrictPropertyModel`，且 `type` 为前端枚举值，未转换为 C#/EF 期望的类型字串，极易导致生成代码不完整、迁移/编译失败或语义错误。

- 结论：这是“无法稳定生成可编译、可运行企业级代码”的首要阻断点（致命）。

2) 权限策略注入路径错误，极易生成不可编译代码

```42:91:src/SmartAbp.CodeGenerator/Core/Generation/Crud/ApplicationGenerator.cs
// 读取 FeatureManagement.DefaultPolicy 作为 Authorize 的参数表达式
appServiceClass = appServiceClass
  .AddAttributeLists(CreateAttribute("Authorize", readPolicy));
```

```110:160:src/SmartAbp.Vue/packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue
// 向导允许用户自由填写 DefaultPolicy（如 "SmartConstruction.ProjectManagement" 字符串）
// 该值被当成 C# 表达式而非字符串字面量注入，导致编译期名称解析失败
```

- 影响：若用户填入普通策略名字符串，生成的 `[Authorize(SmartConstruction.ProjectManagement)]` 不是字符串字面量而是未定义标识符/成员访问表达式 → 编译失败。

- 结论：致命（编译时失败）。应改为：
  - 使用已生成的 `Permissions` 常量（静态 const 字段）作为强约束来源；或
  - 若确需自定义策略，生成 `"..."` 字符串字面量而不是未加引号的表达式。

3) 默认 CRUD 权限重复与冲突

```134:157:src/SmartAbp.CodeGenerator/Core/Generation/Crud/ApplicationContractsGenerator.cs
// 后端会为每个实体生成 Default/Create/Update/Delete 常量
```

```960:1006:src/SmartAbp.Vue/packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue
// 前端向导在“功能配置”步自动批量勾选 CRUD（作为 customActions ）
// 将与后端默认生成常量重复，可能造成权限定义重复/冲突
```

- 影响：生成的权限常量与自定义动作重复（特别是 Create/Read/Update/Delete），在权限 Provider 中二次注册会导致运行时冲突或冗余。

- 结论：严重一致性缺陷。应避免在 customActions 中重复声明 CRUD 基本动作。

4) 向导与后端生成能力耦合不足（信息缺口）

- 现状：向导侧严格类型包含 `constraints/indexes/relationships/uiConfig/...` 的结构，但 `codeGeneratorApi` 未完整映射到 `ModuleMetadataDto` 下的对应字段，后端生成器对这些高级信息的使用也不充分（Domain/EF 生成只处理属性和基础关系）。

- 影响：难以生成真正“企业级”的实体模型（索引/约束/外键/审计字段/多租户/软删/额外属性等），导致模型质量与规范不达标。

5) Dev 插件脚手架写入为占位实现（非生产级）

```57:204:src/SmartAbp.Vue/packages/lowcode-tools/src/dev/moduleWizardDev.ts
// 生成的 Store/视图使用 P0 占位数据，不接入 OpenAPI/真实服务
// 并在 Dev Server 内触发 npm run codegen 子进程（副作用大）
```

- 影响：向导一键生成的前端代码并非可直接对接后端的“企业级可用代码”，需要大量人工重写，违背目标。

---

## 二、关键性能缺陷

1) 大对象深度监听 + 频繁本地存储序列化

```626:636:src/SmartAbp.Vue/packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue
watch(() => stateManager.getCurrentState(), (newState) => {
  hasUnsavedChanges.value = true
  scheduleAutoSave() // 30s 定时 JSON 序列化到 localStorage
}, { deep: true })
```

- 问题：
  - `getCurrentState()` 返回快照对象，深度监听 + 频繁序列化在实体/属性较多时将阻塞主线程。
  - 未使用 `throttle/debounce` 与结构化克隆/Worker，易造成卡顿。

2) Dev 插件在开发服务器内同步触发 `npm run codegen`

```24:33:src/SmartAbp.Vue/packages/lowcode-tools/src/dev/moduleWizardDev.ts
const p = spawn(cmd, ['run', 'codegen'], { stdio: 'inherit' })
```

- 问题：开发态频繁生成会阻塞/污染开发服务器输出，且不可控；并发情况下有竞争风险。

3) 后端迁移编排采用固定延时与外部进程调用

```63:90:src/SmartAbp.CodeGenerator/Services/CodeGenerationAppService.cs
await Task.Delay(500) // 依赖固定延时而非事件/回执
...
dotnet ef migrations add ...; dotnet ef database update ... // 进程级调用
```

- 问题：
  - 固定延时脆弱，增量生成/磁盘 IO 抖动时容易失效。
  - 生产环境不应由 Web 进程直接拉起 `dotnet ef`，权限与稳定性风险高。

---

## 三、用户体验缺陷

- 多步骤信息架构合理，但关键“自动化”环节缺失：
  - 缺少基于 OpenAPI/数据库的自动实体推断与映射校验（仅有 dev 辅助接口）。
  - 缺少“生成前一致性校验”与“生成后回执（routes/menu/policies/files）”的完整呈现与一键回滚入口。
  - “一键 CRUD 权限”默认勾选会产生与后端重复问题，破坏用户心智。

---

## 四、最佳实践偏差（与 ADR 的不一致）

- ADR-0005 要求模板驱动 + 质量门（lint/type/test/build）与日志适配器；当前向导链路未体现“生成结果质量门检查”和“结构化回执”。
- ADR-0015 要求 Schema 唯一来源与回执、沙箱预览；当前向导生成路径未产出标准回执文件（appshell/* 与 diff 清单）。
- ADR-0016 宣告现阶段源码直集成；dev 插件仍保留 Monorepo/脚手架式副作用路径，应隔离在开发工具且默认关闭。

---

## 五、落地修复方案（按阻断度与收益排序）

优先级 P0（阻断）

- 修复权限注入：
  - 规则：当未显式选择“自定义策略常量路径”时，一律使用生成的 `Permissions` 常量；若用户输入自由字符串，强制作为字符串字面量生成（加引号）。
  - 影响文件：前端 `ModuleWizardView.vue`、后端 `ApplicationGenerator.cs` 的 `CreateAttribute` 参数构造。

- 建立 Strict → DTO 的显式映射器：
  - 新增 `mapStrictToModuleDto(metadata: StrictModuleMetadata): ModuleMetadataDtoPayload`，包含：
    - `PropertyType → C# 类型` 映射（string/number/decimal/guid/datetime 等）
    - 字段名规范化（如 `isPrimaryKey → IsKey`、`maxLength → MaxLength`）
    - 关系/索引/约束/UiConfig 的完整投射
  - 改造 `codeGeneratorApi.generateModule`，使用上述映射结果作为请求体。

- 去重 CRUD 权限：
  - 在向导侧禁止将基础 CRUD 动作写入 `customActions`，仅保留非标准动作（如 Approve/Reject/Export）。

优先级 P1（高）

- 生成前一致性校验与干跑（Dry-Run）：
  - 在后端增加 `ValidateModuleAsync` 与 `DryRunGenerateAsync`，返回编译/迁移可行性检查与文件清单，不落地写盘。
  - 前端在 PREVIEW 步执行校验并可视化差异/影响面。

- 迁移编排安全化：
  - 禁止生产环境内触发 `dotnet ef`；提供可选的“导出迁移脚本”或“CI 任务触发”模式。
  - 用“队列 + 进度回执”替代 `Task.Delay`。

优先级 P2（中）

- 性能优化：
  - 将自动保存改为 `debounce(5s)` + `structuredClone` + `IdleCallback`/Worker；仅保存 diff。
  - 大对象监听改为基于状态片段的订阅（例如拆分 `entities`/`permissions`/`db` 子树）。

- Dev 插件瘦身：
  - 默认关闭一切副作用写盘；脚手架仅在“显式开发模式”启用；不在 Vite 中直接 spawn npm 进程。

---

## 六、验证清单（质量门）

- 编译：后端 `.cs` 文件全部零警告编译通过；前端 `npm run type-check` 零错误。
- 规范：`npm run lint --fix` 零错误；无任何 `console.*` 与 `any` 滥用。
- 测试：向导映射器与权限注入新增单测，覆盖率 ≥ 80%。
- 构建：`npm run build` 通过；生成回执（routes/menu/policies/files）与快照产出到 `src/SmartAbp.Vue/src/appshell/*`。

---

## 七、样例证据（关键代码引用）

```42:91:src/SmartAbp.CodeGenerator/Core/Generation/Crud/ApplicationGenerator.cs
// Authorize 注入使用表达式而非字符串
appServiceClass = appServiceClass
  .AddAttributeLists(CreateAttribute("Authorize", readPolicy));
```

```41:94:src/SmartAbp.Vue/packages/lowcode-designer/src/api/code-generator.ts
// Strict → DTO 未做映射转换
entities: metadata.entities.map(entity => ({ ...entity, properties: entity.properties.map(prop => ({ ...prop })) }))
```

```960:1006:src/SmartAbp.Vue/packages/lowcode-designer/src/views/codegen/ModuleWizardView.vue
// 自动勾选 CRUD 自定义权限，易与后端默认常量重复
await toggleAllCrud(true)
```

---

## 八、结论

- 目前“多步骤模块向导”在“数据到后端 DTO 的转换”“权限注入”“脚手架质量与一致性”上存在阻断级缺陷，直接影响“可编译、可运行、可维护”的企业级代码产出。
- 按上述 P0 修复完成后，配合 P1/P2 优化与质量门，可达成“真真实实自动生成企业级可用代码”的目标。


