# SmartAbp 编码规范

> **📋 配合《项目开发铁律》的具体技术规范**

## 🎯 编码原则

### 1. **代码复用原则**
- **严禁重复代码** - 发现相似功能必须重构为共享模块
- **优先使用现有实现** - 编写新功能前必须搜索现有代码
- **组件化思维** - 任何功能都要考虑复用性

### 2. **架构一致性**
- **遵循项目架构** - 严格按照 `doc/architecture/` 文档执行
- **目录结构规范** - 按模块组织代码
- **命名统一** - 使用统一的命名规范

## 📁 目录结构规范

### 前端目录结构
```
src/SmartAbp.Vue/src/
├── views/                  # 页面视图（按模块分组）
│   ├── user/              # 用户管理模块
│   ├── project/           # 项目管理模块
│   ├── log/               # 日志管理模块
│   ├── system/            # 系统管理模块
│   ├── auth/              # 认证相关页面
│   └── common/            # 通用页面
├── components/             # 组件（按功能分组）
│   ├── layout/            # 布局组件
│   ├── user/              # 用户相关组件
│   ├── log/               # 日志相关组件
│   ├── auth/              # 认证相关组件
│   ├── theme/             # 主题相关组件
│   └── common/            # 通用组件
├── stores/                # 状态管理
│   └── modules/           # 按模块分组的stores
├── styles/                # 样式文件
│   ├── design-system/     # 统一设计系统
│   ├── base/              # 基础样式
│   ├── components/        # 组件样式
│   └── layouts/           # 布局样式
├── composables/           # 组合式函数
├── utils/                 # 工具函数
└── router/                # 路由配置
```

### 后端目录结构
```
src/
├── SmartAbp.Domain/           # 域层
├── SmartAbp.Application/      # 应用层
├── SmartAbp.Application.Contracts/  # 应用合约层
├── SmartAbp.HttpApi/          # HTTP API层
├── SmartAbp.Web/              # Web层
└── SmartAbp.EntityFrameworkCore/    # 数据访问层
```

## 🎨 前端编码规范

### Vue组件规范
```vue
<template>
  <!-- 使用语义化标签 -->
  <div class="user-management">
    <header class="page-header">
      <h1>{{ pageTitle }}</h1>
    </header>
    <main class="page-content">
      <!-- 内容 -->
    </main>
  </div>
</template>

<script setup lang="ts">
// 1. 导入顺序：Vue -> 第三方 -> 项目内部
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { useUserStore } from '@/stores/modules/user'

// 2. 类型定义
interface UserInfo {
  id: string
  name: string
  email: string
}

// 3. 响应式变量
const userStore = useUserStore()
const pageTitle = ref('用户管理')

// 4. 计算属性
const formattedUsers = computed(() => {
  return userStore.users.map(user => ({
    ...user,
    displayName: `${user.name} (${user.email})`
  }))
})

// 5. 方法定义
const handleUserCreate = async (userData: UserInfo) => {
  try {
    await userStore.createUser(userData)
    ElMessage.success('用户创建成功')
  } catch (error) {
    ElMessage.error('用户创建失败')
  }
}

// 6. 生命周期
onMounted(() => {
  userStore.fetchUsers()
})
</script>

<style scoped>
/* 使用设计系统变量 */
.user-management {
  padding: var(--spacing-4);
  background: var(--theme-bg-component);
}

.page-header {
  margin-bottom: var(--spacing-6);
  padding-bottom: var(--spacing-4);
  border-bottom: 1px solid var(--theme-border-base);
}

.page-content {
  /* 内容样式 */
}
</style>
```

### TypeScript规范
```typescript
// 1. 接口定义
export interface ApiResponse<T> {
  success: boolean
  data: T
  message?: string
  code?: number
}

// 2. 类型守卫
export function isValidUser(user: any): user is UserInfo {
  return user && 
         typeof user.id === 'string' && 
         typeof user.name === 'string' && 
         typeof user.email === 'string'
}

// 3. 泛型使用
export async function apiRequest<T>(
  url: string, 
  options?: RequestOptions
): Promise<ApiResponse<T>> {
  // 实现
}

// 4. 枚举定义
export enum UserRole {
  Admin = 'admin',
  User = 'user',
  Guest = 'guest'
}
```

### Pinia Store规范
```typescript
// stores/modules/user.ts
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import type { UserInfo, CreateUserRequest } from '@/types/user'

export const useUserStore = defineStore('user', () => {
  // 状态
  const users = ref<UserInfo[]>([])
  const loading = ref(false)
  const error = ref<string | null>(null)

  // 计算属性
  const activeUsers = computed(() => 
    users.value.filter(user => user.status === 'active')
  )

  // 操作
  const fetchUsers = async () => {
    loading.value = true
    error.value = null
    try {
      const response = await userApi.getUsers()
      users.value = response.data
    } catch (err) {
      error.value = '获取用户列表失败'
      throw err
    } finally {
      loading.value = false
    }
  }

  const createUser = async (userData: CreateUserRequest) => {
    try {
      const response = await userApi.createUser(userData)
      users.value.push(response.data)
      return response.data
    } catch (err) {
      error.value = '创建用户失败'
      throw err
    }
  }

  return {
    // 状态
    users,
    loading,
    error,
    // 计算属性
    activeUsers,
    // 操作
    fetchUsers,
    createUser
  }
})
```

## 🎯 路由规范

### 扁平化路由结构
```typescript
// router/index.ts
const routes = [
  {
    path: '/',
    redirect: '/dashboard'
  },
  {
    path: '/dashboard',
    component: SmartAbpLayout,
    name: 'Dashboard',
    meta: {
      title: '工作台',
      icon: 'dashboard',
      requiresAuth: true
    }
  },
  {
    path: '/User',
    component: SmartAbpLayout,
    meta: {
      title: '用户管理',
      icon: 'user',
      requiresAuth: true,
      requiredRoles: ['admin']
    },
    children: [
      {
        path: '',
        name: 'UserList',
        component: () => import('@/views/user/UserListView.vue'),
        meta: { title: '用户列表' }
      },
      {
        path: 'detail/:id',
        name: 'UserDetail',
        component: () => import('@/views/user/UserDetailView.vue'),
        meta: { title: '用户详情' }
      }
    ]
  }
]
```

## 🎨 样式规范

### 设计系统使用
```css
/* ✅ 正确：使用设计系统变量 */
.button-primary {
  background: var(--theme-brand-primary);
  color: var(--theme-text-inverse);
  padding: var(--spacing-2) var(--spacing-4);
  border-radius: var(--radius-md);
  border: 1px solid var(--theme-brand-primary);
}

/* ❌ 错误：硬编码样式值 */
.button-primary {
  background: #0ea5e9;
  color: #ffffff;
  padding: 8px 16px;
  border-radius: 6px;
}
```

### CSS命名规范
```css
/* BEM命名规范 */
.user-card { }                    /* 块 */
.user-card__header { }            /* 元素 */
.user-card__title { }             /* 元素 */
.user-card--featured { }          /* 修饰符 */
.user-card__button--disabled { }  /* 元素的修饰符 */
```

## 🔧 C# 后端编码规范

### 控制器规范
```csharp
[ApiController]
[Route("api/[controller]")]
public class UserController : SmartAbpController
{
    private readonly IUserAppService _userAppService;

    public UserController(IUserAppService userAppService)
    {
        _userAppService = userAppService;
    }

    [HttpGet]
    public async Task<PagedResultDto<UserDto>> GetListAsync(GetUsersInput input)
    {
        return await _userAppService.GetListAsync(input);
    }

    [HttpPost]
    public async Task<UserDto> CreateAsync(CreateUserDto input)
    {
        return await _userAppService.CreateAsync(input);
    }
}
```

### 应用服务规范
```csharp
public class UserAppService : SmartAbpAppService, IUserAppService
{
    private readonly IRepository<User, Guid> _userRepository;

    public UserAppService(IRepository<User, Guid> userRepository)
    {
        _userRepository = userRepository;
    }

    public async Task<PagedResultDto<UserDto>> GetListAsync(GetUsersInput input)
    {
        var query = await _userRepository.GetQueryableAsync();
        
        query = query.WhereIf(
            !input.Filter.IsNullOrWhiteSpace(),
            x => x.Name.Contains(input.Filter) || x.Email.Contains(input.Filter)
        );

        var totalCount = await AsyncExecuter.CountAsync(query);
        var users = await AsyncExecuter.ToListAsync(
            query.OrderBy(input.Sorting ?? "name")
                 .PageBy(input.SkipCount, input.MaxResultCount)
        );

        return new PagedResultDto<UserDto>(
            totalCount,
            ObjectMapper.Map<List<User>, List<UserDto>>(users)
        );
    }
}
```

## 📏 命名规范

### 文件命名
- **Vue组件**: PascalCase `UserManagementView.vue`
- **TypeScript文件**: camelCase `userService.ts`
- **样式文件**: kebab-case `user-management.css`
- **目录**: kebab-case `user-management/`

### 变量命名
- **变量**: camelCase `userName`, `userList`
- **常量**: UPPER_SNAKE_CASE `API_BASE_URL`, `MAX_RETRY_COUNT`
- **函数**: camelCase `getUserList`, `handleUserCreate`
- **类**: PascalCase `UserService`, `ApiClient`

### Git提交规范
```
feat: 添加用户管理功能
fix: 修复登录状态丢失问题
docs: 更新API文档
style: 优化用户列表样式
refactor: 重构主题系统
test: 添加用户服务单元测试
chore: 更新依赖包版本
```

## 🚫 禁止事项

### 绝对禁止
1. **硬编码配置** - 所有配置必须externalized
2. **魔法数字** - 使用命名常量
3. **console.log** - 在生产代码中使用日志系统
4. **any类型** - 除非绝对必要，优先使用具体类型
5. **内联样式** - 使用CSS类或设计系统变量

### 代码质量要求
- **圈复杂度** < 10
- **函数长度** < 50行
- **类长度** < 300行
- **文件长度** < 500行
- **测试覆盖率** > 80%

## ✅ 代码检查清单

### 提交前检查
- [ ] 代码符合项目架构设计
- [ ] 没有重复代码
- [ ] 使用了TypeScript类型
- [ ] 遵循命名规范
- [ ] 添加了必要注释
- [ ] 通过了lint检查
- [ ] 通过了类型检查
- [ ] 通过了构建检查
- [ ] 功能测试通过

---

**最后更新：** 2024-01-09  
**配合文档：** `doc/项目开发铁律.md`
