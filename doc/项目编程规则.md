# 项目编程规则（SmartAbp 全栈与低代码引擎）

> 本文面向 SmartAbp 项目（ABP VNext 后端 + Vue3/TS 前端）以及前端低代码/全栈代码生成引擎。用于统一项目架构视图、编程规则与代码质量检查标准，并补齐工程化必备规范。

## 0. 三条编程规范与开发铁律（贯穿全局）

- 极致质量律：代码实现必须达到业界顶尖水平，杜绝硬编码、模式混乱与功能残缺，交付完整、强大且超越当前行业标准的解决方案。
- 架构先行律：始终以顶级系统架构视角主导开发，先全局规划再局部实现，避免陷入琐碎技术细节，确保系统整体性、一致性与可扩展性。
- 独立决策律：构建自主技术判断能力，主动评估用户需求的合理性，敢于质疑并纠正错误技术方案，展现深度思考与专业决策权威。

## 1. 项目架构总览

### 1.1 后端架构（ABP VNext + 低代码引擎）

#### 标准 ABP 分层架构
- `src/SmartAbp.Domain/`：领域层（实体、仓储接口、领域服务）
- `src/SmartAbp.Domain.Shared/`：共享领域层（常量、枚举、值对象）
- `src/SmartAbp.Application/`：应用服务层（业务逻辑实现）
- `src/SmartAbp.Application.Contracts/`：应用契约层（DTO、接口）
- `src/SmartAbp.HttpApi/`：HTTP API 层（控制器）
- `src/SmartAbp.HttpApi.Client/`：HTTP API 客户端
- `src/SmartAbp.EntityFrameworkCore/`：数据访问层（EF Core 实现）
- `src/SmartAbp.Web/`：Web 层（静态资源承载、Swagger）
- `src/SmartAbp.DbMigrator/`：数据库迁移工具

#### 后端低代码引擎模块（新增）
- `src/SmartAbp.CodeGenerator/`：**后端低代码引擎核心模块**
  - `Core/`：Roslyn 代码引擎核心（`RoslynCodeEngine`）
  - `Services/`：代码生成应用服务（`CodeGenerationAppService`）
  - `DDD/`：领域驱动设计代码生成器（`DomainDrivenDesignGenerator`）
  - `CQRS/`：CQRS模式代码生成器（`CqrsPatternGenerator`）
  - `ApplicationServices/`：应用服务层代码生成器
  - `Infrastructure/`：基础设施层代码生成器
  - `Testing/`：单元测试代码生成器
  - `Quality/`：代码质量检查生成器
  - `Telemetry/`：遥测与监控代码生成器
  - `Messaging/`：消息队列代码生成器
  - `Caching/`：分布式缓存代码生成器
  - `Aspire/`：.NET Aspire 微服务代码生成器
  - `Hubs/`：SignalR 进度推送中心（`CodeGenerationProgressHub`）

约束：遵循 ABP 分层与依赖方向；应用服务不直接依赖基础设施实现；控制器仅依赖合约与应用服务。

### 1.2 前端架构（Vue3/TS + Vite + 全栈低代码引擎）

#### 主应用结构
- `src/SmartAbp.Vue/src/`：**业务前端根目录**
  - `views/`：页面视图
    - `auth/`：认证相关页面（`Login.vue`、`LoginTest.vue`）
    - `common/`：通用页面（`Dashboard.vue`、`ProfileView.vue`、`SettingsView.vue`）
    - `system/`：系统管理（`UsersView.vue`、`RolesView.vue`、`PermissionsView.vue`）
    - `user/`：用户管理（`UserListView.vue`、`UserManagement.vue`、`UserRolesView.vue`）
    - `project/`：项目管理（`ProjectListView.vue`、`ProjectAnalysisView.vue`）
    - `log/`：日志系统（`LogDashboard.vue`、`LogManagement.vue`、`AdvancedLogViewer.vue`）
    - `test/`：测试页面（`ThemeDemo.vue`、`ThemeTestView.vue`、`TestView.vue`）
    - `CodeGenerator/`：代码生成器界面（`Dashboard.vue`）
    - `codegen/`：低代码引擎视图（详见 packages 部分）
    - `lowcode/`：低代码快速开始（`QuickStart.vue`）
  - `components/`：可复用组件
  - `stores/`：Pinia 状态管理
  - `router/`：Vue Router 路由配置
  - `api/`：API 服务层
  - `utils/`：工具函数
  - `composables/`：Vue 组合式函数
  - `styles/`：样式与设计系统
  - `types/`：TypeScript 类型定义
  - `config/`：配置文件
  - `appshell/`：由 CLI 生成的聚合产物（`lifecycle.generated.ts`）

#### 工具与生成系统
- `src/tools/`：基于 Manifest 的前端代码生成 CLI
  - `cli.ts`：命令行接口，执行路由/Store/生命周期生成
  - `add-module.ts`：模块添加工具
  - `schema.ts`：Schema 定义和验证
  - `writers.ts`：代码写入工具

### 1.3 全栈低代码引擎架构（源码集成模式）

> **架构修订**: 根据最新决策 ([ADR-0016](./architecture/adr/0016-lowcode-engine-monorepo-refactoring.md) 已被取代)，为了加速开发迭代，低代码引擎**暂时放弃 Monorepo 包管理方式**，其源代码直接在主应用 `src/SmartAbp.Vue/src` 中进行组织、编译和引用。

**【核心原则】**
- **源码集成**: 低代码引擎的所有模块作为主应用的一部分进行开发、编译和版本管理。
- **边界清晰**: 尽管是源码集成，但仍需在目录结构上保持逻辑边界清晰，避免与业务代码高度耦合。

**主要代码分布**:
低代码引擎的核心功能主要分布在 `src/SmartAbp.Vue/src` 下的以下目录中：
- `views/codegen/`: 包含设计器（designer）核心视图和 Schema 处理逻辑。
- `views/lowcode/`: 包含低代码功能的快速开始和引导页面。
- `views/CodeGenerator/`: 承载与后端代码生成器交互的主界面。
- `components/...`: 低代码相关的可复用组件会分散在 `components` 目录中，并遵循项目组件规范。
- `tools/`: 前端代码生成相关的 CLI 工具，如模块清单处理、代码写入等。

**【目录约束】**
- 新增的低代码功能应优先归类到上述 `codegen` 或相关目录中。
- 严禁将引擎的核心逻辑与通用业务视图 (`views/common`, `views/system` 等) 混合。
- 引擎与主应用的交互应通过定义明确的 `services` 或 `composables` 函数进行，而不是直接导入内部组件状态。

### 1.4 模块化与清单（Manifest）
- 业务模块清单放置于 `src/SmartAbp.Vue/modules/<Module>/abp.module.json`
- Schema 参见 `src/SmartAbp.Vue/src/tools/schema.ts`（路由、Store、生命周期、策略、依赖、顺序等）
- CLI（`src/SmartAbp.Vue/src/tools/cli.ts`）负责：清单收集→拓扑排序→冲突检测→代码写入

### 1.5 低代码引擎（Monorepo Packages）

**【强制目录约束（重申）】**
所有低代码引擎的编程代码和组件都**必须保存在** `/SmartAbp.Vue/packages` 文件夹对应的子目录下，通过 `@smartabp/lowcode-*` 别名引用。

**包规范**：
- 每个包都有明确的职责边界和 API 定义
- 使用 TypeScript 严格模式，提供完整类型定义
- 支持独立构建、测试和发布
- 遵循语义化版本控制

## 2. 编程规则（统一约束）

### 2.1 低代码引擎（微内核 + 插件）
- 插件接口必须实现：
  - `metadata`：包含 `name`、`version`、`description`、`target`、`capabilities`、`(peer)dependencies`
  - `canHandle(schema)`：判定处理能力，且需保持幂等
  - `validate(schema)`：返回结构化校验结果（errors/warnings），禁止空实现
  - `generate(schema, config, context)`：必须输出 `GeneratedCode`，并携带 `metadata`、`dependencies`
  - 生命周期：`onInit`/`onDestroy`/`onError` 可选，用于编译器/缓存清理
- 命名规范：生成器类名以 `*Plugin` 结尾；生成目标以 `-generator` 结尾（如 `vue3-generator`）
- 安全：禁止在生产环境使用 `new Function`/动态执行；若确需预览，必须启用受控 sandbox（iframe/Worker + 严格 CSP）
- 性能：必须使用内核 `PerformanceMonitor` 埋点；代码生成/编译需设置超时；支持缓存（命中率指标>50%）
- 并发：批量生成默认并发不超过 5，可通过配置项调优；失败不应中断整体流程
- 日志：统一用适配器 `createLowCodeLogger`；禁止 `console.log` 污染

### 2.2 P2 可视化设计器
- Designer 作为独立模块：支持"生成前定制"和"生成后定制"两条路径
- Schema 唯一来源：任何定制通过 Schema/overrides；禁止直接改写 *.generated.ts
- 预览必须沙箱化（iframe/Worker + 严格 CSP）；生产禁用动态执行
- 生成链对齐：导出增量Schema→调用 writers→appshell 注入；菜单/路由即时生效
- 必须产出回执（routes/menu/policies/files）与 snapshot，用于审查与回滚
- 性能目标：预览渲染 ≤ 100ms；帧率 60fps；协作延迟 < 50ms；并发协作者 ≤ 50
- 质量门：lint/type/test/build 全绿；CI 漂移检测 + Danger 回执校验

### 2.3 前端路由/Store/生命周期聚合（CLI）
- 路由：从清单生成 `routes.generated.ts`，仅支持懒加载组件导入；路由守卫通过运行时注入（`__lowcodeRuntime`）
- Store：聚合注册由 `stores.generated.ts` 暴露工厂函数返回；可选持久化（localStorage→sessionStorage→内存 三级退化）
- 生命周期：`preInit/init/postInit/beforeMount/mounted` 五种 Hook 的聚合函数必须 try-catch 并记录错误
- 策略：策略映射统一导出为对象字典，前端鉴权依赖名称一致性

### 2.4 后端代码生成引擎规则
- **RoslynCodeEngine**：基于 Roslyn 编译器的核心引擎，支持实体、应用服务、CRUD 等代码生成
- **生成器模式**：每个生成器都实现统一接口，支持异步生成和进度报告
- **SignalR 实时推送**：通过 `CodeGenerationProgressHub` 向前端实时推送代码生成进度
- **模板驱动**：代码生成基于可配置的模板系统，支持不同架构模式（DDD、CQRS、传统分层）
- **质量保证**：生成的代码必须通过编译检查、代码分析和单元测试模板生成

### 2.5 通用编程规则
- **禁止重复实现**: 新增功能前必须用"Serena"查找现有实现并复用/扩展
- **禁止逃避手段**: 禁用 `as any`、禁用 lint/类型检查、注释错误代码等逃避手段
- **严格类型优先**: 使用明确接口/类型守卫；避免隐式 `any`
- **Serena索引维护**: 重大功能变更后必须更新Serena知识库索引
- **模板优先**: 代码生成必须基于templates/目录的标准模板，禁止硬编码
- 设计系统优先：样式全部走 `styles/design-system` 变量与 Token；禁止硬编码颜色/间距
- 目录与命名规范见第9章；新增模块按业务域分层

### 2.5.1 AI 调试与修复SOP（标准作业程序）
> **此规则为AI助手必须遵守的调试修复流程，旨在提高首次修复成功率，杜绝无效尝试。**
> 1.  **诊断优先于行动**:
>     -   修复前，必须先对错误进行**定性**（编译/运行时/环境），并明确提出对**根源的假设**。
>     -   优先使用静态分析工具（如 `grep`, `type-check`, `build`）验证假设，而不是直接重启服务。
> 2.  **本地验证闭环**:
>     -   任何代码修改后，必须在本地完成**编译闭环**（后端 `dotnet build`，前端 `npm run type-check`），确保无编译错误后才能交付。
> 3.  **环境状态自检**:
>     -   执行终端命令前，必须**自检工作目录和后台进程**，主动规避路径错误和端口占用。
> 4.  **职责边界清晰**:
>     -   AI助手的职责**仅限于编译通过**。严禁启动开发服务。所有功能性验证由开发人员手动进行。


### 2.6 与后端契约
- 权限策略、路由命名、菜单/功能点应与 ABP 权限常量保持一致（前后端同名）
- API 约定采用 DTO/分页排序字段统一；前端 `services/` 层统一封装
- 低代码引擎与后端 `CodeGenerationAppService` 通过 RESTful API 和 SignalR 协作

## 3. 代码质量检查规则（执行性）

目标阈值：
- 覆盖率 ≥ 80%（单测+组件测试结合）
- 圈复杂度 < 10；函数长度 < 50 行；文件长度 < 500 行
- 严禁生产代码残留 `console.*`（日志系统替代）

命令约定：
- `npm run precommit-check`（强制）：`tsc --noEmit` → `eslint --fix` → `vitest run --coverage` → `vite build`
- `npm run lint`、`npm run type-check`、`npm run test:coverage`、`npm run build`
- `npm run codegen`、`npm run codegen:check`：CLI 代码生成与检查
- `npm run module:add`、`npm run module:add:codegen`：模块添加工具

ESLint 建议（规则落地由配置逐步收紧）：
- 复杂度类：`complexity`、`max-lines-per-function`、`max-depth`、`max-params`、`max-statements`
- 风格类：启用 `plugin:prettier/recommended`，开启 `prettier/prettier: error`
- Vue 规范：`plugin:vue/vue3-recommended` 基础上视情况关闭 `multi-word-component-names`

TypeScript 建议：逐步启用 `noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`、`noPropertyAccessFromIndexSignature`

CI 建议：
- 在 CI 中执行与 `precommit-check` 同等的 4 步校验；构建产物与测试覆盖率作为发布门禁

## 4. Serena 与开发流程（强制前置）

在任何编码前必须：
1) 阅读规则：本文件、`doc/项目开发铁律.md`、`doc/architecture/*`
2) 使用 Serena 工具：
   - `mcp_serena_find_symbol`：定位既有实现
   - `mcp_serena_search_for_pattern`：查找相似功能/模板
   - `mcp_serena_get_symbols_overview`：快速了解模块结构
3) 使用 `sequential-thinking` 制定计划（含风险/校验点/时间预估），经负责人确认后实施
4) 变更完成后执行质量四连（类型/规范/测试/构建）

## 5. 生成文件与版本管理

- 生成文件置于 `src/SmartAbp.Vue/src/appshell/**`，或与业务目录同层的 `*.generated.ts`
- 文件头必须包含：`// AUTO-GENERATED FILE – DO NOT EDIT.` 与时间戳
- 允许纳入 Git 追踪，但禁止手工编辑；如需调整请修改清单/模板/插件并重新生成

## 6. 安全基线

- 生产环境禁止动态执行/注入；预览/拖拽编辑仅限开发态沙箱
- 所有跨域/鉴权/多租户逻辑由运行时适配器注入，生成代码仅做可插拔调用
- 第三方依赖由插件 `metadata` 声明；缺失时必须在安装/运行前阻止

## 7. 性能与可观测

- 生成/编译/批量流程必须埋点（时延、成功率、缓存命中率、并发度）
- Worker 池大小默认 `2~4`，可根据 `navigator.hardwareConcurrency` 自适应；超时必须可配置
- 缓存 TTL 默认 1h，允许通过标签（schema.type、plugin.name）清理

## 8. 文档与示例

- 新增/修改插件需同步：
  - 示例到对应包的 `examples/` 目录
  - 测试到对应包的 `__tests__/` 目录
  - 文档到 `doc/` 或包内 `README.md`

## 9. 编码规范

### 9.1 前端规范（Vue 3 + TS）
- 导入顺序：Vue → 第三方 → 项目内部（按目录分层）
- 组件：优先 `<script setup lang="ts">`；组合式 API；避免未使用变量/参数
- 类型：为对外 API、Store 状态、事件 payload 提供显式类型；使用类型守卫
- Store：使用 Pinia 组合式写法；状态集中在 `stores/modules`；可选持久化（local→session→内存）
- 路由：懒加载组件；路由元信息包含 `title/requiresAuth/requiredRoles`；守卫逻辑通过运行时适配器注入
- 样式：严格使用设计系统 Token；禁止内联样式与硬编码颜色/间距；推荐 BEM 命名

### 9.2 TypeScript 规范
- `strict` 开启；避免隐式 `any`；优先接口与精确类型而非 `Record<string, any>`
- 推荐逐步开启：`noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`
- 工具函数提供泛型与类型守卫；对外暴露 API 明确返回类型

### 9.3 后端（C# / ABP）要点
- 控制器仅依赖应用服务与合约；查询使用 `WhereIf`、`PageBy` 等辅助扩展；返回 `PagedResultDto<T>`
- 权限常量与前端策略名称一致；DTO 分页/排序字段一致
- 代码生成服务必须实现异步模式和进度报告，使用 SignalR 推送状态

### 9.4 命名与结构
- 文件命名：组件 PascalCase（`UserListView.vue`），TS camelCase（`userService.ts`），样式 kebab-case
- 变量 camelCase、常量 UPPER_SNAKE_CASE、类/组件 PascalCase、函数 camelCase
- 目录按业务域组织；避免"杂项"目录承载核心逻辑
- 低代码引擎模块内部遵循统一命名约定，对外交互通过 services 或 composables API

### 9.5 Git 提交规范（Conventional Commits）
```
feat: 新增 ...
fix: 修复 ...
docs: 文档更新 ...
style: 仅样式调整（无逻辑）
refactor: 重构（无功能变动）
test: 测试用例
chore: 构建/依赖/脚手架
```

### 9.6 禁止事项与质量阈值
- 禁止硬编码配置、魔法数字、生产代码残留 `console.*`、`any` 滥用、内联样式
- 圈复杂度 < 10；函数 < 50 行；文件 < 500 行；覆盖率 ≥ 80%

### 9.7 提交前自检清单
- [ ] 架构一致（目录、依赖、边界）
- [ ] 无重复实现（已用 Serena 查重）
- [ ] 低代码引擎代码已放置在 `src/views/codegen` 等约定目录中
- [ ] 类型完整严谨
- [ ] 命名规范、样式使用设计系统
- [ ] 通过 lint / type-check / test / build
- [ ] 必要文档已更新

## 10. 模块集成与部署

### 10.1 前后端集成
- 前端通过 `@smartabp/lowcode-api` 包与后端 `CodeGenerationAppService` 交互
- 使用 SignalR 实现代码生成进度的实时推送
- OpenAPI 规范自动生成 API 客户端（`npm run gen:api`）

### 10.2 开发环境
- 前端开发服务器：`npm run dev`（端口 11369，已在 vite.config.ts 中固定）
- 后端 API：通过环境变量 `VITE_API_BASE_URL` 配置
- 热重载：支持 Vue 组件、TypeScript 文件的热更新

### 10.3 构建与部署
- 前端构建：`npm run build`（生成静态文件到 `dist/`）
- 类型检查：`npm run type-check`（Vue TSC 构建检查）
- 测试覆盖率：`npm run test:coverage`（Vitest + V8 覆盖率）

— 本规则与 `doc/项目开发铁律.md`、`doc/企业级编程最佳实践要点.MDC` 共同构成强制工程规范，提交前务必自检。 —
