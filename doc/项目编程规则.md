# 项目编程规则（SmartAbp 全栈与低代码引擎）

> 本文面向 SmartAbp 项目（ABP VNext 后端 + Vue3/TS 前端）以及前端低代码/全栈代码生成引擎（下称“低代码引擎”）。用于统一项目架构视图、编程规则与代码质量检查标准，并补齐工程化必备规范。

## 1. 项目架构总览

### 1.1 后端（ABP VNext）
- `src/SmartAbp.Domain/`：领域层
- `src/SmartAbp.Application/`：应用服务层
- `src/SmartAbp.Application.Contracts/`：应用契约层
- `src/SmartAbp.HttpApi/`：HTTP API 层
- `src/SmartAbp.Web/`：Web 层（UI/静态资源承载）
- `src/SmartAbp.EntityFrameworkCore/`：数据访问层

约束：遵循 ABP 分层与依赖方向；应用服务不直接依赖基础设施实现；控制器仅依赖合约与应用服务。

### 1.2 前端（Vue3/TS + Vite）
- `src/SmartAbp.Vue/src/`：业务前端根目录
  - `views/`、`components/`、`stores/`、`router/`、`styles/`、`utils/`、`composables/` 按模块与职能组织
  - `tools/`：基于 Manifest 的前端代码生成 CLI（路由/Store/生命周期/策略聚合等生成器）
  - `lowcode/`：低代码引擎（微内核 + 插件）
    - `kernel/`：微内核（事件总线、缓存、日志、性能、插件管理等）
    - `plugins/`：代码生成与变换插件（`vue3`、`sfc-compiler`、`router-generator`、`store-generator`）
    - `runtime/`：运行时（Worker 池、元数据流水线、沙箱执行）
    - `adapters/`：与项目日志/监控/缓存系统的适配
    - `federation/`：内容分发/缓存整合
    - `examples/`、`__tests__/`：示例与单测
  - `appshell/`：由 CLI 写入的聚合产物目录（如 `router/routes.generated.ts`、`stores/stores.generated.ts`、`security/policies.generated.ts`、`lifecycle.generated.ts`）

约束：
- 生成文件一律以 `*.generated.ts` 或标注 `// AUTO-GENERATED FILE – DO NOT EDIT.`；禁止手改。
- `lowcode` 与业务代码通过公开 API 解耦；不得跨越 `rootDir` 私自引用内部实现。

### 1.3 Monorepo架构（2025-01重构）
> 基于 [ADR-0016](./architecture/adr/0016-lowcode-engine-monorepo-refactoring.md) 决策，低代码引擎将重构为独立发包的Monorepo架构。

**目标架构**:
```
packages/
├── @smartabp/lowcode-core          # 🔧 引擎内核包
├── @smartabp/lowcode-designer      # 🎨 可视化设计器包
├── @smartabp/lowcode-codegen       # 🏗️ 代码生成引擎包
├── @smartabp/lowcode-ui-vue        # 🎭 Vue UI组件包
├── @smartabp/lowcode-tools         # 🛠️ 开发工具包
└── @smartabp/lowcode-api           # 🌐 API客户端包
```

**重构约束**:
- 包间依赖必须明确，禁止循环依赖
- peerDependencies正确配置，避免版本冲突
- 支持Tree-shaking，按需引入
- 统一版本号管理策略
- 渐进式迁移，保持功能稳定

### 1.4 模块化与清单（Manifest）
- 业务模块清单放置于 `src/SmartAbp.Vue/modules/<Module>/abp.module.json`
- Schema 参见 `src/SmartAbp.Vue/src/tools/schema.ts`（路由、Store、生命周期、策略、依赖、顺序等）
- CLI（`src/SmartAbp.Vue/src/tools/cli.ts`）负责：清单收集→拓扑排序→冲突检测→代码写入

## 2. 编程规则（统一约束）

### 2.1 Monorepo重构规则（新增）
基于 [ADR-0016](./architecture/adr/0016-lowcode-engine-monorepo-refactoring.md) 的重构约束：

#### 包开发规则
- **单一职责**: 每个包都有明确的职责边界，避免功能重叠
- **依赖倒置**: 高层包通过抽象接口依赖底层包，不直接耦合实现
- **接口隔离**: 每个包只暴露必要的API，隐藏内部实现细节
- **开闭原则**: 通过插件系统支持扩展，核心包保持稳定

#### 构建和发布规则
- **统一构建**: 使用turbo进行并行构建和缓存优化
- **版本管理**: 所有包采用统一版本号策略，避免依赖混乱
- **Tree-shaking**: 确保包支持按需引入，减小bundle大小
- **类型安全**: 所有包必须提供完整的TypeScript类型定义

#### 迁移规则
- **渐进式迁移**: 采用"剪刀模式"，一次迁移一个模块，保持主应用稳定
- **API优先**: 先定义新包的API接口，再迁移实现代码
- **测试覆盖**: 迁移过程中保持单元测试覆盖率≥80%
- **回滚准备**: 每个迁移阶段都有明确的回滚计划

### 2.2 P2 可视化设计器（现有规则）
- Designer 作为独立模块：支持"生成前定制"和"生成后定制"两条路径
- Schema 唯一来源：任何定制通过 Schema/overrides；禁止直接改写 *.generated.ts
- 预览必须沙箱化（iframe/Worker + 严格 CSP）；生产禁用动态执行
- 生成链对齐：导出增量Schema→调用 writers→appshell 注入；菜单/路由即时生效
- 必须产出回执（routes/menu/policies/files）与 snapshot，用于审查与回滚
- 性能目标：预览渲染 ≤ 100ms；帧率 60fps；协作延迟 < 50ms；并发协作者 ≤ 50
- 质量门：lint/type/test/build 全绿；CI 漂移检测 + Danger 回执校验
- 参考 ADR-0015 与 `.cursor/rules/lowcode-engine-rules.mdc` P2 细化

### 2.3 通用编程规则
- **禁止重复实现**: 新增功能前必须用"Serena"查找现有实现并复用/扩展
- **禁止逃避手段**: 禁用 `as any`、禁用 lint/类型检查、注释错误代码等逃避手段
- **严格类型优先**: 使用明确接口/类型守卫；避免隐式 `any`
- **Serena索引维护**: 重大功能变更后必须更新Serena知识库索引
- **模板优先**: 代码生成必须基于templates/目录的标准模板，禁止硬编码
- 设计系统优先：样式全部走 `styles/design-system` 变量与 Token；禁止硬编码颜色/间距
- 目录与命名规范见第9章；新增模块按业务域分层

### 2.2 低代码引擎（微内核 + 插件）
- 插件接口必须实现：
  - `metadata`：包含 `name`、`version`、`description`、`target`、`capabilities`、`(peer)dependencies`
  - `canHandle(schema)`：判定处理能力，且需保持幂等
  - `validate(schema)`：返回结构化校验结果（errors/warnings），禁止空实现
  - `generate(schema, config, context)`：必须输出 `GeneratedCode`，并携带 `metadata`、`dependencies`
  - 生命周期：`onInit`/`onDestroy`/`onError` 可选，用于编译器/缓存清理
- 命名规范：生成器类名以 `*Plugin` 结尾；生成目标以 `-generator` 结尾（如 `vue3-generator`）
- 安全：禁止在生产环境使用 `new Function`/动态执行；若确需预览，必须启用受控 sandbox（iframe/Worker + 严格 CSP）
- 性能：必须使用内核 `PerformanceMonitor` 埋点；代码生成/编译需设置超时；支持缓存（命中率指标>50%）
- 并发：批量生成默认并发不超过 5，可通过配置项调优；失败不应中断整体流程
- 日志：统一用适配器 `createLowCodeLogger`；禁止 `console.log` 污染

### 2.3 前端路由/Store/生命周期聚合（CLI）
- 路由：从清单生成 `routes.generated.ts`，仅支持懒加载组件导入；路由守卫通过运行时注入（`__lowcodeRuntime`）
- Store：聚合注册由 `stores.generated.ts` 暴露工厂函数返回；可选持久化（localStorage→sessionStorage→内存 三级退化）
- 生命周期：`preInit/init/postInit/beforeMount/mounted` 五种 Hook 的聚合函数必须 try-catch 并记录错误
- 策略：策略映射统一导出为对象字典，前端鉴权依赖名称一致性

### 2.4 与后端契约
- 权限策略、路由命名、菜单/功能点应与 ABP 权限常量保持一致（前后端同名）
- API 约定采用 DTO/分页排序字段统一；前端 `services/` 层统一封装

## 3. 代码质量检查规则（执行性）

目标阈值：
- 覆盖率 ≥ 80%（单测+组件测试结合）
- 圈复杂度 < 10；函数长度 < 50 行；文件长度 < 500 行
- 严禁生产代码残留 `console.*`（日志系统替代）

命令约定：
- `npm run precommit-check`（强制）：`tsc --noEmit` → `eslint --fix` → `vitest run --coverage` → `vite build`
- `npm run lint`、`npm run type-check`、`npm run test:coverage`、`npm run build`

ESLint 建议（规则落地由配置逐步收紧）：
- 复杂度类：`complexity`、`max-lines-per-function`、`max-depth`、`max-params`、`max-statements`
- 风格类：启用 `plugin:prettier/recommended`，开启 `prettier/prettier: error`
- Vue 规范：`plugin:vue/vue3-recommended` 基础上视情况关闭 `multi-word-component-names`

TypeScript 建议：逐步启用 `noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`、`noPropertyAccessFromIndexSignature`

CI 建议：
- 在 CI 中执行与 `precommit-check` 同等的 4 步校验；构建产物与测试覆盖率作为发布门禁

## 4. Serena 与开发流程（强制前置）

在任何编码前必须：
1) 阅读规则：本文件、`doc/项目开发铁律.md`、`doc/architecture/*`
2) 使用 Serena 工具：
   - `mcp_serena_find_symbol`：定位既有实现
   - `mcp_serena_search_for_pattern`：查找相似功能/模板
   - `mcp_serena_get_symbols_overview`：快速了解模块结构
3) 使用 `sequential-thinking` 制定计划（含风险/校验点/时间预估），经负责人确认后实施
4) 变更完成后执行质量四连（类型/规范/测试/构建）

## 5. 生成文件与版本管理

- 生成文件置于 `src/SmartAbp.Vue/src/appshell/**`，或与业务目录同层的 `*.generated.ts`
- 文件头必须包含：`// AUTO-GENERATED FILE – DO NOT EDIT.` 与时间戳
- 允许纳入 Git 追踪，但禁止手工编辑；如需调整请修改清单/模板/插件并重新生成

## 6. 安全基线

- 生产环境禁止动态执行/注入；预览/拖拽编辑仅限开发态沙箱
- 所有跨域/鉴权/多租户逻辑由运行时适配器注入，生成代码仅做可插拔调用
- 第三方依赖由插件 `metadata` 声明；缺失时必须在安装/运行前阻止

## 7. 性能与可观测

- 生成/编译/批量流程必须埋点（时延、成功率、缓存命中率、并发度）
- Worker 池大小默认 `2~4`，可根据 `navigator.hardwareConcurrency` 自适应；超时必须可配置
- 缓存 TTL 默认 1h，允许通过标签（schema.type、plugin.name）清理

## 8. 文档与示例

- 新增/修改插件需同步：
  - 示例到 `src/SmartAbp.Vue/src/lowcode/examples/*`
  - 测试到 `src/SmartAbp.Vue/src/lowcode/__tests__/*`
  - 文档到 `src/SmartAbp.Vue/doc/` 或 `src/SmartAbp.Vue/docs/`

## 9. 编码规范（合并自原《编码规范.md》）

本章整合了前端/后端编码规范、命名约定、提交规范与提交前自检清单。

### 9.1 前端规范（Vue 3 + TS）
- 导入顺序：Vue → 第三方 → 项目内部。
- 组件：优先 `<script setup lang="ts">`；组合式 API；避免未使用变量/参数。
- 类型：为对外 API、Store 状态、事件 payload 提供显式类型；使用类型守卫。
- Store：使用 Pinia 组合式写法；状态集中在 `stores/modules`；可选持久化（local→session→内存）。
- 路由：懒加载组件；路由元信息包含 `title/requiresAuth/requiredRoles`；守卫逻辑通过运行时适配器注入。
- 样式：严格使用设计系统 Token；禁止内联样式与硬编码颜色/间距；推荐 BEM 命名。

### 9.2 TypeScript 规范
- `strict` 开启；避免隐式 `any`；优先接口与精确类型而非 `Record<string, any>`。
- 推荐逐步开启：`noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`。
- 工具函数提供泛型与类型守卫；对外暴露 API 明确返回类型。

### 9.3 后端（C# / ABP）要点
- 控制器仅依赖应用服务与合约；查询使用 `WhereIf`、`PageBy` 等辅助扩展；返回 `PagedResultDto<T>`。
- 权限常量与前端策略名称一致；DTO 分页/排序字段一致。

### 9.4 命名与结构
- 文件命名：组件 PascalCase（`UserListView.vue`），TS camelCase（`userService.ts`），样式 kebab-case。
- 变量 camelCase、常量 UPPER_SNAKE_CASE、类/组件 PascalCase、函数 camelCase。
- 目录按业务域组织；避免“杂项”目录承载核心逻辑。

### 9.5 Git 提交规范（Conventional Commits）
```
feat: 新增 ...
fix: 修复 ...
docs: 文档更新 ...
style: 仅样式调整（无逻辑）
refactor: 重构（无功能变动）
test: 测试用例
chore: 构建/依赖/脚手架
```

### 9.6 禁止事项与质量阈值
- 禁止硬编码配置、魔法数字、生产代码残留 `console.*`、`any` 滥用、内联样式。
- 圈复杂度 < 10；函数 < 50 行；文件 < 500 行；覆盖率 ≥ 80%。

### 9.7 提交前自检清单
- [ ] 架构一致（目录、依赖、边界）
- [ ] 无重复实现（已用 Serena 查重）
- [ ] 类型完整严谨
- [ ] 命名规范、样式使用设计系统
- [ ] 通过 lint / type-check / test / build
- [ ] 必要文档已更新

— 本规则与 `doc/项目开发铁律.md` 共同构成强制工程规范，提交前务必自检。 —



- 路由：懒加载组件；路由元信息包含 `title/requiresAuth/requiredRoles`；守卫逻辑通过运行时适配器注入。
- 样式：严格使用设计系统 Token；禁止内联样式与硬编码颜色/间距；推荐 BEM 命名。

### 9.2 TypeScript 规范
- `strict` 开启；避免隐式 `any`；优先接口与精确类型而非 `Record<string, any>`。
- 推荐逐步开启：`noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`。
- 工具函数提供泛型与类型守卫；对外暴露 API 明确返回类型。

### 9.3 后端（C# / ABP）要点
- 控制器仅依赖应用服务与合约；查询使用 `WhereIf`、`PageBy` 等辅助扩展；返回 `PagedResultDto<T>`。
- 权限常量与前端策略名称一致；DTO 分页/排序字段一致。

### 9.4 命名与结构
- 文件命名：组件 PascalCase（`UserListView.vue`），TS camelCase（`userService.ts`），样式 kebab-case。
- 变量 camelCase、常量 UPPER_SNAKE_CASE、类/组件 PascalCase、函数 camelCase。
- 目录按业务域组织；避免“杂项”目录承载核心逻辑。

### 9.5 Git 提交规范（Conventional Commits）
```
feat: 新增 ...
fix: 修复 ...
docs: 文档更新 ...
style: 仅样式调整（无逻辑）
refactor: 重构（无功能变动）
test: 测试用例
chore: 构建/依赖/脚手架
```

### 9.6 禁止事项与质量阈值
- 禁止硬编码配置、魔法数字、生产代码残留 `console.*`、`any` 滥用、内联样式。
- 圈复杂度 < 10；函数 < 50 行；文件 < 500 行；覆盖率 ≥ 80%。

### 9.7 提交前自检清单
- [ ] 架构一致（目录、依赖、边界）
- [ ] 无重复实现（已用 Serena 查重）
- [ ] 类型完整严谨
- [ ] 命名规范、样式使用设计系统
- [ ] 通过 lint / type-check / test / build
- [ ] 必要文档已更新

— 本规则与 `doc/项目开发铁律.md` 共同构成强制工程规范，提交前务必自检。 —



- 路由：懒加载组件；路由元信息包含 `title/requiresAuth/requiredRoles`；守卫逻辑通过运行时适配器注入。
- 样式：严格使用设计系统 Token；禁止内联样式与硬编码颜色/间距；推荐 BEM 命名。

### 9.2 TypeScript 规范
- `strict` 开启；避免隐式 `any`；优先接口与精确类型而非 `Record<string, any>`。
- 推荐逐步开启：`noUncheckedIndexedAccess`、`exactOptionalPropertyTypes`。
- 工具函数提供泛型与类型守卫；对外暴露 API 明确返回类型。

### 9.3 后端（C# / ABP）要点
- 控制器仅依赖应用服务与合约；查询使用 `WhereIf`、`PageBy` 等辅助扩展；返回 `PagedResultDto<T>`。
- 权限常量与前端策略名称一致；DTO 分页/排序字段一致。

### 9.4 命名与结构
- 文件命名：组件 PascalCase（`UserListView.vue`），TS camelCase（`userService.ts`），样式 kebab-case。
- 变量 camelCase、常量 UPPER_SNAKE_CASE、类/组件 PascalCase、函数 camelCase。
- 目录按业务域组织；避免“杂项”目录承载核心逻辑。

### 9.5 Git 提交规范（Conventional Commits）
```
feat: 新增 ...
fix: 修复 ...
docs: 文档更新 ...
style: 仅样式调整（无逻辑）
refactor: 重构（无功能变动）
test: 测试用例
chore: 构建/依赖/脚手架
```

### 9.6 禁止事项与质量阈值
- 禁止硬编码配置、魔法数字、生产代码残留 `console.*`、`any` 滥用、内联样式。
- 圈复杂度 < 10；函数 < 50 行；文件 < 500 行；覆盖率 ≥ 80%。

### 9.7 提交前自检清单
- [ ] 架构一致（目录、依赖、边界）
- [ ] 无重复实现（已用 Serena 查重）
- [ ] 类型完整严谨
- [ ] 命名规范、样式使用设计系统
- [ ] 通过 lint / type-check / test / build
- [ ] 必要文档已更新

— 本规则与 `doc/项目开发铁律.md` 共同构成强制工程规范，提交前务必自检。 —


